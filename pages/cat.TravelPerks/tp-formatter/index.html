<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Deals Parser Tool with Fuzzy Matching</title>
  <style>
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --light-color: #ecf0f1;
      --dark-color: #34495e;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --border-radius: 8px;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
      color: var(--dark-color);
      background-color: #f5f7fa;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
    }
    
    header {
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--light-color);
    }
    
    h1 {
      color: var(--primary-color);
      margin-top: 0;
      font-size: 2.2rem;
    }
    
    textarea {
      width: 100%;
      max-width: 100%;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: var(--border-radius);
      min-height: 200px;
      transition: border 0.3s;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }
    
    textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin: 15px 0;
    }
    
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      transition: all 0.3s;
      box-shadow: var(--shadow);
    }
    
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button.secondary {
      background-color: var(--light-color);
      color: var(--dark-color);
      border: 1px solid #ddd;
    }
    
    .vendor {
      background-color: #fff;
      border-radius: var(--border-radius);
      padding: 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    
    .deal {
      background-color: #f8fbff;
      border: 1px solid #e6f0fa;
      border-radius: var(--border-radius);
      padding: 12px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 10px;
    }
    
    .deal.removed {
      opacity: 0.4;
      filter: grayscale(0.9);
    }
    
    .deal .left {
      flex: 1;
      min-width: 0;
    }
    
    .deal .right {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .deal .deal-text {
      font-weight: 500;
    }
    
    .date-pill {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(0,0,0,0.08);
      background: #eef6ff;
      white-space: nowrap;
    }
    
    .expiry-pill {
      background-color: #ffecec;
      color: #b23a3a;
      border-color: #f7d6d6;
      font-weight: 600;
    }
    
    .start-pill {
      background-color: #e6ffef;
      color: #227a3b;
      border-color: #c6f6d5;
    }
    
    .exclusive {
      display: inline-block;
      margin-left: 6px;
      padding: 3px 6px;
      border-radius: 6px;
      background-color: #fff2cc;
      color: #8a6d3b;
      border: 1px solid #f1e2a1;
      font-size: 12px;
      font-weight: 600;
      vertical-align: middle;
    }
    
    .unknown-supplier h2 {
      color: #8a6d3b;
    }
    
    .controls {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
      margin: 6px 0 2px;
    }
    
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid #ddd;
      background: #f7f7f7;
      cursor: pointer;
      user-select: none;
    }
    
    .pill.active {
      background: #dff0ff;
      border-color: #bfe0ff;
      color: #0b5cab;
      font-weight: 600;
    }
    
    .controls-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    .controls-label {
      font-weight: bold;
      margin-right: 10px;
      color: var(--secondary-color);
    }
    
    .filter-pill {
      display: inline-block;
      border-radius: 20px;
      padding: 6px 12px;
      background-color: var(--light-color);
      color: var(--dark-color);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filter-pill:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .filter-pill.active {
      background-color: var(--primary-color);
      color: white;
    }
    
    .filters-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }
    
    #controls, #supplier-controls, #exclusive-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      button {
        padding: 8px 15px;
        font-size: 14px;
      }
      
      .vendor {
        padding: 12px;
      }
      
      .filters-container {
        gap: 10px;
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .vendor {
      animation: fadeIn 0.3s ease-out;
    }
    
    .tooltip {
      position: relative;
      display: inline-block;
    }
    
    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: var(--dark-color);
      color: white;
      text-align: center;
      border-radius: 6px;
      padding: 10px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 14px;
      box-shadow: var(--shadow);
    }
    
    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Enhanced Deals Parser Tool with Fuzzy Matching</h1>
      <p>Paste your deals text in the box below and click "Parse Deals". Format: v[Vendor], d[Deal], ed[Exclusive Deal].</p>
    </header>
    
    <textarea id="inputText" rows="20" placeholder="Paste your deals text here."></textarea>
    
    <div class="button-group">
      <button onclick="parseDeals()">Parse Deals</button>
      <button onclick="copyFormattedList()" class="secondary">Copy List</button>
      <button onclick="resetRemovedDeals()" class="secondary">Show All</button>
      <div class="tooltip">
        <button class="secondary">Help</button>
        <span class="tooltip-text">
          Format your deals as:<br>
          vVendor Name<br>
          dDeal description: MM/DD/YYYY<br>
          edExclusive deal: MM/DD/YYYY
        </span>
      </div>
    </div>

    <div class="filters-container">
      <!-- Controls for filtering by expiry dates -->
      <div id="controls"><span class="controls-label">Filter by expiry:</span></div>
      
      <!-- Controls for filtering by supplier -->
      <div id="supplier-controls"><span class="controls-label">Filter by supplier:</span></div>
      
      <!-- Controls for filtering by exclusive status -->
      <div id="exclusive-controls">
        <span class="controls-label">Show deals:</span>
        <span class="filter-pill active" onclick="filterByExclusive('All')">All Deals</span>
        <span class="filter-pill" onclick="filterByExclusive('Exclusive')">Exclusive Only</span>
        <span class="filter-pill" onclick="filterByExclusive('Regular')">Regular Only</span>
      </div>
    </div>

    <!-- Formatted result -->
    <div id="result"></div>
  </div>
  
  <script>
  // The complete list of known suppliers (from your provided list)
const knownSuppliers = [
  "Abercrombie & Kent",
  "Adventures by Disney",
  "African Travel",
  "Ama Waterways",
  "American Airline Vacations",
  "American Cruise Line",
  "Aulani, A Disney Resort & Spa",
  "Avalon Waterways",
  "Azamara",
  "Beaches",
  "BlueSky Tours",
  "Breathless",
  "Carnival",
  "Celebrity Cruises",
  "CIE Tours",
  "Club Med",
  "Collette",
  "CroisiEurope",
  "Crystal Cruises",
  "Cunard",
  "Delta Vacations",
  "Disney Cruise Line",
  "Disneyland",
  "DisneyWorld",
  "Dreams",
  "El Dorado Spa Resorts & Hotels",
  "Emerald Cruises",
  "Excellence Resorts",
  "Explora Journeys",
  "Four Seasons Yachts",
  "Funjet",
  "G Adventures",
  "Globus Journeys",
  "Great Safaris",
  "Hard Rock Hotels",
  "Holland America Line",
  "Hurtigruten",
  "Iberostar Hotels & Resorts",
  "Karisma Hotels & Resorts",
  "Lindblad Expeditions & National Geographic",
  "Marriott International",
  "Melia Hotels & Resorts",
  "MSC Cruises",
  "Norwegian Cruise Line",
  "Oceania Cruises",
  "Palace Resorts",
  "Princess Cruises",
  "Regent Seven Seas Cruises",
  "Royal Caribbean",
  "Sandals",
  "Seabourn",
  "Silversea",
  "Sunscape Resorts & Spas",
  "The Fives Hotels & Residences",
  "United Vacations",
  "Viking Cruises",
  "Virgin Voyages",
  "WestJet Vacations",
  "Windstar Cruises",
  "Wyndham Hotels & Resorts"
];

// Utility to slugify supplier names for ids/classes
function slugify(name) {
  return name.toLowerCase()
    .replace(/&/g, 'and')
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

// Fuzzy matching between input vendor and known suppliers
function normalize(str) {
  return String(str || '').toLowerCase().replace(/&/g, 'and').replace(/[^a-z0-9]+/g, '');
}

// Very simple fuzzy score: longer common subsequence-ish, plus startswith bonus
function fuzzyScore(a, b) {
  a = normalize(a); b = normalize(b);
  let score = 0;
  let bi = 0;
  for (let ai = 0; ai < a.length; ai++) {
    const ch = a[ai];
    const found = b.indexOf(ch, bi);
    if (found >= 0) {
      score += 1;
      bi = found + 1;
    }
  }
  if (b.startsWith(a.slice(0, 3))) score += 3;
  if (a.startsWith(b.slice(0, 3))) score += 3;
  return score;
}

function findSupplierMatch(inputName) {
  let best = null;
  let bestScore = -1;
  for (const s of knownSuppliers) {
    const score = fuzzyScore(inputName, s);
    if (score > bestScore) {
      bestScore = score;
      best = s;
    }
  }
  // Require a minimal score so totally unrelated strings don't match
  return bestScore >= 3 ? best : null;
}

// Format mm/dd/yyyy with zero-padding; if yy given, assume 20yy
function formatDate(mm, dd, yyyy) {
  mm = String(mm).padStart(2, '0');
  dd = String(dd).padStart(2, '0');
  if (String(yyyy).length === 2) yyyy = '20' + yyyy;
  return `${mm}/${dd}/${yyyy}`;
}

// Bold $ amounts and percentages
function boldAmounts(text) {
  return text.replace(/(\$\d+(?:\.\d+)?)/g, '<strong>$1</strong>')
             .replace(/(\d+%)/g, '<strong>$1</strong>');
}

// Parse and standardize the expiry portion.
// Returns an object with:
//  - html: formatted date pills (as HTML)
//  - expiry: the standardized expiry date (red pill) as a string (for filtering)
function parseExpiry(expiryText) {
  let lower = expiryText.toLowerCase();
  if (lower.includes("today")) {
     let today = new Date();
     let formatted = formatDate(today.getMonth()+1, today.getDate(), today.getFullYear());
     return {
        html: `<span class="date-pill expiry-pill">${formatted}</span>`,
        expiry: formatted
     };
  }
  
  let datePattern = /(\d{1,2}\/\d{1,2}(?:\/\d{4})?)/g;
  let matches = expiryText.match(datePattern);
  if (matches) {
     if (matches.length === 1) {
       let parts = matches[0].split('/');
       if (parts.length === 3) {
          let formatted = formatDate(parts[0], parts[1], parts[2]);
          return {
            html: `<span class="date-pill expiry-pill">${formatted}</span>`,
            expiry: formatted
          };
       }
     } else if (matches.length >= 2) {
       // Assume first is start date and last is expiry.
       let start = matches[0];
       let end = matches[matches.length - 1];
       let startParts = start.split('/');
       let endParts = end.split('/');
       // If the start date lacks a year, use the year from the end date.
       if (startParts.length === 2 && endParts.length === 3) {
         startParts.push(endParts[2]);
       }
       let formattedStart = formatDate(startParts[0], startParts[1], startParts[2]);
       let formattedEnd = formatDate(endParts[0], endParts[1], endParts[2]);
       return {
         html: `<span class="date-pill start-pill">${formattedStart}</span> <span class="date-pill expiry-pill">${formattedEnd}</span>`,
         expiry: formattedEnd
       };
     }
  }
  // If no date is detected, return the raw text.
  return { html: expiryText, expiry: "" };
}

// Global array to store parsed deals for filtering later.
let allDeals = [];

// Parse textarea into formatted HTML with vendor sections and deal rows
function parseDeals() {
  const input = document.getElementById("inputText").value;
  const lines = input.split('\n');
  let resultHTML = "";
  allDeals = [];  // reset global deals
  
  let currentVendor = "";
  let vendorKnown = true;
  
  lines.forEach(line => {
    line = line.trim();
    if (!line) return; // skip empty lines
    
    // Vendor line (starts with "v")
    if (line.startsWith("v")) {
      // Close previous vendor container if open.
      if (currentVendor) {
        resultHTML += "</div>";
      }
      // Remove the "v" prefix and any trailing colon.
      let vendorName = line.slice(1).trim();
      if (vendorName.endsWith(":")) {
        vendorName = vendorName.slice(0, -1).trim();
      }
      // Fuzzy-match the vendor name.
      let matchedSupplier = findSupplierMatch(vendorName);
      // Use matched supplier if found; otherwise, flag as unknown.
      if (matchedSupplier) {
        currentVendor = matchedSupplier;
        vendorKnown = true;
      } else {
        currentVendor = vendorName;
        vendorKnown = false;
      }
      
      resultHTML += `<div class="vendor ${vendorKnown ? "" : "unknown-supplier"}"><h2>${currentVendor}</h2>`;
    } 
    // Deal lines (start with "d" or "ed")
    else if (line.startsWith("d") || line.startsWith("ed")) {
      let isExclusive = false;
      if (line.startsWith("ed")) {
        isExclusive = true;
        line = line.slice(2).trim(); // Remove "ed"
      } else {
        line = line.slice(1).trim(); // Remove "d"
      }
      
      // Split the line at the LAST colon to separate deal text from expiry info.
      const colonIndex = line.lastIndexOf(":"); // <--- THE FIX IS HERE
      let dealText = "";
      let expiryPortion = "";

      if (colonIndex !== -1) {
        dealText = line.substring(0, colonIndex).trim();
        expiryPortion = line.substring(colonIndex + 1).trim();
      } else {
        // No colon found, assume the whole line is the deal text and there's no expiry.
        dealText = line;
        expiryPortion = ""; // Ensure it's an empty string if no colon
      }
      
      // Bold monetary amounts and percentages.
      dealText = boldAmounts(dealText);
      
      // Parse the expiry date portion.
      const parsedExpiry = parseExpiry(expiryPortion);
      
      // Build the formatted deal entry with a data attribute for expiry (for filtering).
      const dealHtml = `
        <div class="deal" data-expiry="${parsedExpiry.expiry}" data-exclusive="${isExclusive ? 'Exclusive' : 'Regular'}" data-vendor="${slugify(currentVendor)}">
          <div class="left">
            <div class="deal-text">${dealText}${isExclusive ? ' <span class="exclusive">Exclusive</span>' : ''}</div>
            <div class="expiry">${parsedExpiry.html}</div>
          </div>
          <div class="right">
            <button class="pill" onclick="removeDeal(this)">Remove</button>
          </div>
        </div>
      `;
      
      resultHTML += dealHtml;
      
      // Store the deal for filtering + copying later
      allDeals.push({
        vendor: currentVendor,
        vendorSlug: slugify(currentVendor),
        exclusive: isExclusive ? 'Exclusive' : 'Regular',
        dealText: dealText,
        expiry: parsedExpiry.expiry
      });
    }
  });
  
  // Close last vendor container if needed
  if (currentVendor) {
    resultHTML += "</div>";
  }
  
  // Inject the result
  const resultEl = document.getElementById("result");
  resultEl.innerHTML = resultHTML;
  
  // Build/refresh filter controls
  buildControls();
  buildSupplierControls();
  
  // Scroll to the results
  resultEl.scrollIntoView({ behavior: "smooth" });
}

// Remove a deal row with soft delete (toggle)
function removeDeal(btn) {
  const deal = btn.closest('.deal');
  if (!deal) return;
  deal.classList.toggle('removed');
  btn.textContent = deal.classList.contains('removed') ? 'Restore' : 'Remove';
}

// Build expiry filter controls based on unique expiry values present
function buildControls() {
  const controls = document.getElementById('controls');
  controls.innerHTML = '<span class="controls-label">Filter by expiry:</span>';
  
  const pills = new Map();
  const deals = Array.from(document.querySelectorAll('.deal'));
  const unique = new Set();
  unique.add('All');

  for (const d of deals) {
    const exp = d.getAttribute('data-expiry') || '';
    if (exp) unique.add(exp);
  }

  for (const val of unique) {
    const span = document.createElement('span');
    span.className = 'pill' + (val === 'All' ? ' active' : '');
    span.textContent = val === 'All' ? 'All' : val;
    span.onclick = () => {
      // Toggle active
      controls.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      span.classList.add('active');
      // Filter
      filterByExpiry(val);
    };
    controls.appendChild(span);
    pills.set(val, span);
  }
}

// Build supplier filter controls based on vendors parsed
function buildSupplierControls() {
  const supplierControls = document.getElementById('supplier-controls');
  supplierControls.innerHTML = '<span class="controls-label">Filter by supplier:</span>';
  
  const uniqueVendors = new Set(['All']);
  for (const d of allDeals) {
    uniqueVendors.add(d.vendor);
  }
  for (const vendor of uniqueVendors) {
    const span = document.createElement('span');
    span.className = 'pill' + (vendor === 'All' ? ' active' : '');
    span.textContent = vendor;
    span.onclick = () => {
      supplierControls.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
      span.classList.add('active');
      filterBySupplier(vendor);
    };
    supplierControls.appendChild(span);
  }
}

// Filter by expiry pill value
function filterByExpiry(value) {
  const deals = document.querySelectorAll('.deal');
  deals.forEach(d => {
    const exp = d.getAttribute('data-expiry') || '';
    const show = (value === 'All') || (exp === value);
    d.style.display = show ? '' : 'none';
  });
}

// Filter by supplier
function filterBySupplier(vendor) {
  const deals = document.querySelectorAll('.deal');
  deals.forEach(d => {
    const slug = d.getAttribute('data-vendor') || '';
    const vendorName = allDeals.find(x => slugify(x.vendor) === slug)?.vendor || '';
    const show = (vendor === 'All') || (vendorName === vendor);
    d.style.display = show ? '' : 'none';
  });
}

// Filter by exclusive status
function filterByExclusive(mode) {
  const pills = document.querySelectorAll('#exclusive-controls .filter-pill');
  pills.forEach(p => p.classList.remove('active'));
  pills.forEach(p => {
    if (p.textContent.startsWith(mode) || (mode === 'All' && p.textContent === 'All Deals')) {
      p.classList.add('active');
    }
  });
  
  const deals = document.querySelectorAll('.deal');
  deals.forEach(d => {
    const status = d.getAttribute('data-exclusive');
    const show =
      mode === 'All' ||
      (mode === 'Exclusive' && status === 'Exclusive') ||
      (mode === 'Regular' && status === 'Regular');
    d.style.display = show ? '' : 'none';
  });
}

// Create a clipboard-friendly text format from the current (visible) deals
function formatDealsForClipboard() {
  let formattedText = '';
  const vendors = document.querySelectorAll('.vendor');
  
  vendors.forEach(vendor => {
    const vendorName = vendor.querySelector('h2')?.textContent || '';
    formattedText += `v\t${vendorName}\n`;
    
    const deals = vendor.querySelectorAll('.deal');
    deals.forEach(deal => {
      if (deal.style.display !== 'none') {
        if (!deal.classList.contains('removed')) {
          let dealText = '';
          
          // Check if deal is exclusive
          const isExclusive = deal.querySelector('.exclusive') !== null;
          dealText += isExclusive ? 'ed\t' : 'd\t';
          
          // Get the deal text
          const dealTextEl = deal.querySelector('.deal-text');
          dealText += dealTextEl.textContent;
          
          // Get the expiry text
          const expiryEl = deal.querySelector('.expiry');
          if (expiryEl) {
            dealText += ': ';
            // Get text from all date pills
            const datePills = expiryEl.querySelectorAll('.date-pill');
            if (datePills.length > 0) {
              const dates = Array.from(datePills).map(pill => pill.textContent);
              dealText += dates.join('-');
            } else {
              dealText += expiryEl.textContent;
            }
          }
          
          formattedText += `${dealText}\n`;
        }
      }
    });
  });
  
  return formattedText;
}

// Copy the formatted deals list to clipboard in the specified format
function copyFormattedList() {
  const formattedText = formatDealsForClipboard();
  
  navigator.clipboard.writeText(formattedText).then(() => {
    // Create toast notification
    const toast = document.createElement('div');
    toast.textContent = 'Copied to clipboard!';
    toast.style.position = 'fixed';
    toast.style.bottom = '20px';
    toast.style.left = '50%';
    toast.style.transform = 'translateX(-50%)';
    toast.style.padding = '10px 20px';
    toast.style.background = 'rgba(0, 0, 0, 0.7)';
    toast.style.color = 'white';
    toast.style.borderRadius = '4px';
    toast.style.zIndex = '1000';
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transition = 'opacity 0.5s';
      setTimeout(() => document.body.removeChild(toast), 500);
    }, 2000);
  }).catch(err => {
    alert("Copy failed: " + err);
  });
}

// Add event listener for when page loads
document.addEventListener('DOMContentLoaded', function() {
  // Add sample text to empty textarea
  if (!document.getElementById('inputText').value) {
    document.getElementById('inputText').placeholder = `Example format:
vRoyal Caribbean
dSave up to $150 on select cruises: 12/31/2023
edSpecial: Buy One Get One 50% off, plus kids sail free: 01/01/2023 - 12/31/2023
vCarnival
dFree room upgrades on select sailings: 11/30/2023
`;
  }
});
  </script>
</body>
</html>
