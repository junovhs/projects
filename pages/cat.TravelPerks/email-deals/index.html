<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Travel Deal Selection Tools</title>
  <style>
    :root{--primary:#1a73e8;--primary-light:#e8f0fe;--primary-dark:#1565c0;--secondary:#34A853;--secondary-dark:#218838;--surface:#fff;--background:#f8f9fa;--text:#202124;--text-secondary:#5f6368;--border:#dadce0;--border-light:#e0e0e0;--shadow-1:0 1px 3px rgba(60,64,67,.15),0 1px 2px rgba(60,64,67,.1);--radius-sm:4px;--radius-md:8px;--fast:.15s ease-out;--danger:#dc3545;--danger-dark:#c82333;--success-bg: #e6f4ea; --success-border: #34a853;}
    *{box-sizing:border-box;margin:0;padding:0}
    html{font-size:16px}
    body{font-family:Roboto, Noto Sans, Arial, sans-serif;background:var(--background);color:var(--text);line-height:1.6;padding:1.5rem}
    .container{max-width:1200px;margin:1rem auto}
    .page-title{font-size:2.2rem;font-weight:500;text-align:center;color:var(--primary);margin-bottom:2rem}

    .tool-section{background:var(--surface);padding:1.5rem;border-radius:var(--radius-md);box-shadow:var(--shadow-1);margin-bottom:2rem;border:1px solid var(--border-light)}
    .tool-section h2{font-size:1.5rem;font-weight:500;color:var(--primary-dark);margin-bottom:1.25rem;padding-bottom:.5rem;border-bottom:1px solid var(--border-light)}
    .control-group{margin-bottom:1.25rem}
    .control-group label{display:block;font-size:.95rem;font-weight:500;color:var(--text);margin-bottom:.5rem}
    .control-group select{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius-sm);font:inherit;font-size:.9rem;background:var(--surface)}
    .control-group select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px var(--primary-light)}

    .actions-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;background:var(--primary);color:#fff;border:none;padding:.6rem 1.2rem;border-radius:var(--radius-sm);font:inherit;font-size:.9rem;font-weight:500;cursor:pointer;transition:all var(--fast);text-decoration:none; position: relative;}
    .btn:hover{background:var(--primary-dark);box-shadow:var(--shadow-1)}
    .btn[aria-disabled="true"]{opacity:.6;cursor:not-allowed}
    .btn-secondary{background:var(--surface);color:var(--primary);border:1px solid var(--border)}
    .btn-secondary:hover{background:var(--primary-light);border-color:var(--primary)}
    .btn-sm{padding:.3rem .6rem;font-size:.8rem}
    .btn-compute{background:var(--secondary);width:100%;padding:.75em;font-size:1em}
    .btn-compute:hover{background:var(--secondary-dark)}

    .filter-bubbles{display:flex;flex-wrap:wrap;gap:.5rem}
    .filter-bubbles button{background:var(--surface);color:var(--primary);border:1px solid var(--border);padding:.4rem .8rem;border-radius:16px;font:inherit;font-size:.85rem;cursor:pointer;transition:all var(--fast);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
    .filter-bubbles button:hover{background:var(--primary-light);border-color:var(--primary);transform:translateY(-1px)}
    .filter-bubbles button.active{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:500}
    .filter-bubbles button[aria-disabled="true"]{background:#e9ecef;color:#6c757d;border-color:#ced4da;cursor:not-allowed;opacity:.7;transform:none}

    .options-controls button{background:var(--surface);color:var(--primary);border:1px solid var(--border);padding:.4rem .8rem;border-radius:16px;font:inherit;font-size:.85rem;cursor:pointer;transition:all var(--fast);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
    .options-controls button:hover{background:var(--primary-light);border-color:var(--primary);transform:translateY(-1px)}
    .options-controls button.active{background:var(--primary);color:#fff;border-color:var(--primary);font-weight:500}

    .output-area{margin-top:1.5em;padding:1em;background:#f9f9f9;border:1px solid var(--border-light);border-radius:var(--radius-sm);min-height:50px;font-size:.95rem}
    .output-area strong{color:var(--primary-dark)}

    #deal-list-container{margin-top:1rem;border:1px solid var(--border-light);border-radius:var(--radius-md);padding:.5rem 0}
    #deal-list{list-style:none;max-height:70vh;overflow-y:auto;padding:0 .5rem 0 1.5rem}
    .deal-item{border-bottom:1px solid var(--border-light);padding:1rem 0;display:grid;grid-template-columns:auto 1fr auto;gap:0 1rem;align-items:start}
    .deal-item:last-child{border-bottom:none}
    .deal-item .indicator{grid-column:1;grid-row:1/3;font-size:1.5rem;padding-top:.1em}
    .deal-item .indicator .exclusive-star{color:var(--secondary)}
    .deal-item .supplier{font-weight:500;font-size:1.1rem;color:var(--primary-dark);grid-column:2;margin-bottom:.25rem}
    .deal-item .title-line{grid-column:2;display:flex;align-items:baseline;flex-wrap:wrap;margin-bottom:.3rem}
    .deal-item .title{font-weight:500;margin-right:.75rem;font-size:1rem}
    .deal-item .expiry-pill{font-size:.8rem;font-weight:500;color:var(--text-secondary);background:#e8eaed;padding:.1rem .6rem;border-radius:10px;white-space:nowrap;border:1px solid var(--border-light)}
    .deal-item .description{grid-column:2;font-size:.9rem;color:var(--text-secondary);white-space:pre-wrap}
    .placeholder{padding:2rem;text-align:center;color:var(--text-secondary)}
    .deal-item .remove-deal-btn{grid-column:3;grid-row:1/span 3;align-self:center;justify-self:center;background:transparent;border:none;color:var(--danger);font-size:1.5rem;cursor:pointer;padding:.5rem;line-height:1;transition:color var(--fast)}
    .deal-item .remove-deal-btn:hover{color:var(--danger-dark);font-weight:bold}

    #rotator-filter-status-container{background:var(--primary-light);padding:.75rem 1.5rem;margin-bottom:1rem;border-radius:var(--radius-sm);border:1px solid var(--primary)}
    #rotator-filter-status-container p{margin:0;font-weight:500;color:var(--primary-dark);display:flex;justify-content:space-between;align-items:center}
    #rotator-filter-names{font-weight:normal;color:var(--text)}

    .control-section{margin-bottom:1.25rem}
    .control-section:last-child{margin-bottom:0}

    #filters-and-sorts-container h2, .control-section h2{font-size:1rem;font-weight:500;color:var(--text);margin-bottom:.75rem;padding-bottom:.35rem;border-bottom:1px solid var(--border-light)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="page-title">Travel Deal Selection Tools</h1>

    <!-- Section 1: Weekly Hot Deals Supplier Rotator -->
    <section id="rotator-section" class="tool-section">
      <h2>Weekly Hot Deals Supplier Rotator</h2>

      <div class="control-group">
        <label for="featured-brand-select">Select This Week’s Main Feature Brand:</label>
        <select id="featured-brand-select"></select>
      </div>

      <div class="control-group">
        <label>Select Last Week’s Below-the-Fold Brands (up to 4):</label>
        <div id="lastweek-brands-bubbles" class="filter-bubbles"></div>
      </div>

      <button id="compute-rotator-btn" class="btn btn-compute" aria-pressed="false">Compute This Week’s Below-the-Fold</button>

      <div id="rotator-output" class="output-area" role="status" aria-live="polite">
        <p style="color: var(--text-secondary);">Select brands above and click compute.</p>
      </div>
    </section>

    <hr style="margin:2.5rem 0;border:none;border-top:1px solid var(--border-light)" />

    <!-- Section 2: Enhanced JSON Deal Lister -->
    <section id="deal-lister-section" class="tool-section">
      <h2>Enhanced JSON Deal Lister</h2>

      <div class="actions-bar">
        <div>
            <label for="json-file-input" class="btn">Upload Deals JSON File</label>
            <input type="file" id="json-file-input" accept=".json,application/json" class="sr-only">
            <span id="file-name-display" style="margin-left: 1rem; color: var(--text-secondary);"></span>
        </div>
        <div>
            <button id="copy-rotator-deals-btn" class="btn btn-secondary">Copy Rotator Deals</button>
            <button id="copy-selected-deals-btn" class="btn btn-secondary">Copy Selected Deals</button>
            <button class="btn btn-secondary" id="clear-deal-lister-btn">Clear All</button>
        </div>
      </div>

      <div id="rotator-filter-status-container" style="display:none">
        <p>
          <span>Filtering by Rotator Suppliers: <strong id="rotator-filter-names"></strong></span>
          <button id="clear-rotator-filter-btn" class="btn btn-secondary btn-sm">Clear Rotator Filter</button>
        </p>
      </div>

      <div id="filters-and-sorts-container" style="display:none">
        <div class="control-section">
          <h2>Filter by Supplier:</h2>
          <div id="supplier-filters" class="filter-bubbles"></div>
        </div>
        <div class="control-section">
          <h2>Options:</h2>
          <div class="options-controls">
            <button id="exclusive-toggle-btn" aria-pressed="false">Show Only Exclusives</button>
          </div>
        </div>
        <div class="control-section">
          <h2>Sort by:</h2>
          <div class="sort-options filter-bubbles">
            <button id="sort-supplier" class="btn-secondary active">Supplier</button>
            <button id="sort-expiry" class="btn-secondary">Expiry Date</button>
            <button id="sort-exclusive" class="btn-secondary">Exclusives First</button>
          </div>
        </div>
      </div>

      <div id="deal-list-container">
        <ul id="deal-list">
          <li class="placeholder">Upload a JSON file to begin.</li>
        </ul>
      </div>
    </section>
  </div>

  <script>
    (function(){
      // ---------- Utilities ----------
      const $ = (sel, root=document) => root.querySelector(sel);
      const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

      function assert(condition, message) { if (!condition) { throw new Error(`Assertion Failed: ${message}`); } }

      if (!('crypto' in window) || !crypto.randomUUID){
        window.crypto = window.crypto || {};
        crypto.randomUUID = function(){ const tpl='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'; return tpl.replace(/[xy]/g,c=>{const r=(Math.random()*16)|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);});}
      }

      const escapeHtml = (s='') => {
        assert(typeof s === 'string', 'escapeHtml input must be a string.');
        return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
      }

      function normalizeSupplier(name){ return (name||'').toLowerCase().trim().replace(/[.,\/#!$%\^&*;:{}=\-_`~()']/g,'').replace(/\s+/g,' ').trim(); }
      const formatDisplayName = key => key ? key.split(' ').map(w => w? w[0].toUpperCase()+w.slice(1):'').join(' ') : 'Unknown';

      // ---------- Rotator Data ----------
      const potm = ['MSC Cruises','AmaWaterways'];
      const mostPriority = ['Norwegian Cruise Line','Royal Caribbean'];
      const midPriority = ['Celebrity Cruises','Disney Cruise Line','Virgin Voyages','Holland America Line','Princess Cruises'];
      const leastPriority = ['Carnival Cruise Line','MSC Cruises'];

      const rotatorBrandDisplayList = [
        { text:'Norwegian', value:'Norwegian Cruise Line' },{ text:'Royal Caribbean', value:'Royal Caribbean' },
        { text:'Celebrity', value:'Celebrity Cruises' },{ text:'Disney Cruise Line', value:'Disney Cruise Line' },
        { text:'Virgin Voyages', value:'Virgin Voyages' },{ text:'Holland America', value:'Holland America Line' },
        { text:'Princess', value:'Princess Cruises' },{ text:'Carnival', value:'Carnival Cruise Line' },
        { text:'MSC', value:'MSC Cruises' },{ text:'Costa', value:'Costa Cruises' },
        { text:'Viking Ocean', value:'Viking Ocean Cruises' },{ text:'Seabourn', value:'Seabourn' },
        { text:'Regent Seven Seas', value:'Regent Seven Seas Cruises' },{ text:'Oceania', value:'Oceania Cruises' },
        { text:'Silversea', value:'Silversea' },{ text:'Explora Journeys', value:'Explora Journeys' },
        { text:'Azamara', value:'Azamara' },{ text:'Scenic Eclipse', value:'Scenic Eclipse' },
        { text:'Atlas Ocean Voyages', value:'Atlas Ocean Voyages' },{ text:'Crystal Cruises', value:'Crystal Cruises' },
        { text:'Emerald Cruises', value:'Emerald Cruises' },{ text:'Cunard', value:'Cunard' },
        { text:'Windstar', value:'Windstar Cruises' },{ text:'Paul Gauguin', value:'Paul Gauguin Cruises' },
        { text:'Ponant', value:'Ponant' },{ text:'American Cruise Line', value:'American Cruise Line' },
        { text:'Tauck Cruises', value:'Tauck Cruises' },{ text:'Star Clippers', value:'Star Clippers' },
        { text:'Four Seasons Yachts', value:'Four Seasons Yachts' },{ text:'Ritz-Carlton Yacht', value:'Ritz-Carlton Yacht Collection' },
        { text:'Viking River', value:'Viking River Cruises' },{ text:'Avalon Waterways', value:'Avalon Waterways' },
        { text:'AmaWaterways', value:'AmaWaterways' },{ text:'CroisiEurope', value:'CroisiEurope' },
        { text:'Riverside Cruises', value:'Riverside Cruises' },{ text:'Scenic River', value:'Scenic River Cruises' },
        { text:'Riviera River', value:'Riviera River Cruises' },{ text:'Uniworld', value:'Uniworld Boutique River Cruises' },
        { text:'Lindblad', value:'Lindblad Expeditions' },{ text:'Hurtigruten', value:'Hurtigruten' },
        { text:'UnCruise Adventures', value:'UnCruise Adventures' },
        { text:'DisneyWorld', value:'DisneyWorld' },{ text:'Disneyland', value:'Disneyland' },
        { text:'Aulani', value:'Aulani' },{ text:'Adventures by Disney', value:'Adventures by Disney' },
        { text:'Sandals', value:'Sandals' },{ text:'Beaches Resorts', value:'Beaches Resorts' },
        { text:'Breathless Resorts', value:'Breathless Resorts' },{ text:'Club Med', value:'Club Med' },
        { text:'El Dorado Spa Resorts', value:'El Dorado Spa Resorts' },{ text:'Excellence Resorts', value:'Excellence Resorts' },
        { text:'Hard Rock Hotels', value:'Hard Rock Hotels' },{ text:'Iberostar', value:'Iberostar Hotels & Resorts' },
        { text:'Dreams Resorts', value:'Dreams Resorts' },{ text:'Karisma Hotels', value:'Karisma Hotels & Resorts' },
        { text:'Villas of Distinction', value:'Villas of Distinction' },{ text:'Palace Resorts', value:'Palace Resorts' },
        { text:'Atlantis Paradise Island', value:'Atlantis Paradise Island' },{ text:'Melia', value:'Melia Hotels' },
        { text:'RIU Hotels & Resorts', value:'RIU Hotels & Resorts' },{ text:'Outrigger', value:'Outrigger Hotels & Resorts' },
        { text:'Zoëtry', value:'Zoëtry Wellness & Spa Resorts' },{ text:'Secrets Resorts', value:'Secrets Resorts' },
        { text:'American Airlines Vacations', value:'American Airlines Vacations' },{ text:'Delta Vacations', value:'Delta Vacations' },
        { text:'Southwest Vacations', value:'Southwest Vacations' },{ text:'United Vacations', value:'United Vacations' },
        { text:'Great Safaris', value:'Great Safaris' },{ text:'African Travel', value:'African Travel' },
        { text:'Abercrombie & Kent', value:'Abercrombie & Kent' },{ text:'G Adventures', value:'G Adventures' },
        { text:'Globus Journeys', value:'Globus Journeys' },{ text:'Rocky Mountaineer', value:'Rocky Mountaineer' },
        { text:'Collette', value:'Collette' },{ text:'CIE Tours', value:'CIE Tours' },
        { text:'Trafalgar', value:'Trafalgar' }
      ].sort((a,b)=>a.text.localeCompare(b.text));

      const SUPPLIER_INFO_RAW = {
        "ama waterways":{name:"AmaWaterways"}, "amawaterways":{name:"AmaWaterways"},
        "disney cruises":{name:"Disney Cruise Line"},
        "viking cruises": {name:"Viking Ocean Cruises"}, "viking ocean & expedition": {name:"Viking Ocean Cruises"}, "windstar": {name:"Windstar Cruises"},
        "norwegian cruise line":{name:"Norwegian Cruise Line"},"royal caribbean":{name:"Royal Caribbean"},"celebrity cruises":{name:"Celebrity Cruises"},"disney cruise line":{name:"Disney Cruise Line"},"virgin voyages":{name:"Virgin Voyages"},"holland america line":{name:"Holland America Line"},"princess":{name:"Princess Cruises"},"princess cruises":{name:"Princess Cruises"},"carnival":{name:"Carnival Cruise Line"},"carnival cruise line":{name:"Carnival Cruise Line"},"msc cruises":{name:"MSC Cruises"},"viking":{name:"Viking Ocean Cruises"},"viking ocean cruises":{name:"Viking Ocean Cruises"},"american cruise line":{name:"American Cruise Line"},"atlas ocean voyages":{name:"Atlas Ocean Voyages"},"azamara":{name:"Azamara"},"crystal cruises":{name:"Crystal Cruises"},"cunard":{name:"Cunard"},"emerald cruises":{name:"Emerald Cruises"},"explora journeys":{name:"Explora Journeys"},"four seasons yachts":{name:"Four Seasons Yachts"},"oceania cruises":{name:"Oceania Cruises"},"paul gauguin cruises":{name:"Paul Gauguin Cruises"},"ponant":{name:"Ponant"},"regent seven seas cruises":{name:"Regent Seven Seas Cruises"},"ritz-carlton yacht collection":{name:"Ritz-Carlton Yacht Collection"},"scenic eclipse ocean voyages":{name:"Scenic Eclipse"},"scenic eclipse":{name:"Scenic Eclipse"},"seabourn":{name:"Seabourn"},"silversea":{name:"Silversea"},"star clippers":{name:"Star Clippers"},"tauck cruises":{name:"Tauck Cruises"},"windstar cruises":{name:"Windstar Cruises"},"avalon waterways":{name:"Avalon Waterways"},"croisieurope":{name:"CroisiEurope"},"riverside cruises":{name:"Riverside Cruises"},"riviera river cruises":{name:"Riviera River Cruises"},"tauck tours":{name:"Tauck River Cruising"},"uniworld":{name:"Uniworld Boutique River Cruises"},"uniworld boutique river cruises":{name:"Uniworld Boutique River Cruises"},"scenic river":{name:"Scenic River Cruises"},"scenic luxury cruises & tours":{name:"Scenic River Cruises"},"scenic river cruises":{name:"Scenic River Cruises"},"lindblad expeditions & national geographic":{name:"Lindblad Expeditions"},"lindblad expeditions":{name:"Lindblad Expeditions"},"hurtigruten":{name:"Hurtigruten"},"uncruise adventures":{name:"UnCruise Adventures"},"adventures by disney":{name:"Adventures by Disney"},"disneyland":{name:"Disneyland"},"disneyworld":{name:"DisneyWorld"},"walt disney world":{name:"DisneyWorld"},"aulani a disney resort & spa":{name:"Aulani"},"aulani":{name:"Aulani"},"sandals":{name:"Sandals"},"beaches":{name:"Beaches Resorts"},"beaches resorts":{name:"Beaches Resorts"},"breathless":{name:"Breathless Resorts"},"breathless resorts":{name:"Breathless Resorts"},"club med":{name:"Club Med"},"el dorado spa resorts & hotels":{name:"El Dorado Spa Resorts"},"el dorado spa resorts":{name:"El Dorado Spa Resorts"},"dreams":{name:"Dreams Resorts"},"dreams resorts":{name:"Dreams Resorts"},"excellence resorts":{name:"Excellence Resorts"},"hard rock hotels":{name:"Hard Rock Hotels"},"hard rock hotel & casino":{name:"Hard Rock Hotels"},"iberostar hotels & resorts":{name:"Iberostar Hotels & Resorts"},"iberostar beachfront resorts":{name:"Iberostar Hotels & Resorts"},"karisma hotels & resorts":{name:"Karisma Hotels & Resorts"},"outrigger hotels & resorts":{name:"Outrigger Hotels & Resorts"},"palace resorts":{name:"Palace Resorts"},"riu hotels & resorts":{name:"RIU Hotels & Resorts"},"secrets":{name:"Secrets Resorts"},"secrets resorts":{name:"Secrets Resorts"},"american airline vacations":{name:"American Airlines Vacations"},"american airlines vacations":{name:"American Airlines Vacations"},"delta vacations":{name:"Delta Vacations"},"southwest vacations":{name:"Southwest Vacations"},"united vacations":{name:"United Vacations"},"villas of distinction":{name:"Villas of Distinction"},"zoetry wellness & spa resorts":{name:"Zoëtry Wellness & Spa Resorts"},"atlantis paradise island bahamas":{name:"Atlantis Paradise Island"},"atlantis":{name:"Atlantis Paradise Island"},"atlantis paradise island":{name:"Atlantis Paradise Island"},"great safaris":{name:"Great Safaris"},"african travel":{name:"African Travel"},"abercrombie & kent":{name:"Abercrombie & Kent"},"g adventures":{name:"G Adventures"},"globus journeys":{name:"Globus Journeys"},"globus":{name:"Globus Journeys"},"trafalgar":{name:"Trafalgar"},"bluesky tours":{name:"BlueSky Tours"},"cie tours":{name:"CIE Tours"},"collette":{name:"Collette"},"shore excursions group":{name:"Shore Excursions Group"},"toursalescom":{name:"TourSales.com"},"viator":{name:"Viator"},"project expedition":{name:"Project Expedition"},"rocky mountaineer":{name:"Rocky Mountaineer"},"viking river cruises":{name:"Viking River Cruises"}
      };
      const SUPPLIER_INFO = Object.fromEntries(Object.entries(SUPPLIER_INFO_RAW).map(([k,v]) => [normalizeSupplier(k), v]));

      function getDisplayName(key){
        assert(typeof key === 'string', 'getDisplayName key must be a string.');
        const normalized = normalizeSupplier(key);
        return SUPPLIER_INFO[normalized]?.name || formatDisplayName(key);
      }
      
      // ---------- State ----------
      const featuredBrandSelect = $('#featured-brand-select');
      const lastweekBrandsContainer = $('#lastweek-brands-bubbles');
      const computeRotatorBtn = $('#compute-rotator-btn');
      const rotatorOutputDiv = $('#rotator-output');

      let selectedLastWeekBrands = [];
      let rotatorComputedSuppliers = [];
      let allParsedDeals = [];
      let displayedDeals = [];
      let selectedDealsForCopy = [];
      let currentSort = 'supplier';
      let activeSupplierFilter = null;
      let showExclusivesOnly = false;
      let isRotatorFilterActive = false;

      // ---------- Rotator UI ----------
      function populateRotatorSelectors(){
        const fragSelect = new DocumentFragment();
        fragSelect.appendChild(new Option('-- Select Main Feature Brand --', ''));
        rotatorBrandDisplayList.forEach(brand => fragSelect.appendChild(new Option(brand.text, brand.value)));
        featuredBrandSelect.innerHTML = '';
        featuredBrandSelect.appendChild(fragSelect);

        const fragBubbles = new DocumentFragment();
        rotatorBrandDisplayList.forEach(brand => {
          const btn = document.createElement('button');
          btn.dataset.brandValue = brand.value;
          btn.textContent = brand.text;
          btn.title = brand.value;
          btn.setAttribute('aria-pressed','false');
          btn.addEventListener('click', () => toggleLastWeekBrand(btn, brand.value));
          fragBubbles.appendChild(btn);
        });
        lastweekBrandsContainer.innerHTML = '';
        lastweekBrandsContainer.appendChild(fragBubbles);

        restoreRotatorSelections();
      }

      function toggleLastWeekBrand(buttonEl, brandValue){
        const i = selectedLastWeekBrands.indexOf(brandValue);
        if (i > -1){
          selectedLastWeekBrands.splice(i,1);
          buttonEl.classList.remove('active');
          buttonEl.setAttribute('aria-pressed','false');
        } else {
          // CORRECTED LOGIC: Check if the limit has been reached BEFORE adding.
          if (selectedLastWeekBrands.length >= 4) { return; }
          selectedLastWeekBrands.push(brandValue);
          buttonEl.classList.add('active');
          buttonEl.setAttribute('aria-pressed','true');
        }
        persistRotatorSelections();
      }
      
      function computeRotatorResults(){
        const featured = featuredBrandSelect.value;
        computeRotatorBtn.setAttribute('aria-pressed','true');

        if (!featured){
          rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">Please select This Week’s Main Feature Brand.</p>';
          clearRotatorFilterLogic(); updateAndRenderDeals(); return;
        }
        if (selectedLastWeekBrands.length === 0){
          rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">Please select at least one Last Week’s Below-the-Fold Brand.</p>';
          clearRotatorFilterLogic(); updateAndRenderDeals(); return;
        }

        let result = potm.filter(b => b !== featured && !selectedLastWeekBrands.includes(b));
        const addFrom = list => list.forEach(b => { if (result.length < 4 && b !== featured && !selectedLastWeekBrands.includes(b) && !result.includes(b)) result.push(b); });
        
        addFrom(mostPriority);
        addFrom(midPriority);
        addFrom(leastPriority);
        if (result.length < 4) addFrom(rotatorBrandDisplayList.map(b => b.value));
        
        rotatorComputedSuppliers = result.slice(0,4);

        if (rotatorComputedSuppliers.length === 0){
          rotatorOutputDiv.innerHTML = '<p style="color: var(--text-secondary);">No suitable below-the-fold suppliers found.</p>';
          clearRotatorFilterLogic();
        } else {
          rotatorOutputDiv.innerHTML = `<strong>This Week’s Below-the-Fold Suppliers:</strong><br>${rotatorComputedSuppliers.map(b => `– ${escapeHtml(b)}`).join('<br>')}`;
          activateRotatorFilterInDealLister();
        }
        updateAndRenderDeals();
      }

      function persistRotatorSelections(){
        try { localStorage.setItem('tdst_rotator_v2', JSON.stringify({ featured: featuredBrandSelect.value || '', lastweek: selectedLastWeekBrands })); }
        catch(e){ console.error("Could not persist rotator selections:", e); }
      }

      function restoreRotatorSelections(){
        try{
          const raw = localStorage.getItem('tdst_rotator_v2');
          if (!raw) return;
          const {featured,lastweek} = JSON.parse(raw);
          if (featured) featuredBrandSelect.value = featured;
          if (Array.isArray(lastweek)){
            selectedLastWeekBrands = lastweek.filter(Boolean);
            $$('#lastweek-brands-bubbles button').forEach(btn => {
              const isActive = selectedLastWeekBrands.includes(btn.dataset.brandValue);
              btn.classList.toggle('active', isActive);
              btn.setAttribute('aria-pressed', String(isActive));
            });
          }
        }catch(e){ console.error("Could not restore rotator selections:", e); }
      }
      
      // ---------- Deal Lister Parsing ----------
      function formatDate(dStr){
        if (!dStr) return '';
        if (['call for details','contact us','ongoing'].includes(String(dStr).toLowerCase().trim())) return 'Ongoing';
        try {
          const d = new Date(dStr);
          assert(!isNaN(d.getTime()),'Invalid date string.'); assert(d.getFullYear()<2050&&d.getFullYear()>1990,'Date year out of range.');
          return `Ends ${d.getMonth()+1}/${d.getDate()}`;
        } catch { return '' }
      }

      function parseDeals(dealArray){
        assert(Array.isArray(dealArray), 'Input to parseDeals must be an array.');
        const out = [];
        for (const deal of dealArray) {
          try {
            if (!deal || typeof deal !== 'object') continue;
            const { status, shopOverline, title, shopListing, dealCategory, expiryDate: expiryDateStr } = deal;
            if (!shopOverline || !title || !shopListing || status !== 'live') continue;

            const displayName = getDisplayName(shopOverline);
            if (displayName === 'Unknown') continue;

            const isExclusive = Array.isArray(dealCategory) && dealCategory.includes(39542);
            const formattedExpiry = formatDate(expiryDateStr);
            let expiryDateObj = null;
            if (formattedExpiry && formattedExpiry !== 'Ongoing'){
              const tmp = new Date(expiryDateStr);
              if (!isNaN(tmp.getTime())) expiryDateObj = tmp;
            }

            out.push({ displayName, title:String(title), description:String(shopListing), exclusive:isExclusive, formattedExpiryDate:formattedExpiry, expiryDateObject:expiryDateObj, id:crypto.randomUUID() });
          } catch(err){ console.error('Error processing a deal object:', deal, err); }
        }
        return out;
      }

      // ---------- Deal Lister Rendering & State ----------
      function sortDisplayedDeals(){
        const fallbackDate = new Date('2099-12-31');
        displayedDeals.sort((a,b)=>{
          if (currentSort==='supplier'){ if (a.displayName.localeCompare(b.displayName) !== 0) return a.displayName.localeCompare(b.displayName); }
          else if (currentSort==='exclusive'){ if (b.exclusive - a.exclusive !== 0) return b.exclusive - a.exclusive; }
          return (a.expiryDateObject || fallbackDate) - (b.expiryDateObject || fallbackDate);
        });
      }

      function renderDealList(){
        const list = $('#deal-list');
        list.innerHTML = '';
        if (selectedDealsForCopy.length === 0){
          list.innerHTML = `<li class="placeholder">${allParsedDeals.length > 0 ? 'No deals match filters or all removed.' : 'Upload a JSON file to see deals.'}</li>`;
          return;
        }

        const frag = document.createDocumentFragment();
        for (const deal of selectedDealsForCopy){
          const li = document.createElement('li');
          li.className = 'deal-item';
          li.innerHTML = `<div class="indicator">${deal.exclusive?'<span class="exclusive-star" title="Exclusive Deal">★</span>':''}</div><div class="supplier">${escapeHtml(deal.displayName)}</div><div class="title-line"><span class="title">${escapeHtml(deal.title)}</span>${deal.formattedExpiryDate?`<span class="expiry-pill">${escapeHtml(deal.formattedExpiryDate)}</span>`:''}</div><div class="description">${escapeHtml(deal.description)}</div><button class="remove-deal-btn" title="Remove deal" aria-label="Remove deal: ${escapeHtml(deal.title)}" data-deal-id="${deal.id}">✖</button>`;
          frag.appendChild(li);
        }
        list.appendChild(frag);
        list.addEventListener('click', e => { if (e.target.classList.contains('remove-deal-btn')) handleRemoveDeal(e.target.dataset.dealId); });
      }
      
      function updateAndRenderDeals(){
        let temp = [...allParsedDeals];
        if (isRotatorFilterActive && rotatorComputedSuppliers.length>0){
          const rotatorSet = new Set(rotatorComputedSuppliers);
          temp = temp.filter(d => rotatorSet.has(d.displayName));
        } else if (activeSupplierFilter){
          temp = temp.filter(d => d.displayName === activeSupplierFilter);
        }
        if (showExclusivesOnly){ temp = temp.filter(d => d.exclusive); }
        
        displayedDeals = [...temp];
        sortDisplayedDeals();
        selectedDealsForCopy = [...displayedDeals];
        renderDealList();
        updateDealListerFilterUIStates();
      }

      function updateDealListerFilterUIStates(){
        $$('#supplier-filters button').forEach(btn => {
          btn.classList.toggle('active', !isRotatorFilterActive && btn.dataset.supplier === (activeSupplierFilter || 'ALL'));
          btn.toggleAttribute('aria-disabled', isRotatorFilterActive);
        });
        const exclusiveBtn = $('#exclusive-toggle-btn');
        exclusiveBtn.classList.toggle('active', showExclusivesOnly);
        exclusiveBtn.setAttribute('aria-pressed', String(showExclusivesOnly));
        $$('.sort-options button').forEach(b => b.classList.remove('active'));
        $('#sort-'+currentSort)?.classList.add('active');
        const rotatorStatusDiv = $('#rotator-filter-status-container');
        rotatorStatusDiv.style.display = isRotatorFilterActive && rotatorComputedSuppliers.length > 0 ? 'block' : 'none';
        if(isRotatorFilterActive) $('#rotator-filter-names').textContent = rotatorComputedSuppliers.join(', ');
      }

      function renderSupplierFilters(){
        const container = $('#supplier-filters');
        container.innerHTML = '';
        const uniqueSuppliers = [...new Set(allParsedDeals.map(d => d.displayName))].sort();
        if(uniqueSuppliers.length === 0) return;

        const allBtn = document.createElement('button');
        allBtn.textContent = 'All Suppliers'; allBtn.dataset.supplier = 'ALL';
        allBtn.addEventListener('click', () => setSupplierFilter(null));
        container.appendChild(allBtn);

        uniqueSuppliers.forEach(name => {
          const btn = document.createElement('button');
          btn.textContent = name; btn.dataset.supplier = name;
          btn.addEventListener('click', () => setSupplierFilter(name));
          container.appendChild(btn);
        });
      }

      // ---------- Event Handlers & Actions ----------
      function handleFileUpload(event) {
        const file = event.target.files[0];
        assert(file, 'No file selected.'); assert(file.size <= 5*1024*1024, 'File size exceeds 5MB limit.');
        $('#file-name-display').textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => processJsonText(e.target.result);
        reader.onerror = () => { console.error('[FileUpload] Failed to read file:', reader.error); $('#deal-list').innerHTML = `<li class="placeholder" style="color:var(--danger)">Error reading file.</li>`; };
        reader.readAsText(file);
      }
      
      function processJsonText(text){
        assert(typeof text === 'string' && text.length > 0, 'JSON text is empty.');
        try{ allParsedDeals = parseDeals(JSON.parse(text)); }
        catch(e) { console.error('[JSONParse] Failed to parse JSON:', e); allParsedDeals = []; $('#deal-list').innerHTML = `<li class="placeholder" style="color:var(--danger)">Invalid JSON format in file.</li>`; }
        
        const filters = $('#filters-and-sorts-container');
        filters.style.display = allParsedDeals.length > 0 ? 'block' : 'none';
        if (allParsedDeals.length > 0) renderSupplierFilters();
        updateAndRenderDeals();
      }

      function handleRemoveDeal(dealId){ selectedDealsForCopy = selectedDealsForCopy.filter(d => d.id !== dealId); renderDealList(); }
      async function showButtonSuccess(btnEl) {
          const originalText = btnEl.textContent;
          btnEl.textContent = 'Copied!'; btnEl.style.backgroundColor = 'var(--secondary)';
          await new Promise(r => setTimeout(r, 1500));
          btnEl.textContent = originalText; btnEl.style.backgroundColor = '';
      }
      
      async function copyTextToClipboard(text, buttonEl) {
        assert(typeof text === 'string', 'Text to copy must be a string.'); if (!text) return;
        try { await navigator.clipboard.writeText(text); showButtonSuccess(buttonEl); }
        catch (err) { console.error('Clipboard write failed: ', err); }
      }

      function formatDealsForCopy(deals){
          const bySupplier = deals.reduce((acc, d)=>{(acc[d.displayName] ||= []).push(d); return acc;}, {});
          const sortedSuppliers = Object.keys(bySupplier).sort();
          const fallbackDate = new Date('2099-12-31');
          return sortedSuppliers.map(name => {
              const supplierDeals = bySupplier[name];
              supplierDeals.sort((a,b)=>{
                  if (a.exclusive !== b.exclusive) return b.exclusive - a.exclusive;
                  const [da, db] = [a.expiryDateObject||fallbackDate, b.expiryDateObject||fallbackDate];
                  return da - db !== 0 ? da - db : a.title.localeCompare(b.title);
              });
              const dealLines = supplierDeals.map(d => `${d.exclusive && !d.title.toLowerCase().startsWith('exclusive:') ? 'EXCLUSIVE: ' : ''}${d.title}${d.formattedExpiryDate ? ` – ${d.formattedExpiryDate}` : ''}`).join('\n');
              return `${name}\n${dealLines}`;
          }).join('\n\n');
      }

      function copySelectedDeals(e) { if (selectedDealsForCopy.length===0) return; copyTextToClipboard(formatDealsForCopy(selectedDealsForCopy), e.target); }
      function copyRotatorDeals(e){
        assert(rotatorComputedSuppliers.length > 0, 'Rotator suppliers must be computed first.'); assert(allParsedDeals.length > 0, 'Deals must be loaded.');
        const dealsToCopy = allParsedDeals.filter(d => rotatorComputedSuppliers.includes(d.displayName));
        if (dealsToCopy.length === 0) return;
        copyTextToClipboard(formatDealsForCopy(dealsToCopy), e.target);
      }

      function setSupplierFilter(name){ if (isRotatorFilterActive) return; activeSupplierFilter = name; updateAndRenderDeals(); }
      function toggleExclusiveFilter(){ showExclusivesOnly = !showExclusivesOnly; updateAndRenderDeals(); }
      function setSort(type){ if (currentSort !== type){ currentSort = type; updateAndRenderDeals(); } }
      function activateRotatorFilterInDealLister(){ isRotatorFilterActive = true; updateDealListerFilterUIStates(); }
      function clearRotatorFilterLogic(){ isRotatorFilterActive = false; updateDealListerFilterUIStates(); }

      function clearAllDealLister(){
        allParsedDeals = []; displayedDeals = []; selectedDealsForCopy = [];
        $('#json-file-input').value = ''; $('#file-name-display').textContent = '';
        $('#filters-and-sorts-container').style.display = 'none'; $('#supplier-filters').innerHTML = '';
        activeSupplierFilter = null; showExclusivesOnly = false; currentSort = 'supplier';
        clearRotatorFilterLogic();
        updateAndRenderDeals();
      }
      
      // ---------- Initializer ----------
      function initApp(){
        populateRotatorSelectors();
        computeRotatorBtn.addEventListener('click', computeRotatorResults);
        $('#json-file-input').addEventListener('change', handleFileUpload);
        $('#copy-selected-deals-btn').addEventListener('click', copySelectedDeals);
        $('#copy-rotator-deals-btn').addEventListener('click', copyRotatorDeals);
        $('#clear-deal-lister-btn').addEventListener('click', clearAllDealLister);
        $('#clear-rotator-filter-btn').addEventListener('click', () => { clearRotatorFilterLogic(); updateAndRenderDeals(); });
        $('#exclusive-toggle-btn').addEventListener('click', toggleExclusiveFilter);
        $('#sort-supplier').addEventListener('click', ()=>setSort('supplier'));
        $('#sort-expiry').addEventListener('click', ()=>setSort('expiry'));
        $('#sort-exclusive').addEventListener('click', ()=>setSort('exclusive'));
        featuredBrandSelect.addEventListener('change', persistRotatorSelections);
      }

      document.addEventListener('DOMContentLoaded', initApp);
    })();
  </script>
</body>
</html>