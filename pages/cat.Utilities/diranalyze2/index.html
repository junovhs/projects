<!doctype html>
<html lang="en" class="antialiased">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DirAnalyze 2.0 ‚Äì Static</title>
  <style>
    :root{
      /* light */
      --bg: #f8fafc; /* slate-50 */
      --bg2: #eef2ff; /* indigo-50 */
      --card: #ffffff;
      --muted: #f1f5f9;
      --text: #0f172a; /* slate-900 */
      --text-muted:#64748b;
      --primary:#1d4ed8;
      --primary-foreground:#ffffff;
      --border:#e2e8f0;
      --ring:#93c5fd;
    }
    .dark{
      --bg:#0b1220; /* custom near slate-900 */
      --bg2:#111827;
      --card:#0f172a;
      --muted:#0b1424;
      --text:#e5e7eb;
      --text-muted:#9ca3af;
      --primary:#60a5fa;
      --primary-foreground:#0b1220;
      --border:#1f2937;
      --ring:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, Noto Sans, "Apple Color Emoji","Segoe UI Emoji"; color:var(--text); background:linear-gradient(135deg,var(--bg),var(--bg2));}
    a{color:inherit}

    /* Utility */
    .row{display:flex; align-items:center}
    .between{justify-content:space-between}
    .center{justify-content:center}
    .col{display:flex; flex-direction:column}
    .g-1{gap:.25rem} .g-2{gap:.5rem} .g-3{gap:.75rem} .g-4{gap:1rem}
    .p-2{padding:.5rem} .p-3{padding:.75rem} .p-4{padding:1rem} .p-6{padding:1.5rem}
    .px-4{padding-left:1rem; padding-right:1rem}
    .py-3{padding-top:.75rem; padding-bottom:.75rem}
    .py-2{padding-top:.5rem; padding-bottom:.5rem}
    .pb-2{padding-bottom:.5rem}
    .rounded{border-radius:10px}
    .rounded-sm{border-radius:6px}
    .rounded-lg{border-radius:14px}
    .shadow{box-shadow:0 1px 2px rgba(0,0,0,.06), 0 8px 30px rgba(0,0,0,.05)}
    .muted{color:var(--text-muted)}
    .btn{display:inline-flex; align-items:center; gap:.4rem; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:8px; height:32px; padding:0 .75rem; cursor:pointer}
    .btn:hover{background:color-mix(in hsl,var(--card),var(--primary) 5%)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}
    .btn.primary{background:var(--primary); border-color:var(--primary); color:var(--primary-foreground)}
    .btn.ghost{border-color:transparent; background:transparent}
    .btn.icon{width:36px; height:36px; justify-content:center}
    .input{height:32px; border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:6px; padding:0 .5rem}
    .checkbox{width:14px; height:14px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px}
    .badge{display:inline-flex; align-items:center; height:22px; padding:0 .5rem; border:1px solid var(--border); background:var(--muted); border-radius:999px; font-size:12px}

    header{position:sticky; top:0; z-index:10; background:color-mix(in hsl,var(--card), transparent 20%); backdrop-filter:saturate(1.2) blur(6px); border-bottom:1px solid var(--border)}

    /* Layout */
    #app{min-height:calc(100vh - 0px)}
    .shell{display:flex; height:calc(100vh - 64px)}
    .sidebar{position:relative; width:320px; border-right:1px solid var(--border); background:color-mix(in hsl,var(--card), transparent 30%);}
    .divider{position:absolute; top:0; right:0; bottom:0; width:6px; cursor:ew-resize}
    .divider:hover{background:color-mix(in hsl,var(--primary), transparent 50%)}
    .main{flex:1; display:flex; flex-direction:column}

    /* Scrollbars */
    *{scrollbar-width:thin; scrollbar-color:color-mix(in hsl,var(--text-muted), transparent 50%) transparent; transition:background-color .2s, border-color .2s, color .2s}
    ::-webkit-scrollbar{width:6px; height:6px}
    ::-webkit-scrollbar-thumb{background:color-mix(in hsl,var(--text-muted), transparent 50%); border-radius:3px}
    ::selection{background:var(--primary); color:var(--primary-foreground)}

    /* Tree */
    .tree{height:100%; overflow:auto; padding:.5rem}
    .tree-item{display:flex; align-items:center; gap:.5rem; padding:.25rem .5rem; border-radius:6px; cursor:pointer}
    .tree-item:hover{background:color-mix(in hsl,var(--muted), var(--primary) 6%)}
    .tree-name{flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    /* Editor */
    .editor{display:flex; height:100%;}
    .linenums{width:40px; background:color-mix(in hsl,var(--muted), transparent 20%); border-right:1px solid var(--border); font:12px/24px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:var(--text-muted); padding:.25rem .25rem; overflow:auto}
    .textarea{flex:1; border:0; padding:.5rem .75rem; outline:none; resize:none; font:12px/24px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:transparent; color:var(--text)}

    /* Footer status */
    .status{border-top:1px solid var(--border); background:var(--primary); color:var(--primary-foreground)}

    /* Dropzone */
    .drop{border:2px dashed color-mix(in hsl,var(--text-muted), transparent 60%); border-radius:14px; padding:2rem; text-align:center; background:color-mix(in hsl,var(--muted), transparent 30%)}
    .drop:hover{border-color:var(--primary); background:color-mix(in hsl,var(--muted), var(--primary) 5%)}

    /* Dialog */
    dialog{border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:12px; padding:0; width:min(900px, calc(100vw - 2rem))}
    dialog::backdrop{background:#0006}
    .dlg-head{padding:1rem; border-bottom:1px solid var(--border)}
    .dlg-body{padding:1rem}

    /* Toast */
    .toast{position:fixed; right:1rem; bottom:1rem; background:#111; color:#fff; border-radius:10px; padding:.75rem 1rem; box-shadow:0 8px 30px rgba(0,0,0,.3); z-index:50}

    /* Logo circle */
    .logo{width:32px; height:32px; border-radius:999px; background:radial-gradient(circle at 30% 20%, #93c5fd, #3b82f6); display:inline-flex; align-items:center; justify-content:center; color:#fff; font-weight:700}
  </style>
</head>
<body>
<div id="app">
  <!-- Header -->
  <header>
    <div class="row between px-4 py-3">
      <div class="row g-3">
        <div class="logo">D2</div>
        <div>
          <div style="font-weight:700">DirAnalyze 2.0</div>
          <div class="muted" style="font-size:12px">Directory Analysis Tool</div>
        </div>
      </div>
      <div class="row g-2">
        <button class="btn" id="clearBtn">üóëÔ∏è Clear Project</button>
        <button class="btn ghost icon" id="themeBtn" title="Toggle theme">üåô</button>
      </div>
    </div>
  </header>

  <div class="shell">
    <!-- Sidebar -->
    <aside class="sidebar col" id="sidebar">
      <div class="divider" id="divider"></div>
      <div class="p-4" id="sidebarEmpty">
        <div class="card p-6 shadow">
          <div class="col g-3 center">
            <div style="width:64px;height:64px;border-radius:999px; background:color-mix(in hsl,var(--primary), transparent 80%); display:flex;align-items:center;justify-content:center">üì§</div>
            <div style="font-weight:600">Drop Folder Here</div>
            <div class="muted" style="font-size:13px">Drag & drop a folder or click to select</div>
            <div class="row g-2">
              <button class="btn" id="selectBtn">Select Folder</button>
              <input id="folderInput" type="file" style="display:none" webkitdirectory directory multiple />
            </div>
          </div>
        </div>
      </div>

      <div id="sidebarControls" style="display:none">
        <div class="p-4" style="border-bottom:1px solid var(--border)">
          <div class="row g-2 pb-2">
            <button class="btn" id="textReportBtn">‚¨áÔ∏è Text Report</button>
            <button class="btn" id="combinedBtn">üß© Combined</button>
          </div>
          <div class="row g-2 pb-2">
            <button class="btn ghost" id="selectAllBtn">‚úÖ All</button>
            <button class="btn ghost" id="selectNoneBtn">‚ùå None</button>
            <button class="btn ghost" id="expandAllBtn">üîé Expand</button>
            <button class="btn ghost" id="collapseAllBtn">üìâ Collapse</button>
          </div>
          <div class="col g-2">
            <label style="font-size:12px">Include patterns</label>
            <input class="input" id="includeFilter" placeholder="*.js, *.css" />
            <label style="font-size:12px">Exclude patterns</label>
            <input class="input" id="excludeFilter" />
            <label class="row g-2" style="font-size:12px; align-items:center"><input type="checkbox" class="checkbox" id="showHiddenChk"> Show hidden files</label>
          </div>
        </div>
        <div class="tree" id="tree"></div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div id="editorToolbar" class="row between p-4" style="border-bottom:1px solid var(--border); background:color-mix(in hsl,var(--muted), transparent 20%); display:none">
        <div class="row g-2">
          <button class="btn" id="copyLinesBtn">üìã Copy with Lines</button>
          <button class="btn" id="patchBtn">‚öôÔ∏è Apply Patch</button>
          <button class="btn" id="saveBtn" disabled>üíæ Save</button>
          <button class="btn" id="closeBtn">‚úñÔ∏è Close</button>
        </div>
        <div id="currentFileLabel" class="muted" style="font-size:12px"></div>
      </div>

      <section id="mainTreePane" class="col" style="height:100%;">
        <div class="row between p-4" style="border-bottom:1px solid var(--border); background:color-mix(in hsl,var(--muted), transparent 20%)">
          <div class="row g-2" style="align-items:center">
            <div style="font-size:16px; font-weight:600">Directory Structure</div>
            <span class="badge" id="committedBadge">0 committed files</span>
          </div>
          <button class="btn" id="copyTreeBtn" disabled>üìã Copy Report</button>
        </div>
        <div style="padding:1rem; height:100%; overflow:auto">
          <pre id="treeReport" class="card p-4" style="font:12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace; white-space:pre-wrap; display:none"></pre>
          <div id="emptyState" class="col center g-3" style="height:100%; text-align:center; color:var(--text-muted)">
            <div style="width:96px;height:96px;border-radius:999px;background:color-mix(in hsl,var(--primary), transparent 85%); display:flex;align-items:center;justify-content:center; font-size:42px">üìÑ</div>
            <div style="font-size:18px; color:var(--text)"><span id="emptyTitle">No files loaded</span></div>
            <div id="emptyDesc">Drop a folder to get started with directory analysis</div>
            <div class="row g-2" id="statsRow" style="display:none">
              <span class="badge" id="totalFilesBadge">0 total files</span>
              <span class="badge" id="selectedFilesBadge">0 selected</span>
            </div>
          </div>
        </div>
      </section>

      <section id="editorPane" style="display:none; height:100%">
        <div class="editor">
          <div class="linenums" id="linenums"></div>
          <textarea class="textarea" id="editor" spellcheck="false"></textarea>
        </div>
      </section>
    </main>
  </div>

  <footer class="status px-4 py-2">
    <div class="row between">
      <div class="row g-4">
        <span id="statusFiles">0 files</span>
        <span id="statusSelected">0 selected</span>
        <span id="statusSize">0 B</span>
      </div>
      <div id="statusMsg">Ready</div>
    </div>
  </footer>
</div>

<!-- Apply Patch dialog -->
<dialog id="patchDialog">
  <div class="dlg-head row between">
    <div style="font-weight:600">Apply AI Patches</div>
    <button class="btn ghost icon" onclick="patchDialog.close()">‚úñÔ∏è</button>
  </div>
  <div class="dlg-body col g-3">
    <div class="muted" style="font-size:13px">Paste patches with this format:
      <pre class="card p-3" style="font:12px/1.6 ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace">FILE: path/to/file.js
12-14:
    // new code here</pre>
    </div>
    <textarea id="patchInput" class="textarea" style="height:280px; border:1px solid var(--border); border-radius:8px"></textarea>
    <div class="row" style="justify-content:flex-end; gap:.5rem">
      <button class="btn" onclick="patchDialog.close()">Cancel</button>
      <button class="btn primary" id="applyPatchesBtn">Apply Patches</button>
    </div>
  </div>
</dialog>

<div id="toast" class="toast" style="display:none"></div>

<script>
(function(){
  /* ---------------------------- State & Helpers --------------------------- */
  const state = {
    files: new Map(),              // path -> content
    fileTree: null,                // nested structure
    selectedFiles: new Set(),
    committedFiles: new Set(),
    expandedFolders: new Set(),
    currentFile: null,
    hasUnsavedChanges: false,
    view: 'tree',                  // 'tree' | 'editor'
    filters: { include:'', exclude:'node_modules,.git,dist,build,.DS_Store', showHidden:false },
    gitignorePatterns: [],
    placeholders: new Map(),
    lastLoaded: [],
    isDark: false,
    sidebarWidth: 320
  };

  const DEFAULT_GITIGNORE = `\nnode_modules/\n.git/\n.gitignore\ndist/\nbuild/\n*.log\n.DS_Store\n.env\n.env.local\n.cache\n.parcel-cache\n.next\n.nuxt\n.vscode/\n.idea/\n*.swp\n*.swo\n*~\n.npm\n.yarn/\ncoverage/\n.nyc_output\n`;

  /* ----------------------------- DOM references --------------------------- */
  const folderInput = document.getElementById('folderInput');
  const selectBtn = document.getElementById('selectBtn');
  const sidebarEmpty = document.getElementById('sidebarEmpty');
  const sidebarControls = document.getElementById('sidebarControls');
  const treeEl = document.getElementById('tree');
  const committedBadge = document.getElementById('committedBadge');
  const copyTreeBtn = document.getElementById('copyTreeBtn');
  const treeReportEl = document.getElementById('treeReport');
  const emptyState = document.getElementById('emptyState');
  const emptyTitle = document.getElementById('emptyTitle');
  const emptyDesc = document.getElementById('emptyDesc');
  const statsRow = document.getElementById('statsRow');
  const totalFilesBadge = document.getElementById('totalFilesBadge');
  const selectedFilesBadge = document.getElementById('selectedFilesBadge');
  const mainTreePane = document.getElementById('mainTreePane');
  const editorPane = document.getElementById('editorPane');
  const editor = document.getElementById('editor');
  const linenums = document.getElementById('linenums');
  const editorToolbar = document.getElementById('editorToolbar');
  const currentFileLabel = document.getElementById('currentFileLabel');
  const saveBtn = document.getElementById('saveBtn');
  const patchDialog = document.getElementById('patchDialog');
  const patchInput = document.getElementById('patchInput');
  const toast = document.getElementById('toast');

  /* Header & status*/
  const statusFiles = document.getElementById('statusFiles');
  const statusSelected = document.getElementById('statusSelected');
  const statusSize = document.getElementById('statusSize');
  const statusMsg = document.getElementById('statusMsg');

  /* Buttons */
  document.getElementById('themeBtn').onclick = toggleTheme;
  document.getElementById('clearBtn').onclick = clearProject;
  document.getElementById('textReportBtn').onclick = () => copyToClipboard(generateReport(true), 'Text report copied');
  document.getElementById('combinedBtn').onclick = exportCombinedText;
  document.getElementById('selectAllBtn').onclick = ()=> selectAll(true);
  document.getElementById('selectNoneBtn').onclick = ()=> selectAll(false);
  document.getElementById('expandAllBtn').onclick = ()=> expandAll(true);
  document.getElementById('collapseAllBtn').onclick = ()=> expandAll(false);
  document.getElementById('includeFilter').onblur = applyFilters;
  document.getElementById('excludeFilter').onblur = applyFilters;
  document.getElementById('showHiddenChk').onchange = (e)=>{ state.filters.showHidden=e.target.checked; applyFilters(); };
  document.getElementById('copyTreeBtn').onclick = ()=> copyToClipboard(generateTreeReport(), 'Tree structure copied');
  document.getElementById('copyLinesBtn').onclick = copyWithLineNumbers;
  document.getElementById('patchBtn').onclick = ()=> patchDialog.showModal();
  document.getElementById('applyPatchesBtn').onclick = applyPatches;
  document.getElementById('saveBtn').onclick = saveCurrentFile;
  document.getElementById('closeBtn').onclick = exitEditor;

  selectBtn.onclick = ()=> folderInput.click();
  folderInput.addEventListener('change',(e)=>{
    const files = Array.from(e.target.files||[]);
    if(files.length) handleFilesLoaded(files);
  });

  // Drag & drop support on entire sidebar
  const sidebar = document.getElementById('sidebar');
  sidebar.addEventListener('dragover', (e)=>{ e.preventDefault(); });
  sidebar.addEventListener('drop', async (e)=>{
    e.preventDefault();
    const items = Array.from(e.dataTransfer.items||[]);
    const files = [];
    for(const item of items){
      if(item.kind==='file'){
        const entry = item.webkitGetAsEntry && item.webkitGetAsEntry();
        if(entry) await traverse(entry, files);
      }
    }
    if(files.length) handleFilesLoaded(files);
  });

  // Sidebar resize
  const divider = document.getElementById('divider');
  divider.addEventListener('mousedown', (e)=>{
    const startX = e.clientX; const startW = sidebar.offsetWidth;
    const onMove = (ev)=>{ const w = Math.max(200, Math.min(700, startW + (ev.clientX-startX))); sidebar.style.width=w+'px'; state.sidebarWidth=w; };
    const onUp = ()=>{ window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
    window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
  });

  // Init theme
  (function init(){
    const saved = localStorage.getItem('diranalyze-theme');
    if(saved==='dark'){ document.documentElement.classList.add('dark'); state.isDark=true; }
    document.getElementById('excludeFilter').value = state.filters.exclude;
  })();

  /* ------------------------------- Core logic ----------------------------- */
  function parseGitignore(content){
    return content.split('\n').map(s=>s.trim()).filter(s=>s && !s.startsWith('#'));
  }
  function globToRegExp(glob){
    let g = glob.replace(/\\/g,'/');
    g = g.replace(/([.+^$(){}|\\])/g,'\\$1');
    g = g.replace(/\*\*/g,'¬ß¬ßDS¬ß¬ß');
    g = g.replace(/\*/g,'[^/]*');
    g = g.replace(/¬ß¬ßDS¬ß¬ß/g,'.*');
    g = g.replace(/\?/g,'[^/]');
    return new RegExp('(^|/)'+g+'($|/)?');
  }
  function matchesGitignore(path, patterns){
    const p = path.replace(/\\/g,'/');
    for(const raw of patterns){
      if(!raw) continue; const pattern = raw.trim(); if(!pattern || pattern.startsWith('#') || pattern.startsWith('!')) continue;
      if(pattern.endsWith('/')){ const dir = pattern.slice(0,-1); if(p.split('/').includes(dir)) return true; continue; }
      if(globToRegExp(pattern).test(p)) return true;
    }
    return false;
  }
  function shouldIncludeFile(path, filters){
    const exclude = filters.exclude.split(',').map(p=>p.trim()).filter(Boolean);
    for(const pat of exclude){ if(pat && path.includes(pat)) return false; }
    if(!filters.showHidden && path.split('/').some(part=>part.startsWith('.'))) return false;
    const include = filters.include.split(',').map(p=>p.trim()).filter(Boolean);
    if(include.length){
      const m = include.some(p=>{ const safe = p.split('*').map(s=>s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('.*'); return new RegExp('^'+safe+'$').test(path);});
      if(!m) return false;
    }
    return true;
  }

  async function handleFilesLoaded(fileList){
    setStatus(`Loading ${fileList.length} files...`);
    const newFiles = new Map();
    const newSelected = new Set();
    const newCommitted = new Set();
    const placeholders = new Map();

    // discover .gitignore
    let gitignoreContent = '';
    for(const f of fileList){ const p = f.webkitRelativePath || f.name; if(p.endsWith('.gitignore') || p==='.gitignore'){ gitignoreContent = await readFile(f); break; } }
    const patterns = parseGitignore(DEFAULT_GITIGNORE + (gitignoreContent ? ('\n'+gitignoreContent) : ''));

    const KNOWN_BUILD_DIRS = new Set(['node_modules','.next','.nuxt','dist','build','.parcel-cache','.cache','coverage','.git','.vscode','.idea','out','.svelte-kit','.angular','.vercel','.turbo','target','bin','obj']);

    for(const f of fileList){
      const path = f.webkitRelativePath || f.name;
      if(matchesGitignore(path, patterns)){
        // collect placeholder stats
        const parts = path.split('/'); const stack=[];
        for(let i=0;i<parts.length-1;i++){ const seg=parts[i]; stack.push(seg); if(KNOWN_BUILD_DIRS.has(seg)){ const dir=stack.join('/'); const rec = placeholders.get(dir) || {count:0,size:0,name:seg}; rec.count++; rec.size += (typeof f.size==='number'? f.size:0); placeholders.set(dir, rec); break; } }
        continue;
      }
      if(!shouldIncludeFile(path, state.filters)) continue;
      const content = await readFile(f);
      newFiles.set(path, content);
      newSelected.add(path);
      newCommitted.add(path);
    }

    state.files = newFiles; state.selectedFiles = newSelected; state.committedFiles = newCommitted; state.placeholders = placeholders; state.lastLoaded = Array.from(fileList); state.gitignorePatterns = patterns; state.currentFile=null; state.hasUnsavedChanges=false;

    buildFileTree(newFiles);
    showToast(`Loaded ${newFiles.size} files`);
    refreshUI();
  }

  function readFile(file){ return new Promise((resolve)=>{ const r = new FileReader(); r.onload = e=> resolve(e.target.result||''); r.onerror = ()=> resolve(''); r.readAsText(file); }); }

  function buildFileTree(files){
    const tree = {};
    for(const [path] of files){
      const parts = path.split('/');
      let cur = tree;
      for(let i=0;i<parts.length;i++){
        const part = parts[i];
        if(i===parts.length-1){ cur[part] = {type:'file', path}; }
        else { cur[part] = cur[part] || {type:'folder', children:{}}; cur = cur[part].children; }
      }
    }
    state.fileTree = tree;
    // preselect all folders as committed
    const addFolders = (node, prefix='')=>{
      for(const [name, item] of Object.entries(node)){
        const p = prefix? `${prefix}/${name}`: name;
        if(item.type==='folder'){
          if(!matchesGitignore(p, state.gitignorePatterns)){
            state.selectedFiles.add(p); state.committedFiles.add(p);
          }
          addFolders(item.children, p);
        }
      }
    };
    addFolders(tree);
  }

  function checkIfFolder(targetPath){
    const find = (node, path)=>{
      for(const [name, item] of Object.entries(node)){
        if(path===name && item.type==='folder') return true;
        if(item.children && find(item.children, path)) return true;
      }
      return false;
    };
    return find(state.fileTree, targetPath);
  }

  function getAllPathsUnder(folderPath){
    const paths=[folderPath];
    const findNode = (node, target)=>{
      if(node[target]) return node[target];
      for(const [k,v] of Object.entries(node)){
        if(v && typeof v==='object'){
          const res = findNode(v.children||v, target); if(res) return res;
        }
      }
      return null;
    };
    const folderNode = findNode(state.fileTree, folderPath);
    const add = (currentPath, item)=>{
      if(!item) return; if(item.type==='file'){ paths.push(item.path); return; }
      for(const [name, child] of Object.entries(item.children||{})) add(`${currentPath}/${name}`, child);
    };
    add(folderPath, folderNode);
    return paths;
  }

  function toggleSelection(path){
    const isFolder = checkIfFolder(path);
    if(isFolder){
      const shouldSelect = !state.selectedFiles.has(path);
      const all = getAllPathsUnder(path);
      if(shouldSelect){ all.forEach(p=>{ if(!matchesGitignore(p, state.gitignorePatterns)){ state.selectedFiles.add(p); state.committedFiles.add(p);} }); }
      else { all.forEach(p=>{ state.selectedFiles.delete(p); state.committedFiles.delete(p); }); }
    } else {
      if(state.selectedFiles.has(path)){ state.selectedFiles.delete(path); state.committedFiles.delete(path);} else { state.selectedFiles.add(path); state.committedFiles.add(path);}    }
    refreshUI();
  }

  function selectAll(sel){
    state.selectedFiles.clear(); state.committedFiles.clear();
    if(sel){
      for(const [path] of state.files){ if(!matchesGitignore(path, state.gitignorePatterns)){ state.selectedFiles.add(path); state.committedFiles.add(path);} }
      // include folders
      const addFolders=(node, p='')=>{ for(const [name, it] of Object.entries(node)){ const fp = p?`${p}/${name}`:name; if(it.type==='folder'){ if(!matchesGitignore(fp, state.gitignorePatterns)){ state.selectedFiles.add(fp); state.committedFiles.add(fp);} addFolders(it.children, fp);} } };
      addFolders(state.fileTree);
    }
    refreshUI();
  }

  function expandAll(on){
    state.expandedFolders = new Set();
    if(on){ const walk=(node,p='')=>{ for(const [name, it] of Object.entries(node)){ const fp=p?`${p}/${name}`:name; if(it.type==='folder'){ state.expandedFolders.add(fp); walk(it.children, fp);} } }; walk(state.fileTree); }
    renderTree();
  }

  function openFile(path){
    if(state.hasUnsavedChanges && state.currentFile){ if(!confirm('You have unsaved changes. Continue?')) return; }
    state.currentFile = path; state.view='editor'; state.hasUnsavedChanges=false; editor.value = state.files.get(path)||''; currentFileLabel.textContent = path; editorToolbar.style.display='flex'; mainTreePane.style.display='none'; editorPane.style.display='block';
    renderLineNumbers(); updateSaveButton();
  }

  function handleEditorChange(){
    if(!state.currentFile) return; const content = editor.value; state.files.set(state.currentFile, content); state.hasUnsavedChanges=true; updateSaveButton(); renderLineNumbers();
  }
  editor.addEventListener('input', handleEditorChange);

  function saveCurrentFile(){ if(!state.currentFile) return; state.hasUnsavedChanges=false; updateSaveButton(); showToast('File saved'); }
  function updateSaveButton(){ saveBtn.disabled = !state.hasUnsavedChanges; currentFileLabel.textContent = state.currentFile + (state.hasUnsavedChanges?' (modified)':''); }
  function exitEditor(){ if(state.hasUnsavedChanges && !confirm('You have unsaved changes. Continue?')) return; state.view='tree'; editorToolbar.style.display='none'; mainTreePane.style.display='block'; editorPane.style.display='none'; }

  function copyWithLineNumbers(){ if(!state.currentFile) return; const text = state.files.get(state.currentFile)||''; const numbered = text.split('\n').map((l,i)=> `${i+1}: ${l}`).join('\n'); const out = `FILE: ${state.currentFile}\n${'='.repeat(40)}\n${numbered}`; copyToClipboard(out, 'Copied with line numbers!'); }

  function applyFilters(){
    const include = document.getElementById('includeFilter').value; const exclude = document.getElementById('excludeFilter').value; state.filters.include=include; state.filters.exclude=exclude; if(state.lastLoaded.length) handleFilesLoaded(state.lastLoaded);
  }

  function exportCombinedText(){
    const selected = state.committedFiles.size? Array.from(state.committedFiles) : Array.from(state.files.keys());
    if(!selected.length){ showToast('No files committed for export'); return; }
    const out = [];
    out.push('//--- COMPREHENSIVE TEXT REPORT ---//'); out.push(`// Timestamp: ${new Date().toISOString()}`); out.push(`// Files: ${selected.length}`); out.push('//'); out.push('//--- DIRECTORY STRUCTURE ---'); out.push(generateDetailedTreeStructure(true)); out.push(''); out.push('//--- FILE CONTENTS WITH LINE NUMBERS ---'); out.push('');
    for(const path of selected.sort()){ const content = state.files.get(path)||''; out.push(`=== FILE: ${path} ===`); const lines = content.split('\n'); lines.forEach((line,i)=> out.push(`${i+1}: ${line}`)); out.push(''); }
    const blob = new Blob([out.join('\n')], {type:'text/plain'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `diranalyze-combined-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showToast(`Combined export downloaded (${selected.length} files)`);
  }

  function generateDetailedTreeStructure(committedOnly){
    const files = committedOnly ? Array.from(state.committedFiles): Array.from(state.files.keys()); if(!files.length) return '';
    const tree = {};
    files.forEach(path=>{ const parts=path.split('/'); let cur=tree; parts.forEach((part,i)=>{ if(!cur[part]) cur[part] = (i===parts.length-1? null: {}); if(i<parts.length-1) cur = cur[part]; }); });
    const lines=[];
    const gen=(obj, prefix='')=>{ const entries = Object.entries(obj).sort(([a],[b])=> a.localeCompare(b)); entries.forEach(([k, v], idx)=>{ const connector = (idx===entries.length-1)? '‚îî‚îÄ‚îÄ ': '‚îú‚îÄ‚îÄ '; const full = prefix? `${prefix}/${k}`: k; if(v===null){ const size = (state.files.get(full)||'').length; lines.push(`${prefix}${connector}${k} (${formatSize(size)})`); } else { lines.push(`${prefix}${connector}${k}/`); const newPref = prefix + (idx===entries.length-1? '    ': '‚îÇ   '); gen(v, newPref); } }); };
    gen(tree);
    return lines.join('\n');
  }

  function generateReport(committedOnly){
    const lines=[]; lines.push('//--- DIRANALYSE MATRIX REPORT (v2.1) ---//'); lines.push(`// Timestamp: ${new Date().toISOString()}`); lines.push(`// Scope: ${committedOnly ? 'Committed (staged) files + placeholders' : 'Full scanned directory'}`); lines.push('//'); lines.push('//--- DIRECTORY STRUCTURE ---'); lines.push(generateDetailedTreeStructure(committedOnly)); lines.push('//'); lines.push('//--- SUMMARY ---');
    const fileCount = committedOnly? state.committedFiles.size: state.files.size; let totalSize = 0; const set = committedOnly? state.committedFiles: new Set(state.files.keys()); for(const p of set){ const c = state.files.get(p); if(c) totalSize += c.length; }
    lines.push(`Total Files: ${fileCount}`); lines.push(`Total Size: ${formatSize(totalSize)}`); lines.push('//'); lines.push('//--- END OF REPORT ---//'); return lines.join('\n');
  }

  function generateTreeReport(){ if(!state.fileTree) return ''; const render=(node,path='')=>{ const entries = Object.entries(node).sort(([a, aVal],[b, bVal])=>{ if(aVal.type!==bVal.type) return aVal.type==='folder'?-1:1; return a.localeCompare(b); }); let res=''; entries.forEach(([name,value],i)=>{ const full = path? `${path}/${name}`:name; const committed = state.committedFiles.has(value.path||full); if(!committed) return; const isLast = i===entries.length-1; const prefix=''; if(value.type==='folder'){ res += `${isLast?'‚îî‚îÄ‚îÄ ':'‚îú‚îÄ‚îÄ '}${name}/\n`; res += render(value.children, full); } else { const size = (state.files.get(value.path)||'').length; res += `${isLast?'‚îî‚îÄ‚îÄ ':'‚îú‚îÄ‚îÄ '}${name} (Size: ${formatSize(size)})\n`; } }); return res; };
    return render(state.fileTree,''); }

  function copyToClipboard(text, msg){ navigator.clipboard.writeText(text); showToast(msg); }

  function copyWithLineNumbers(){ if(!state.currentFile) { showToast('No file open'); return;} const content = state.files.get(state.currentFile)||''; const lines = content.split('\n'); const numbered = [`FILE: ${state.currentFile}`, `LINES: 1-${lines.length}`, '='.repeat(40), ...lines.map((l,i)=> `${i+1}: ${l}`)].join('\n'); navigator.clipboard.writeText(numbered); showToast('Copied with line numbers!'); }

  function applyPatches(){ const text = (patchInput.value||'').trim(); if(!text){ showToast('No patches to apply'); return; } try{ const patches = parsePatchText(text); let applied=0, failed=0; for(const p of patches){ if(applyPatch(p)) applied++; else failed++; } showToast(applied? (`Applied ${applied} patch(es)` + (failed?` (${failed} failed)`:'')) : 'No patches could be applied'); patchDialog.close(); patchInput.value=''; if(state.currentFile) { editor.value = state.files.get(state.currentFile)||''; renderLineNumbers(); } } catch(err){ showToast('Error: '+err.message); }
  }
  function parsePatchText(text){ const patches=[]; const lines=text.split('\n'); let i=0; while(i<lines.length){ if(lines[i].startsWith('FILE:')){ const filename = lines[i].slice(5).trim(); i++; while(i<lines.length && !/^\d+-\d+:/.test(lines[i])) i++; if(i<lines.length){ const m = lines[i].match(/^(\d+)-(\d+):/); if(m){ const start= parseInt(m[1]); const end=parseInt(m[2]); i++; const repl=[]; while(i<lines.length && !lines[i].startsWith('FILE:') && !/^\d+-\d+:/.test(lines[i])){ let line = lines[i].replace(/^\s*\d+:\s?/, ''); repl.push(line); i++; } patches.push({file:filename, startLine:start, endLine:end, replacement: repl.join('\n')}); } } } else i++; } return patches; }
  function applyPatch(patch){ if(!state.files.has(patch.file)) return false; const content = state.files.get(patch.file); const lines = content.split('\n'); if(patch.startLine <1 || patch.endLine > lines.length) return false; const newLines = [...lines.slice(0, patch.startLine-1), ...patch.replacement.split('\n'), ...lines.slice(patch.endLine)]; state.files.set(patch.file, newLines.join('\n')); return true; }

  function toggleTheme(){ state.isDark = !state.isDark; document.documentElement.classList.toggle('dark', state.isDark); localStorage.setItem('diranalyze-theme', state.isDark? 'dark':'light'); }

  /* ------------------------------- Rendering ------------------------------ */
  function renderTree(){
    treeEl.innerHTML='';
    if(!state.fileTree) return;
    const entries = Object.entries(state.fileTree).sort(([a,aVal],[b,bVal])=>{ if(aVal.type!==bVal.type) return aVal.type==='folder'?-1:1; return a.localeCompare(b); });
    for(const [name, node] of entries){ treeEl.appendChild(renderNode(name, node, name, 0)); }
  }
  function renderNode(name, node, path, depth){
    const row = document.createElement('div'); row.className='tree-item'; row.style.paddingLeft = (depth*16+8)+'px';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='checkbox';
    const label = document.createElement('span'); label.className='tree-name'; label.textContent = name;
    const sizeSpan = document.createElement('span'); sizeSpan.className='muted'; sizeSpan.style.fontSize='12px'; sizeSpan.style.marginLeft='auto';

    if(node.type==='folder'){
      cb.style.visibility='hidden';
      const icon=document.createElement('span'); icon.textContent = state.expandedFolders.has(path)? 'üìÇ':'üìÅ'; icon.style.width='18px';
      row.append(icon, label);
      row.onclick = ()=>{ if(state.expandedFolders.has(path)) state.expandedFolders.delete(path); else state.expandedFolders.add(path); renderTree(); };
      if(state.expandedFolders.has(path)){
        const children = document.createElement('div');
        const sorted = Object.entries(node.children).sort(([a,aVal],[b,bVal])=>{ if(aVal.type!==bVal.type) return aVal.type==='folder'?-1:1; return a.localeCompare(b); });
        for(const [childName, child] of sorted){ children.appendChild(renderNode(childName, child, `${path}/${childName}`, depth+1)); }
        const wrap = document.createElement('div'); wrap.append(row, children); return wrap;
      }
    } else {
      cb.checked = state.selectedFiles.has(node.path);
      cb.onclick = (e)=>{ e.stopPropagation(); toggleSelection(node.path); };
      row.onclick = ()=> openFile(node.path);
      const icon=document.createElement('span'); icon.textContent = fileEmoji(name); icon.style.width='18px';
      sizeSpan.textContent = formatSize((state.files.get(node.path)||'').length);
      row.append(cb, icon, label, sizeSpan);
    }
    return row;
  }
  function fileEmoji(filename){
    const ext = (filename.split('.').pop()||'').toLowerCase();
    const map = { js:'üìú', jsx:'‚öõÔ∏è', ts:'üìò', tsx:'‚öõÔ∏è', json:'üìã', html:'üåê', css:'üé®', md:'üìù', txt:'üìÑ', png:'üñºÔ∏è', jpg:'üñºÔ∏è', jpeg:'üñºÔ∏è', gif:'üñºÔ∏è', svg:'üé®' };
    if(filename==='.gitignore') return 'üö´'; if(filename==='package.json') return 'üì¶'; if(filename==='README.md') return 'üìñ';
    return map[ext] || 'üìÑ';
  }

  function renderLineNumbers(){ const lines = (editor.value||'').split('\n'); linenums.innerHTML = lines.map((_,i)=> `<div>${i+1}</div>`).join(''); }

  function refreshUI(){
    const hasFiles = state.files.size>0;
    sidebarEmpty.style.display = hasFiles? 'none':'block';
    sidebarControls.style.display = hasFiles? 'block':'none';
    committedBadge.textContent = `${state.committedFiles.size} committed files`;
    copyTreeBtn.disabled = state.committedFiles.size===0;

    if(state.committedFiles.size>0){ treeReportEl.style.display='block'; emptyState.style.display='none'; treeReportEl.textContent = generateTreeReport(); }
    else { treeReportEl.style.display='none'; emptyState.style.display='flex'; document.getElementById('emptyTitle').textContent = hasFiles? 'No files committed':'No files loaded'; document.getElementById('emptyDesc').textContent = hasFiles? "Select files in the sidebar and click 'Commit' to see the directory structure":"Drop a folder to get started with directory analysis"; if(hasFiles){ statsRow.style.display='flex'; totalFilesBadge.textContent=`${state.files.size} total files`; selectedFilesBadge.textContent=`${state.selectedFiles.size} selected`; } else { statsRow.style.display='none'; } }

    // Status bar
    statusFiles.textContent = `${state.files.size} files`;
    statusSelected.textContent = `${state.selectedFiles.size} selected`;
    const totalBytes = Array.from(state.committedFiles.size? state.committedFiles: state.files.keys()).reduce((acc,p)=> acc + ((state.files.get(p)||'').length), 0); statusSize.textContent = formatSize(totalBytes);

    renderTree();
  }

  function formatSize(bytes){ if(bytes<1024) return bytes+' B'; if(bytes<1024*1024) return (bytes/1024).toFixed(1)+' KB'; return (bytes/(1024*1024)).toFixed(2)+' MB'; }
  function setStatus(msg){ statusMsg.textContent = msg; }
  function showToast(msg){ toast.textContent = msg; toast.style.display='block'; setTimeout(()=> toast.style.display='none', 2000); setStatus(msg); }

  function clearProject(){ if(!confirm('Are you sure you want to clear the entire project? This cannot be undone.')) return; state.files=new Map(); state.fileTree=null; state.selectedFiles=new Set(); state.committedFiles=new Set(); state.expandedFolders=new Set(); state.currentFile=null; state.hasUnsavedChanges=false; state.view='tree'; state.filters={include:'', exclude:'node_modules,.git,dist,build,.DS_Store', showHidden:false}; state.gitignorePatterns=[]; state.placeholders=new Map(); state.lastLoaded=[]; refreshUI(); showToast('Project cleared'); }

  async function traverse(entry, files, path=''){
    return new Promise((resolve)=>{
      if(entry.isFile){ entry.file((file)=>{ Object.defineProperty(file,'webkitRelativePath',{ value: path + entry.name, configurable:true}); files.push(file); resolve(); }); }
      else if(entry.isDirectory){ const reader = entry.createReader(); reader.readEntries(async (ents)=>{ for(const e of ents){ await traverse(e, files, path+entry.name+'/'); } resolve(); }); }
      else resolve();
    });
  }
})();
</script>
</body>
</html>
