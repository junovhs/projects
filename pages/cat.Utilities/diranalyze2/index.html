<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DirAnalyze</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="tree.css">
    <script type="module" src="scan.js" defer></script>
    <script type="module" src="utils.js" defer></script>
    <script type="module">
        // Phase 2 Init: Wire events, state
        import { scanDirectory, appState } from './scan.js';
        import { showNotification, debounce, escapeHtml } from './utils.js';
        import { buildTree, renderTreeNode, loadFileContent, generateReport, updateStats, exportReport } from './tree.js'; // Phase 3 stub for now

        // State & Events
        window.appState = appState; // Global for modules

        // Drop/Select
        const dropZone = document.getElementById('dropZone');
        ['dragover', 'dragenter'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.add('dragover'); }));
        ['dragleave', 'drop'].forEach(ev => dropZone.addEventListener(ev, e => { e.preventDefault(); dropZone.classList.remove('dragover'); if (ev === 'drop') handleDirectorySelect(); }));
        document.getElementById('selectFolderBtn').addEventListener('click', handleDirectorySelect);
        async function handleDirectorySelect() {
            const loader = document.getElementById('loader');
            loader.style.display = 'block';
            try {
                const files = await scanDirectory({ mode: 'read' });
                appState.projectRootName = files.rootName || 'Root';
                appState.fullScanData.allFilesList = files.list;
                buildTree(appState.fullScanData.allFilesList);
                updateStats();
                generateReport();
                document.getElementById('dropZone').style.display = 'none';
                document.getElementById('clearProjectBtn').style.display = 'block';
                loader.style.display = 'none';
                showNotification(`Loaded: ${appState.projectRootName}`);
            } catch (err) {
                loader.style.display = 'none';
                showNotification(err.message, 'error');
            }
        }

        // Search (debounced)
        const searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', debounce((e) => {
            appState.searchTerm = e.target.value.toLowerCase();
            buildTree(appState.fullScanData.allFilesList);
            updateStats();
        }, 250));

        // Expand/Collapse
        document.getElementById('expandAllBtn').addEventListener('click', () => document.querySelectorAll('.tree-node.folder').forEach(n => { n.classList.add('open'); n.querySelector('ul').style.display = 'block'; }));
        document.getElementById('collapseAllBtn').addEventListener('click', () => document.querySelectorAll('.tree-node.folder').forEach(n => { n.classList.remove('open'); n.querySelector('ul').style.display = 'none'; }));

        // Resizer
        let isResizing = false;
        const resizer = document.getElementById('sidebarResizer');
        resizer.addEventListener('mousedown', () => { isResizing = true; resizer.classList.add('resizing'); });
        document.addEventListener('mousemove', e => { if (isResizing) { const left = document.getElementById('leftSidebar'); let w = e.clientX; w = Math.max(220, Math.min(w, window.innerWidth * 0.6)); left.style.width = w + 'px'; } });
        document.addEventListener('mouseup', () => { isResizing = false; resizer.classList.remove('resizing'); });

        // Clear
        document.getElementById('clearProjectBtn').addEventListener('click', () => {
            appState = { dirHandle: null, fullScanData: { allFilesList: [] }, filesMap: new Map(), isScaffoldMode: false, projectRootName: '', searchTerm: '' };
            document.getElementById('directoryTree').innerHTML = '';
            document.getElementById('emptyTreeNotice').style.display = 'flex';
            updateStats();
            document.getElementById('textReport').style.display = 'none';
            document.getElementById('exportReportBtn').style.display = 'none';
            document.getElementById('dropZone').style.display = 'flex';
            document.getElementById('clearProjectBtn').style.display = 'none';
            showNotification('Cleared');
        });

        // Export
        document.getElementById('exportReportBtn').addEventListener('click', exportReport);

        // Init: Hide drop if loaded, but start empty
        document.getElementById('textReport').style.display = 'none';
        document.getElementById('exportReportBtn').style.display = 'none';
        document.getElementById('clearProjectBtn').style.display = 'none';
        document.getElementById('emptyTreeNotice').style.display = 'flex';
    </script>
</head>
<body>
    <!-- Logo: Fixed to match screenshot (blue bar + folder + text) -->
    <header id="logoHeader">
        <svg width="200" height="60" viewBox="0 0 200 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect width="200" height="60" fill="#007AFF" rx="8"/>
            <path d="M5 15H30V45H5V15Z" fill="white"/>
            <text x="40" y="40" font-family="Roboto Mono, monospace" font-size="18px" fill="white">DirAnalyze</text>
        </svg>
    </header>

    <div id="appContainer">
        <aside id="leftSidebar">
            <div class="panel-header">
                <h2>DIRECTORY TREE</h2>
                <div class="tree-controls">
                    <input type="text" id="searchInput" placeholder="Search files/folders...">
                    <div style="display: flex; gap: 5px;">
                        <button class="tree-btn" id="expandAllBtn">EXPAND ALL</button>
                        <button class="tree-btn" id="collapseAllBtn">COLLAPSE ALL</button>
                    </div>
                </div>
            </div>
            <div id="generalActions">
                <button class="utility-button" id="importScaffoldBtn">IMPORT AI SCAFFOLD</button>
                <button class="utility-button" id="clearProjectBtn">CLEAR PROJECT</button>
            </div>
            <hr class="sidebar-hr">
            <ul id="directoryTree"></ul>
            <div class="empty-notice" id="emptyTreeNotice">No folder loaded</div>
        </aside>

        <div id="sidebarResizer"></div>

        <main id="mainView">
            <div id="mainAction">
                <div id="dropZone" style="align-self: flex-start; width: auto; min-width: 300px;">
                    <i class="fas fa-folder drop-icon"></i>
                    <div class="drop-text" style="font-weight: 500;">DROP FOLDER</div>
                    <div class="drop-alternative" style="color: var(--dim-color); font-weight: 400;">- OR -</div>
                    <button class="folder-select-btn" id="selectFolderBtn">SELECT FOLDER</button>
                </div>
                <div id="loader" style="display: none; align-self: flex-start;"><i class="fas fa-spinner"></i> Scanning...</div>
            </div>
            <div style="flex: 1; display: flex; flex-direction: column; border-top: 1px solid var(--border-color);">
                <div id="textReport"></div>
                <button id="exportReportBtn" class="action-button primary" style="display: none; align-self: flex-start; margin: 10px 15px;">EXPORT COMBINED TEXT</button>
            </div>
        </main>

        <aside id="rightStatsPanel">
            <div class="panel-header"><h2>STATISTICS</h2></div>
            <div id="globalStats" class="empty-notice">No data yet</div>
            <div class="file-type-stats">
                <h3>FILE TYPE BREAKDOWN</h3>
                <table id="fileTypeTable">
                    <thead><tr><th>Extension</th><th>Count</th><th>Total Size</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </aside>
    </div>

    <!-- Stub Modal for Phase 4 -->
    <div id="scaffoldImportModal" class="diff-modal" style="display: none;">
        <div class="diff-modal-content">
            <div>
                <h3>Import AI-Generated Project Scaffold</h3>
                <button class="diff-modal-close" id="closeScaffoldModalBtn">Ã—</button>
            </div>
            <div class="modal-scrollable-content">
                <p style="font-size: 0.9em; color: var(--dim-color);">Paste the JSON array of <code>create_scaffold_file</code> operations from your AI below.</p>
                <textarea id="aiScaffoldJsonInput" placeholder='[{"operation": "create_scaffold_file", "filePath": "my-project/index.html", "content": "&lt;!DOCTYPE html&gt;..."}]'></textarea>
            </div>
            <div class="diff-modal-actions">
                <button id="createProjectFromScaffoldBtn" class="action-button primary">Create Project from Scaffold</button>
                <button id="cancelScaffoldImportBtn" class="action-button secondary">Cancel</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
</body>
</html>