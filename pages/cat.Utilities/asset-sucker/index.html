<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asset Sucker — Visual Asset Downloader</title>
  <style>
    :root {
      --bg: #0b0f17; --panel: #0e1525; --card: #121a2b; --muted: #99a4b8; --text: #e6edf7;
      --brand: #7c9cff; --accent: #28d7e5; --border: #1c2740; --ring: rgba(124,156,255,.35);
      --tile: 220px;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; color: var(--text); background: var(--bg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .container { max-width: 1200px; margin: 36px auto; padding: 0 16px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border); border-radius: 18px; box-shadow: 0 16px 60px rgba(0,0,0,.35); overflow: hidden;
    }
    .header { padding: 22px 22px 12px; border-bottom: 1px solid var(--border); }
    .title { margin: 0; font-weight: 700; font-size: 22px; display: flex; gap: 10px; align-items: center; }
    .badge { font-size: 12px; color: #031126; background: linear-gradient(135deg, var(--brand), var(--accent)); padding: 4px 8px; border-radius: 999px; font-weight: 600; }
    .kicker { margin: 8px 0 0; color: var(--muted); font-size: 13px; }
    .content { padding: 18px 22px 26px; }
    .form { display: flex; gap: 10px; flex-wrap: wrap; }
    .input { flex: 1; min-width: 280px; background: #0c1221; border: 1px solid var(--border); color: var(--text); padding: 12px 14px; border-radius: 12px; outline: none; }
    .input:focus { box-shadow: 0 0 0 3px var(--ring); }
    .button { background: linear-gradient(135deg, var(--brand), var(--accent)); color: #05101f; border: none; padding: 10px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .button:disabled { opacity: .6; cursor: not-allowed; }
    .secondary { background: #0c1221; color: var(--text); border: 1px solid var(--border); }
    .toolbar { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; align-items: center; }
    .toolbar-field { display: flex; gap: 8px; align-items: center; }
    .toolbar-field>span { color: var(--muted); font-size: 12px; }
    .badge-count { background: #0c1221; border: 1px solid var(--border); color: var(--muted); padding: 3px 8px; border-radius: 999px; font-size: 12px; }
    .stats { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .tabs { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
    .tab { background: #0c1221; color: var(--text); border: 1px solid var(--border); padding: 8px 12px; border-radius: 999px; cursor: pointer; font-size: 13px; }
    .tab.active { background: linear-gradient(135deg, var(--brand), var(--accent)); color: #05101f; border: none; }
    .sep { border: none; height: 1px; background: var(--border); margin: 14px 0; }
    .empty { font-size: 14px; color: var(--muted); border: 1px dashed var(--border); background: #0b1220; padding: 16px; border-radius: 12px; text-align: center; margin-top: 8px; }
    .grid { --gap: 10px; display: grid; gap: var(--gap); grid-template-columns: repeat(auto-fill, minmax(var(--tile), 1fr)); }
    .tile { position: relative; border: 1px solid var(--border); background: #0d1527; border-radius: 14px; overflow: hidden; cursor: pointer; }
    .thumb { position: relative; width: 100%; aspect-ratio: 1/1; background: #0c1221; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .chip { position: absolute; top: 8px; left: 8px; background: rgba(5,16,31,.7); color: var(--muted); font-size: 11px; padding: 4px 6px; border-radius: 6px; border: 1px solid var(--border); backdrop-filter: blur(4px); }
    .tile .footer { position: absolute; inset: auto 0 0 0; padding: 10px 12px; background: linear-gradient(180deg, rgba(5,16,31,0) 0%, rgba(5,16,31,.7) 55%, rgba(5,16,31,.9) 100%); opacity: 0; transition: opacity .16s ease; pointer-events: none; }
    .tile:hover .footer { opacity: 1; }
    .row { display: flex; gap: 10px; align-items: center; justify-content: space-between; }
    .meta { display: grid; gap: 2px; min-width: 0; }
    .name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .sub { font-size: 11.5px; color: var(--muted); }
    .btn { font-size: 12px; padding: 6px 8px; border-radius: 8px; text-decoration: none; background: #0e162a; color: var(--text); border: 1px solid var(--border); pointer-events: auto; }
    .btn:hover { filter: brightness(1.15); }
    .lightbox { position: fixed; inset: 0; background: rgba(4,10,20,.85); display: flex; align-items: center; justify-content: center; padding: 24px; z-index: 50; }
    .lb-card { width: min(92vw, 1200px); background: #121a2b; border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 20px 80px rgba(0,0,0,.6); }
    .lb-head { display: flex; justify-content: space-between; align-items: center; padding: 12px 14px; border-bottom: 1px solid var(--border); }
    .lb-title { font-size: 14px; white-space: nowrap; overflow: auto; max-width: 70%; }
    .lb-actions { display: flex; gap: 8px; }
    .lb-body { position: relative; background: #0b1220; display: grid; place-items: center; max-height: 80vh; }
    .lb-body img { max-width: 100%; max-height: 80vh; display: block; }
    .navbtn { position: absolute; top: 50%; transform: translateY(-50%); border: 1px solid var(--border); background: #0e162a; color: var(--text); border-radius: 10px; padding: 10px 12px; cursor: pointer; }
    .navbtn:hover { filter: brightness(1.2); }
    .navprev { left: 12px; } .navnext { right: 12px; }
    .lb-close { background: #0e162a; color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 8px 10px; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h1 class="title">Asset Sucker <span class="badge">visual assets → ZIP</span></h1>
      <p class="kicker">Paste a URL. We’ll grab images, SVGs, GIFs, icons, and CSS background images — then bundle them.</p>
    </div>
    <div class="content">
      <div class="form">
        <input class="input" id="url-input" type="url" placeholder="https://example.com">
        <button class="button" id="scan-btn">Scan</button>
        <button class="button secondary" id="download-btn" disabled>Download ZIP</button>
      </div>
      <div class="toolbar">
        <label class="toolbar-field"><span>Max assets</span><input type="number" class="input" id="limit-input" min="10" max="300" value="120" style="width: 120px;"></label>
        <label class="toolbar-field"><span>Filter</span><input type="text" class="input" id="filter-input" placeholder="filename or domain…" disabled style="width: 220px;"></label>
        <label class="toolbar-field" title="Tile size"><span>Density</span><input type="range" id="density-slider" min="160" max="320" value="220"></label>
      </div>
      <div class="stats" id="stats-bar" style="display: none;"></div>
      <div class="tabs" id="tabs-bar"></div>
      <hr class="sep">
      <div id="grid-container">
        <div class="empty">Nothing yet. Paste a URL and click Scan.</div>
      </div>
    </div>
  </div>
</div>
<div class="lightbox" id="lightbox" style="display: none;"></div>

<script type="module">
  // --- State ---
  let loading = false;
  let allAssets = [];
  let counts = null;
  let activeTab = 'all';
  let filterQuery = '';
  let lightboxIndex = null;
  let errorMessage = '';
  
  // --- DOM Elements ---
  const $ = (s) => document.querySelector(s);
  const urlInput = $('#url-input');
  const limitInput = $('#limit-input');
  const scanBtn = $('#scan-btn');
  const downloadBtn = $('#download-btn');
  const filterInput = $('#filter-input');
  const densitySlider = $('#density-slider');
  const statsBar = $('#stats-bar');
  const tabsBar = $('#tabs-bar');
  const gridContainer = $('#grid-container');
  const lightbox = $('#lightbox');

  // --- Helpers ---
  const fileNameFromUrl = (raw) => { try { const u = new URL(raw); return (u.pathname.split('/').pop() || u.hostname); } catch { return raw; } };
  const hostFromUrl = (raw) => { try { return new URL(raw).hostname; } catch { return ''; } };
  const extFromUrl = (raw) => { try { const m = /\.([a-z0-9]+)$/i.exec(new URL(raw).pathname); return m ? m[1].toLowerCase() : ''; } catch { return ''; } };
  const getFilteredAssets = () => {
    const lower = filterQuery.trim().toLowerCase();
    return allAssets.filter(a => {
      if (activeTab !== 'all' && a.category !== activeTab) return false;
      if (!lower) return true;
      try {
        const u = new URL(a.url);
        const name = (u.pathname.split('/').pop() || '').toLowerCase();
        return u.hostname.toLowerCase().includes(lower) || name.includes(lower);
      } catch { return a.url.toLowerCase().includes(lower); }
    });
  };

  // --- Rendering ---
  function render() {
    // Update UI controls
    [urlInput, limitInput, scanBtn, downloadBtn, filterInput, ...tabsBar.children].forEach(el => el.disabled = loading);
    scanBtn.textContent = loading ? 'Working...' : 'Scan';
    downloadBtn.textContent = loading ? '…' : 'Download ZIP';
    if (!loading) {
      downloadBtn.disabled = !urlInput.value || allAssets.length === 0;
      filterInput.disabled = allAssets.length === 0;
    }

    // Render Stats
    if (counts) {
      statsBar.style.display = 'flex';
      statsBar.innerHTML = `
        <span class="badge-count">${allAssets.length} total</span>
        ${Object.entries(counts).map(([k,v]) => v > 0 ? `<span class="badge-count">${k} ${v}</span>` : '').join('')}
      `;
    } else {
      statsBar.style.display = 'none';
    }

    // Render Tabs
    tabsBar.innerHTML = ['all', 'images', 'svgs', 'gifs', 'icons', 'others'].map(key => `
      <button class="tab ${activeTab === key ? 'active' : ''}" data-tab="${key}" ${allAssets.length === 0 ? 'disabled' : ''}>
        ${key.charAt(0).toUpperCase() + key.slice(1)}
      </button>
    `).join('');
    
    // Render Grid or Error
    if (errorMessage) {
      gridContainer.innerHTML = `<div class="empty" style="color: #ff9a9a;"><b>Error:</b> ${errorMessage}</div>`;
      return;
    }

    const filtered = getFilteredAssets();
    if (filtered.length > 0) {
      gridContainer.innerHTML = `<div class="grid" role="list">${filtered.map((a, i) => {
        const proxied = `/api/asset-sucker/proxy?url=${encodeURIComponent(a.url)}`;
        const name = fileNameFromUrl(a.url);
        const host = hostFromUrl(a.url);
        const ext = extFromUrl(a.url) || a.category;
        return `
          <div class="tile" role="listitem" data-index="${i}">
            <div class="thumb"><img src="${proxied}" alt="" loading="lazy"><div class="chip">${ext}</div></div>
            <div class="footer">
              <div class="row">
                <div class="meta"><div class="name" title="${name}">${name}</div><div class="sub">${a.category} • ${host || 'external'}</div></div>
                <div class="lb-actions">
                  <a class="btn" href="${a.url}" target="_blank" rel="noreferrer">Open</a>
                  <a class="btn" href="${proxied}&download=1">Save</a>
                  <button class="btn" data-copy-url="${a.url}" title="Copy original URL">Copy URL</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('')}</div>`;
    } else {
      gridContainer.innerHTML = `<div class="empty">${allAssets.length === 0 ? 'Nothing yet. Paste a URL and click Scan.' : 'No matches for this filter.'}</div>`;
    }
  }

  // --- Lightbox ---
  function openLightbox(index) {
    lightboxIndex = index;
    const filtered = getFilteredAssets();
    const asset = filtered[lightboxIndex];
    if (!asset) { closeLightbox(); return; }
    
    const proxied = `/api/asset-sucker/proxy?url=${encodeURIComponent(asset.url)}`;
    lightbox.innerHTML = `
      <div class="lb-card">
        <div class="lb-head">
          <div class="lb-title">${fileNameFromUrl(asset.url)}</div>
          <div class="lb-actions">
            <a class="btn" href="${asset.url}" target="_blank" rel="noreferrer">Open</a>
            <a class="btn" href="${proxied}&download=1">Download</a>
            <button class="lb-close">Close</button>
          </div>
        </div>
        <div class="lb-body">
          <img src="${proxied}" alt="" loading="eager">
          ${lightboxIndex > 0 ? `<button class="navbtn navprev">←</button>` : ''}
          ${lightboxIndex < filtered.length - 1 ? `<button class="navbtn navnext">→</button>` : ''}
        </div>
      </div>
    `;
    lightbox.style.display = 'flex';
  }
  
  function closeLightbox() {
    lightboxIndex = null;
    lightbox.style.display = 'none';
  }

  // --- API Calls ---
  async function scan() {
    loading = true;
    allAssets = [];
    counts = null;
    errorMessage = '';
    render();

    try {
      const res = await fetch('/api/asset-sucker/scrape', {
        method: 'POST', headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ url: urlInput.value, limit: limitInput.value })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to scrape');
      allAssets = data.assets;
      counts = data.counts;
      activeTab = 'all';
      filterInput.value = '';
      filterQuery = '';
    } catch (e) {
      console.error(e);
      errorMessage = e?.message || 'Something went wrong. Check the console for details.';
    } finally {
      loading = false;
      render();
    }
  }

  async function downloadZip() {
    loading = true; render();
    try {
      const res = await fetch('/api/asset-sucker/download', {
        method: 'POST', headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ url: urlInput.value, limit: limitInput.value })
      });
      if (!res.ok) {
        const j = await res.json().catch(() => ({}));
        throw new Error(j.error || `Download failed: ${res.statusText}`);
      }
      const blob = await res.blob();
      const a = document.createElement('a');
      const host = hostFromUrl(urlInput.value) || 'site';
      a.href = URL.createObjectURL(blob);
      a.download = `assets_${host}.zip`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      errorMessage = e.message; // Show download errors too
    } finally {
      loading = false; render();
    }
  }

  // --- Event Listeners ---
  scanBtn.addEventListener('click', scan);
  downloadBtn.addEventListener('click', downloadZip);
  densitySlider.addEventListener('input', (e) => {
    document.documentElement.style.setProperty('--tile', `${e.target.value}px`);
  });
  filterInput.addEventListener('input', (e) => {
    filterQuery = e.target.value;
    render();
  });
  tabsBar.addEventListener('click', (e) => {
    if (e.target.classList.contains('tab')) {
      activeTab = e.target.dataset.tab;
      render();
    }
  });
  gridContainer.addEventListener('click', (e) => {
    const tile = e.target.closest('.tile');
    const copyBtn = e.target.closest('[data-copy-url]');
    if (copyBtn) {
      navigator.clipboard.writeText(copyBtn.dataset.copyUrl);
      return;
    }
    if (e.target.closest('a, button')) return; // ignore actions
    if (tile) openLightbox(parseInt(tile.dataset.index, 10));
  });
  lightbox.addEventListener('click', (e) => {
    if (e.target.closest('.lb-close')) { closeLightbox(); }
    else if (e.target.closest('.navprev')) { openLightbox(lightboxIndex - 1); }
    else if (e.target.closest('.navnext')) { openLightbox(lightboxIndex + 1); }
    else if (!e.target.closest('.lb-card')) { closeLightbox(); }
  });
  window.addEventListener('keydown', (e) => {
    if (lightboxIndex === null) return;
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight' && lightboxIndex < getFilteredAssets().length - 1) openLightbox(lightboxIndex + 1);
    if (e.key === 'ArrowLeft' && lightboxIndex > 0) openLightbox(lightboxIndex - 1);
  });

  // --- Initial Render ---
  render();
</script>
</body>
</html>