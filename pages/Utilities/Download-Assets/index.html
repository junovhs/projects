<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Download Assets — Web + Your PDF Extractor</title>
<style>
  :root{--bg:#0b0f17;--panel:#0e1525;--card:#121a2b;--muted:#99a4b8;--text:#e6edf7;--brand:#7c9cff;--accent:#28d7e5;--border:#1c2740;--ring:rgba(124,156,255,.35);--tile:220px}
  *{box-sizing:border-box} html,body{height:100%} body{margin:0;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
  .container{max-width:1200px;margin:36px auto;padding:0 16px}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.01));border:1px solid var(--border);border-radius:18px;box-shadow:0 16px 60px rgba(0,0,0,.35);overflow:hidden}
  .header{padding:22px 22px 12px;border-bottom:1px solid var(--border)}
  .title{margin:0;font-weight:700;font-size:22px;display:flex;gap:10px;align-items:center}
  .badge{font-size:12px;color:#031126;background:linear-gradient(135deg,var(--brand),var(--accent));padding:4px 8px;border-radius:999px;font-weight:600}
  .kicker{margin:8px 0 0;color:var(--muted);font-size:13px}
  .content{padding:18px 22px 26px}
  .form{display:flex;gap:10px;flex-wrap:wrap}
  .input{flex:1;min-width:220px;background:#0c1221;border:1px solid var(--border);color:var(--text);padding:12px 14px;border-radius:12px;outline:none}
  .input:focus{box-shadow:0 0 0 3px var(--ring)}
  .button{background:linear-gradient(135deg,var(--brand),var(--accent));color:#05101f;border:none;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .button:disabled{opacity:.6;cursor:not-allowed}
  .secondary{background:#0c1221;color:var(--text);border:1px solid var(--border)}
  .toolbar{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;align-items:center}
  .toolbar-field{display:flex;gap:8px;align-items:center}
  .toolbar-field>span{color:var(--muted);font-size:12px}
  .badge-count{background:#0c1221;border:1px solid var(--border);color:var(--muted);padding:3px 8px;border-radius:999px;font-size:12px}
  .tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
  .tab{background:#0c1221;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer;font-size:13px}
  .tab.active{background:linear-gradient(135deg,var(--brand),var(--accent));color:#05101f;border:none}
  .sep{border:none;height:1px;background:var(--border);margin:14px 0}
  .empty{font-size:14px;color:var(--muted);border:1px dashed var(--border);background:#0b1220;padding:16px;border-radius:12px;text-align:center;margin-top:8px}
  .grid{--gap:10px;display:grid;gap:var(--gap);grid-template-columns:repeat(auto-fill,minmax(var(--tile),1fr))}
  .tile{position:relative;border:1px solid var(--border);background:#0d1527;border-radius:14px;overflow:hidden;cursor:pointer}
  .thumb{position:relative;width:100%;aspect-ratio:1/1;background:#0c1221}
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .chip{position:absolute;top:8px;left:8px;background:rgba(5,16,31,.7);color:var(--muted);font-size:11px;padding:4px 6px;border-radius:6px;border:1px solid var(--border)}
  .tile .footer{position:absolute;inset:auto 0 0 0;padding:10px 12px;background:linear-gradient(180deg,rgba(5,16,31,0) 0%,rgba(5,16,31,.7) 55%,rgba(5,16,31,.9) 100%);opacity:0;transition:opacity .16s ease;pointer-events:none}
  .tile:hover .footer{opacity:1}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
  .meta{display:grid;gap:2px;min-width:0}
  .name{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .sub{font-size:11.5px;color:var(--muted)}
  .btn{font-size:12px;padding:6px 8px;border-radius:8px;text-decoration:none;background:#0e162a;color:var(--text);border:1px solid var(--border)}
  .btn:hover{filter:brightness(1.15)}
  .lightbox{position:fixed;inset:0;background:rgba(4,10,20,.85);display:none;align-items:center;justify-content:center;padding:24px;z-index:50}
  .lb-card{width:min(92vw,1200px);background:#121a2b;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 20px 80px rgba(0,0,0,.6)}
  .lb-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border)}
  .lb-title{font-size:14px;white-space:nowrap;overflow:auto;max-width:70%}
  .lb-actions{display:flex;gap:8px}
  .lb-body{position:relative;background:#0b1220;display:grid;place-items:center;max-height:80vh}
  .lb-body img{max-width:100%;max-height:80vh;display:block}
  .navbtn{position:absolute;top:50%;transform:translateY(-50%);border:1px solid var(--border);background:#0e162a;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .navprev{left:12px} .navnext{right:12px} .lb-close{background:#0e162a;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer}
  .hint{font-size:12px;color:var(--muted)}
  .logs{display:none;margin-top:12px;background:#0b1220;border:1px solid var(--border);border-radius:12px;max-height:240px;overflow:auto;padding:10px;font:12px ui-monospace,Consolas,Menlo,monospace}
  .logs.active{display:block}
  .progress{display:none;margin:8px 0;height:8px;background:#0e162a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
  .progress.active{display:block}
  .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--accent))}
  .progress-text{margin-left:8px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h1 class="title">Download Assets <span class="badge">web + your pdf extractor</span></h1>
      <p class="kicker">URL scraper (incl. <code>&lt;use&gt;</code> SVGs) + your exact aggressive PDF byte scanner.</p>
    </div>
    <div class="content">
      <div class="form">
        <input class="input" id="url-input" type="url" placeholder="https://example.com">
        <input class="input" id="file-input" type="file" accept="application/pdf" style="max-width:320px">
        <button class="button" id="scan-btn">Scan</button>
        <button class="button secondary" id="download-btn" disabled>Download ZIP</button>
      </div>
      <div class="toolbar">
        <label class="toolbar-field"><span>Max assets</span><input class="input" id="limit-input" type="number" min="10" max="300" value="120" style="width:120px"></label>
        <label class="toolbar-field"><span>Filter</span><input class="input" id="filter-input" placeholder="filename or domain…" disabled style="width:220px"></label>
        <label class="toolbar-field" title="Tile size"><span>Density</span><input type="range" id="density-slider" min="160" max="320" value="220"></label>
        <label class="toolbar-field"><input type="checkbox" id="snapshots-toggle" checked> <span>Page snapshots</span></label>
        <label class="toolbar-field"><input type="checkbox" id="showlog-toggle"> <span>Show PDF log</span></label>
        <span class="hint" id="source-hint">Source: URL</span><span class="hint" id="status-hint">Idle</span>
      </div>
      <div class="progress" id="progress"><div class="bar" id="progressBar"></div></div>
      <div class="progress-text" id="progressText"></div>
      <div class="logs" id="log"></div>

      <div class="stats" id="stats-bar" style="display:none"></div>
      <div class="tabs" id="tabs-bar"></div>
      <hr class="sep">
      <div id="grid-container"><div class="empty">Nothing yet. Paste a URL or choose a PDF, then click Scan.</div></div>
    </div>
  </div>
</div>
<div class="lightbox" id="lightbox"></div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script type="module">
  import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.mjs";
  pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.mjs";

  /* ========== STATE / DOM ========== */
  let loading=false, allAssets=[], counts=null, activeTab='all', lightboxIndex=null, errorMessage='', filterQuery='';
  const $=s=>document.querySelector(s);
  const urlInput=$('#url-input'), fileInput=$('#file-input'), scanBtn=$('#scan-btn'), downloadBtn=$('#download-btn'), limitInput=$('#limit-input'), filterInput=$('#filter-input'), densitySlider=$('#density-slider'), statsBar=$('#stats-bar'), tabsBar=$('#tabs-bar'), gridContainer=$('#grid-container'), lightbox=$('#lightbox'), sourceHint=$('#source-hint'), statusHint=$('#status-hint'), snapshotsToggle=$('#snapshots-toggle'), showlogToggle=$('#showlog-toggle'), logEl=$('#log'), prog=$('#progress'), progBar=$('#progressBar'), progText=$('#progressText');

  /* ========== HELPERS ========== */
  const setStatus=t=>statusHint.textContent=t||'';
  const isDataOrBlob=u=>/^data:|^blob:/i.test(u||'');
  const proxify=u=>isDataOrBlob(u)?u:`/api/asset-sucker/proxy?url=${encodeURIComponent(u)}`;
  const dataURLtoUint8=u=>{const b64=u.split(',')[1];const bin=atob(b64);const a=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)a[i]=bin.charCodeAt(i);return a};
  const fileNameFromUrl=raw=>{try{const u=new URL(raw);return(u.pathname.split('/').pop()||u.hostname)}catch{return raw}};
  const extFromUrl=raw=>{try{const m=/\.([a-z0-9]+)$/i.exec(new URL(raw).pathname);return m?m[1].toLowerCase():''}catch{return''}};
  const byTab=a=>{const q=(filterQuery||'').toLowerCase().trim();return a.filter(x=>{if(activeTab!=='all'&&x.category!==activeTab)return false;if(!q)return true;if(isDataOrBlob(x.url))return (x.name||'').toLowerCase().includes(q);try{const u=new URL(x.url);const name=(u.pathname.split('/').pop()||'').toLowerCase();return u.hostname.toLowerCase().includes(q)||name.includes(q)}catch{return (x.url||'').toLowerCase().includes(q)}})};
  const countByCat=a=>{const c={pages:0,images:0,svgs:0,gifs:0,icons:0,others:0};a.forEach(x=>c[x.category]=(c[x.category]||0)+1);return c};

  /* ========== RENDER ========== */
  function render(){
    const sourceType=fileInput.files.length?'pdf':(urlInput.value?'url':'none'); sourceHint.textContent=`Source: ${sourceType.toUpperCase()}`;
    [urlInput,fileInput,limitInput,scanBtn,downloadBtn,filterInput,densitySlider,snapshotsToggle,showlogToggle,...tabsBar.children].forEach(el=>el.disabled=loading);
    scanBtn.textContent=loading?'Working...':'Scan'; downloadBtn.textContent=loading?'…':'Download ZIP';
    filterInput.disabled=allAssets.length===0; downloadBtn.disabled=loading||(!allAssets.length);
    logEl.classList.toggle('active', showlogToggle.checked);
    (loading&&sourceType==='pdf')?prog.classList.add('active'):prog.classList.remove('active');
    if(counts){statsBar.style.display='flex';statsBar.innerHTML=`<span class="badge-count">${allAssets.length} total</span>${Object.entries(counts).map(([k,v])=>v?`<span class="badge-count">${k} ${v}</span>`:'').join('')}`}else{statsBar.style.display='none'}
    const tabs=['all','pages','images','svgs','gifs','icons','others']; tabsBar.innerHTML=tabs.map(k=>`<button class="tab ${activeTab===k?'active':''}" data-tab="${k}" ${allAssets.length===0?'disabled':''}>${k[0].toUpperCase()+k.slice(1)}</button>`).join('');
    if(errorMessage){gridContainer.innerHTML=`<div class="empty" style="color:#ff9a9a"><b>Error:</b> ${errorMessage}</div>`;return}
    const filtered=byTab(allAssets);
    if(!filtered.length){gridContainer.innerHTML=`<div class="empty">${allAssets.length?'No matches for this filter.':'Nothing yet. Paste a URL or choose a PDF, then click Scan.'}</div>`;return}
    gridContainer.innerHTML=`<div class="grid">${filtered.map((a,i)=>{const src=proxify(a.url);const name=a.name||fileNameFromUrl(a.url);const ext=a.ext||extFromUrl(a.url)||a.category;const open=isDataOrBlob(a.url)?a.url:a.url;const save=isDataOrBlob(a.url)?a.url:`${src}&download=1`;return`
      <div class="tile" data-index="${i}">
        <div class="thumb"><img src="${src}" loading="lazy"><div class="chip">${ext}</div></div>
        <div class="footer"><div class="row">
          <div class="meta"><div class="name" title="${name}">${name}</div><div class="sub">${a.category} • ${a.w||'?'}×${a.h||'?'}</div></div>
          <div class="lb-actions">
            <a class="btn" href="${open}" target="_blank" ${isDataOrBlob(a.url)?'download':''}>Open</a>
            <a class="btn" href="${save}" ${isDataOrBlob(a.url)?'download':''}>Save</a>
          </div>
        </div></div>
      </div>`}).join('')}</div>`;
  }

  /* ========== LIGHTBOX ========== */
  function openLightbox(idx){
    const filtered=byTab(allAssets); const a=filtered[idx]; if(!a){closeLightbox();return}
    const src=proxify(a.url);
    lightbox.innerHTML=`
      <div class="lb-card">
        <div class="lb-head">
          <div class="lb-title">${a.name||fileNameFromUrl(a.url)}</div>
          <div class="lb-actions">
            <a class="btn" href="${isDataOrBlob(a.url)?a.url:a.url}" target="_blank" ${isDataOrBlob(a.url)?'download':''}>Open</a>
            <a class="btn" href="${isDataOrBlob(a.url)?a.url:`${src}&download=1`}" ${isDataOrBlob(a.url)?'download':''}>Download</a>
            <button class="lb-close">Close</button>
          </div>
        </div>
        <div class="lb-body">
          <img src="${src}">
          <button class="navbtn navprev">←</button>
          <button class="navbtn navnext">→</button>
        </div>
      </div>`;
    lightbox.style.display='flex';
    lightbox.querySelector('.navprev').onclick=()=>openLightbox(Math.max(0,idx-1));
    lightbox.querySelector('.navnext').onclick=()=>openLightbox(Math.min(byTab(allAssets).length-1,idx+1));
    lightbox.querySelector('.lb-close').onclick=closeLightbox;
  }
  const closeLightbox=()=>lightbox.style.display='none';

  /* ========== ACTION: SCAN ========== */
  scanBtn.addEventListener('click', async ()=>{
    errorMessage=''; allAssets=[]; counts=null; render();
    const sourceType=fileInput.files.length?'pdf':(urlInput.value?'url':'none');
    try{
      if(sourceType==='pdf'){ await runPdfExtractor(fileInput.files[0]) }
      else if(sourceType==='url'){
        setStatus('Scraping…');
        const limit=Number(limitInput.value||120), url=urlInput.value;
        const res=await fetch('/api/assets/discover',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({url,limit})});
        const data=await res.json().catch(()=>({})); if(!res.ok) throw new Error(data.error||`Failed to scrape (${res.status})`);
        const html=await (await fetch(proxify(url))).text().catch(()=>null);
        const extras=html? await extractUseSvgsFromHtml(html,url) : [];
        allAssets=[...(data.assets||[]),...extras]; counts=countByCat(allAssets);
      } else throw new Error('Provide a URL or choose a PDF first.');
    }catch(e){ errorMessage=e.message||String(e) }
    render();
  });

  /* ========== PDF: YOUR LOGIC, verbatim ========== */
  let extractedImages=[], currentFileName='';
  function log(message,type='info'){
    if(!showlogToggle.checked) return;
    const time=new Date().toLocaleTimeString(); const line=document.createElement('div'); line.textContent=`[${time}] ${message}`;
    line.style.color= type==='success'?'#22c55e': type==='warning'?'#f59e0b': type==='error'?'#ef4444':'#7dd3fc';
    logEl.appendChild(line); logEl.scrollTop=logEl.scrollHeight;
  }
  function updateProgress(percent,text){ prog.classList.add('active'); progBar.style.width=percent+'%'; progText.textContent=text||percent+'%' }

  async function runPdfExtractor(file){
    loading=true; setStatus('Reading PDF…'); render();
    try{
      currentFileName=file.name.replace(/\.pdf$/i,''); extractedImages=[]; logEl.innerHTML='';
      updateProgress(10,'Reading file...');
      const arrayBuffer=await file.arrayBuffer(); const bytes=new Uint8Array(arrayBuffer);
      log(`Loaded ${bytes.length} bytes`,'info');

      if(snapshotsToggle.checked){ await addPdfSnapshots(arrayBuffer,currentFileName) }

      updateProgress(20,'Scanning for JPEGs...'); await findJPEGs(bytes);
      updateProgress(40,'Scanning for PNGs...'); await findPNGs(bytes);
      updateProgress(60,'Parsing PDF objects...'); await findPDFImages(bytes);
      updateProgress(80,'Finding inline images...'); await findInlineImages(bytes);
      updateProgress(90,'Extracting streams...'); await extractStreams(bytes);
      updateProgress(100,'Complete!');

      // map your results to grid
      const mapped = extractedImages.map((img, idx)=>{
        const base = `${currentFileName}_${img.name}`;
        const ext = img.format.toLowerCase().startsWith('png')?'png':'jpg';
        return { url: img.url, category:'images', name:`${base}.${ext}`, ext, w: img.width||null, h: img.height||null, source:'pdf' };
      });
      allAssets=[...allAssets, ...mapped]; counts=countByCat(allAssets);
      setTimeout(()=>prog.classList.remove('active'),1200);
      setStatus('Done');
    } finally { loading=false }
  }

  // --- your functions, unchanged except minimal scoping ---
  async function findJPEGs(bytes){
    log('Scanning for JPEG images...','info'); let count=0;
    for(let i=0;i<bytes.length-10;i++){
      if(bytes[i]===0xFF && bytes[i+1]===0xD8){
        let end=-1; for(let j=i+2;j<bytes.length-1;j++){ if(bytes[j]===0xFF && bytes[j+1]===0xD9){ end=j+2; break } }
        if(end>i && end-i>1000){
          const jpegData=bytes.slice(i,end); const blob=new Blob([jpegData],{type:'image/jpeg'}); const url=URL.createObjectURL(blob);
          const img=new Image();
          await new Promise(resolve=>{
            img.onload=()=>{ count++; extractedImages.push({url,blob,width:img.naturalWidth,height:img.naturalHeight,format:'JPEG',size:jpegData.length,name:`jpeg_${count}`}); log(`✓ Found JPEG #${count}: ${img.naturalWidth}x${img.naturalHeight} (${(jpegData.length/1024).toFixed(1)}KB)`,'success'); resolve() };
            img.onerror=resolve; img.src=url;
          });
          i=end-1;
        }
      }
    }
    log(`Found ${count} JPEG images`, count?'success':'warning');
  }
  async function findPNGs(bytes){
    log('Scanning for PNG images...','info'); let count=0;
    const PNG=[0x89,0x50,0x4E,0x47,0x0D,0x0A,0x1A,0x0A];
    for(let i=0;i<bytes.length-8;i++){
      let is=true; for(let j=0;j<8;j++){ if(bytes[i+j]!==PNG[j]){ is=false; break } }
      if(is){
        let end=-1; for(let j=i+8;j<bytes.length-8;j++){ if(bytes[j]===0x49&&bytes[j+1]===0x45&&bytes[j+2]===0x4E&&bytes[j+3]===0x44){ end=j+8; break } }
        if(end>i){
          const pngData=bytes.slice(i,end); const blob=new Blob([pngData],{type:'image/png'}); const url=URL.createObjectURL(blob);
          const img=new Image();
          await new Promise(resolve=>{
            img.onload=()=>{ count++; extractedImages.push({url,blob,width:img.naturalWidth,height:img.naturalHeight,format:'PNG',size:pngData.length,name:`png_${count}`}); log(`✓ Found PNG #${count}: ${img.naturalWidth}x${img.naturalHeight} (${(pngData.length/1024).toFixed(1)}KB)`,'success'); resolve() };
            img.onerror=resolve; img.src=url;
          });
          i=end-1;
        }
      }
    }
    log(`Found ${count} PNG images`, count?'success':'warning');
  }
  async function findPDFImages(bytes){
    log('Parsing PDF structure for images...','info');
    const text=new TextDecoder('latin1').decode(bytes);
    const objPattern=/(\d+)\s+\d+\s+obj([\s\S]*?)endobj/g; let match; let count=0;
    while((match=objPattern.exec(text))!==null){
      const objContent=match[0];
      if((objContent.includes('/Type /XObject')&&objContent.includes('/Subtype /Image'))||objContent.includes('/Filter /DCTDecode')||objContent.includes('/Filter /FlateDecode')){
        count++;
        if(objContent.includes('stream')){
          const streamStart=objContent.indexOf('stream')+6;
          const streamEnd=objContent.indexOf('endstream');
          if(streamEnd>streamStart){
            const absoluteStart=match.index+streamStart;
            const absoluteEnd=match.index+streamEnd;
            let start=absoluteStart; while(bytes[start]===0x0A||bytes[start]===0x0D||bytes[start]===0x20) start++;
            const streamData=bytes.slice(start,absoluteEnd);
            if(streamData.length>100) await processImageStream(streamData, `pdf_obj_${match[1]}`);
          }
        }
      }
    }
    log(`Processed ${count} PDF image objects`,'info');
  }
  async function findInlineImages(bytes){
    log('Searching for inline images...','info');
    const text=new TextDecoder('latin1').decode(bytes);
    let count=0, pos=0;
    while(pos<text.length){
      const biPos=text.indexOf('BI',pos); if(biPos===-1) break;
      const idPos=text.indexOf('ID',biPos); if(idPos===-1||idPos-biPos>1000){ pos=biPos+2; continue }
      const eiPos=text.indexOf('EI',idPos); if(eiPos===-1||eiPos-idPos>100000){ pos=biPos+2; continue }
      count++; const imageDataStart=idPos+2; const imageData=bytes.slice(imageDataStart,eiPos);
      if(imageData.length>50) await processImageStream(imageData,`inline_${count}`);
      pos=eiPos+2;
    }
    log(`Found ${count} inline images`, count?'success':'warning');
  }
  async function extractStreams(bytes){
    log('Extracting all stream objects...','info');
    const text=new TextDecoder('latin1').decode(bytes);
    let count=0, pos=0;
    while(pos<text.length){
      const streamPos=text.indexOf('stream',pos); if(streamPos===-1) break;
      const endPos=text.indexOf('endstream',streamPos); if(endPos===-1) break;
      let start=streamPos+6; while(bytes[start]===0x0A||bytes[start]===0x0D||bytes[start]===0x20) start++;
      const streamData=bytes.slice(start,endPos);
      if(streamData.length>1000){ count++; await processImageStream(streamData,`stream_${count}`) }
      pos=endPos+9;
    }
    log(`Processed ${count} stream objects`,'info');
  }
  async function processImageStream(data,name){
    if(data[0]===0xFF && data[1]===0xD8){ const blob=new Blob([data],{type:'image/jpeg'}); await addImage(blob,'JPEG',name) }
    else if(data[0]===0x89 && data[1]===0x50){ const blob=new Blob([data],{type:'image/png'}); await addImage(blob,'PNG',name) }
  }
  async function addImage(blob,format,name){
    const url=URL.createObjectURL(blob); const img=new Image();
    return new Promise(resolve=>{
      img.onload=()=>{ extractedImages.push({url,blob,width:img.naturalWidth,height:img.naturalHeight,format,size:blob.size,name}); resolve(true) };
      img.onerror=()=>{ URL.revokeObjectURL(url); resolve(false) };
      img.src=url;
    });
  }
  async function addPdfSnapshots(arrayBuffer, base){
    const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise; const scale=2;
    for(let p=1;p<=pdf.numPages;p++){
      setStatus(`Rendering page ${p}/${pdf.numPages}…`);
      const page=await pdf.getPage(p); const viewport=page.getViewport({scale});
      const c=document.createElement('canvas'); const ctx=c.getContext('2d',{willReadFrequently:true});
      c.width=viewport.width; c.height=viewport.height; await page.render({canvasContext:ctx,viewport}).promise;
      allAssets.push({url:c.toDataURL('image/png'),category:'pages',name:`${base}_page_${String(p).padStart(3,'0')}.png`,ext:'png',w:c.width,h:c.height,source:'pdf'});
    }
  }

  /* ========== Web: <use> SVG resolver ========== */
  async function extractUseSvgsFromHtml(html, baseUrl){
    const doc=new DOMParser().parseFromString(html,'text/html'); const vars=await collectCssVars(doc,baseUrl); const svgs=[];
    for(const use of doc.querySelectorAll('svg use')){
      const href=use.getAttribute('href')||use.getAttribute('xlink:href')||''; if(!href) continue;
      const [spriteUrl, frag]=href.includes('#')?href.split('#'):[ '', href.replace(/^#/,'') ]; if(!frag) continue;
      try{
        const srcDoc = spriteUrl ? await fetchSvgDoc(new URL(spriteUrl,baseUrl).href) : parseInlineSprite(doc);
        const node = srcDoc.getElementById(frag); if(!node) continue;
        const vb = node.getAttribute('viewBox') || srcDoc.documentElement.getAttribute('viewBox') || '';
        const xml = standaloneSvgXml(node, vb, srcDoc, vars);
        const data='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(xml);
        svgs.push({url:data,name:`${frag}.svg`,category:'svgs',ext:'svg',w:null,h:null,source:'sprite'});
      }catch{}
    }
    return svgs;
  }
  async function fetchSvgDoc(url){ const txt=await (await fetch(proxify(url))).text(); return new DOMParser().parseFromString(txt,'image/svg+xml') }
  function parseInlineSprite(doc){ const svg=doc.querySelector('svg[style*="display:none"], svg[hidden]')||doc.querySelector('svg'); if(!svg) return new DOMParser().parseFromString('<svg/>','image/svg+xml'); return new DOMParser().parseFromString(new XMLSerializer().serializeToString(svg),'image/svg+xml') }
  function standaloneSvgXml(node, viewBox, srcDoc, vars){
    const ns='http://www.w3.org/2000/svg'; const out=document.implementation.createDocument(ns,'svg',null); const root=out.documentElement; root.setAttribute('xmlns',ns); if(viewBox) root.setAttribute('viewBox',viewBox);
    const content=node.tagName.toLowerCase()==='symbol'?(()=>{const g=out.createElementNS(ns,'g'); g.innerHTML=node.innerHTML; return g})():node.cloneNode(true);
    root.appendChild(out.importNode(content,true)); inlineVarAttrs(root,vars); copyNeededDefs(root,srcDoc,out);
    return new XMLSerializer().serializeToString(out);
  }
  function inlineVarAttrs(root,vars){
    const it=document.createNodeIterator(root,NodeFilter.SHOW_ELEMENT);
    for(let el=it.nextNode(); el; el=it.nextNode()){ ['fill','stroke'].forEach(p=>{ const v=el.getAttribute(p); if(v&&/var\(/.test(v)){ const m=/var\((--[^,\s)]+)(?:,\s*([^)]+))?\)/.exec(v); if(m){ el.setAttribute(p,(vars[m[1]]||m[2]||'currentColor').trim()) } } }) }
  }
  function copyNeededDefs(root,srcDoc,outDoc){
    const ids=new Set(); const it=document.createNodeIterator(root,NodeFilter.SHOW_ELEMENT);
    for(let el=it.nextNode(); el; el=it.nextNode()){ ['fill','stroke','filter','clip-path','mask'].forEach(p=>{ const v=el.getAttribute(p)||''; const m=/url\(#([^)]+)\)/.exec(v); if(m) ids.add(m[1]) }) }
    if(!ids.size) return; const defs=outDoc.createElementNS('http://www.w3.org/2000/svg','defs');
    ids.forEach(id=>{ const n=srcDoc.getElementById(id); if(n) defs.appendChild(outDoc.importNode(n,true)) }); if(defs.childNodes.length) root.insertBefore(defs,root.firstChild);
  }
  async function collectCssVars(doc,baseUrl){
    const vars={}; const pull=t=>{const r=/--([A-Za-z0-9\-_]+)\s*:\s*([^;]+);/g; let m; while((m=r.exec(t))) vars['--'+m[1]]=m[2].trim() };
    doc.querySelectorAll('style').forEach(s=>pull(s.textContent||'')); const links=[...doc.querySelectorAll('link[rel="stylesheet"]')].slice(0,3);
    for(const l of links){ try{ const href=new URL(l.getAttribute('href'),baseUrl).href; const css=await (await fetch(proxify(href))).text(); pull(css) }catch{} } return vars;
  }

  /* ========== ZIP ========== */
  downloadBtn.addEventListener('click', async ()=>{
    try{
      const zip=new JSZip();
      for(const a of allAssets){
        if(a.url.startsWith('data:')) zip.file(a.name||'asset', dataURLtoUint8(a.url));
        else if(a.url.startsWith('blob:')) zip.file(a.name||'asset', new Uint8Array(await (await fetch(a.url)).arrayBuffer()));
      }
      const blob=await zip.generateAsync({type:'blob'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`assets.zip`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href);
    }catch(e){ alert(e.message||e) }
  });

  /* ========== UI wires ========== */
  densitySlider.addEventListener('input',e=>document.documentElement.style.setProperty('--tile',`${e.target.value}px`));
  filterInput.addEventListener('input',e=>{ filterQuery=e.target.value; render() });
  tabsBar.addEventListener('click',e=>{ if(e.target.classList.contains('tab')){ activeTab=e.target.dataset.tab; render() } });
  gridContainer.addEventListener('click',e=>{ const t=e.target.closest('.tile'); if(!t) return; openLightbox(parseInt(t.dataset.index,10)) });
  urlInput.addEventListener('input',()=>{ if(urlInput.value) fileInput.value=''; render() });
  fileInput.addEventListener('change',()=>{ if(fileInput.files.length) urlInput.value=''; render() });

  setStatus('Idle'); render();
</script>
</body>
</html>