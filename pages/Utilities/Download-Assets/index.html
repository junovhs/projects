<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Asset Extractor Pro</title>
<style>
  :root {
    --bg: #09090b; --surf: #18181b; --surf-hover: #27272a;
    --border: #27272a; --primary: #3b82f6; --primary-fg: #fff;
    --text: #e4e4e7; --text-dim: #a1a1aa; --danger: #ef4444;
    --radius: 8px;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  
  /* Layout */
  .app { display: grid; grid-template-rows: auto 1fr auto; height: 100%; max-width: 1600px; margin: 0 auto; width: 100%; }
  
  /* Header */
  header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; gap: 16px; align-items: center; background: var(--surf); }
  .brand { font-weight: 700; font-size: 18px; margin-right: auto; display:flex; align-items:center; gap:10px;}
  .brand span { background: var(--primary); color: var(--primary-fg); font-size: 11px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase;}
  
  /* Controls */
  .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  input[type="text"], input[type="url"], input[type="number"], select {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    padding: 8px 12px; border-radius: var(--radius); outline: none; font-size: 14px;
  }
  input[type="text"]:focus, select:focus { border-color: var(--primary); }
  
  .btn {
    background: var(--surf-hover); color: var(--text); border: 1px solid var(--border);
    padding: 8px 16px; border-radius: var(--radius); cursor: pointer; font-size: 13px; font-weight: 500;
    display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; text-decoration: none;
  }
  .btn:hover:not(:disabled) { background: var(--border); }
  .btn.primary { background: var(--primary); color: var(--primary-fg); border-color: var(--primary); }
  .btn.primary:hover:not(:disabled) { filter: brightness(1.1); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  
  .file-input { display: none; }

  /* Main Grid */
  .viewport { overflow-y: auto; padding: 24px; background: var(--bg); }
  .grid { 
    display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; 
  }
  
  .card {
    background: var(--surf); border: 1px solid var(--border); border-radius: var(--radius);
    overflow: hidden; position: relative; transition: transform 0.1s;
    display: flex; flex-direction: column;
  }
  .card:hover { border-color: var(--text-dim); }
  .card.selected { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }
  
  .preview {
    aspect-ratio: 1; background: #000; position: relative;
    background-image: radial-gradient(#27272a 1px, transparent 1px); background-size: 10px 10px;
    display: flex; align-items: center; justify-content: center; overflow: hidden;
    cursor: zoom-in;
  }
  .preview img { max-width: 100%; max-height: 100%; object-fit: contain; pointer-events: none; }
  .preview .ext-badge {
    position: absolute; top: 6px; right: 6px; font-size: 10px; font-weight: 700;
    background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; backdrop-filter: blur(4px);
  }
  .preview .dim-badge {
    position: absolute; bottom: 6px; left: 6px; font-size: 10px;
    background: rgba(0,0,0,0.6); color: #ccc; padding: 2px 4px; border-radius: 4px;
  }

  .meta { padding: 10px; font-size: 12px; display: flex; flex-direction: column; gap: 4px; border-top: 1px solid var(--border); }
  .filename { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-weight: 500; }
  .source { color: var(--text-dim); font-size: 11px; }
  
  /* Toolbar */
  .toolbar {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 24px; background: var(--surf); border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .tabs { display: flex; gap: 4px; background: var(--bg); padding: 4px; border-radius: var(--radius); border: 1px solid var(--border); }
  .tab { padding: 4px 12px; border-radius: 4px; cursor: pointer; color: var(--text-dim); }
  .tab.active { background: var(--surf-hover); color: var(--text); font-weight: 600; }
  
  .status-bar { padding: 8px 24px; background: var(--primary); color: white; font-size: 12px; display: none; justify-content: center;}
  .empty-state { grid-column: 1/-1; text-align: center; padding: 60px; color: var(--text-dim); border: 2px dashed var(--border); border-radius: 12px; }

  /* Checkbox Overlay */
  .check-overlay {
    position: absolute; top: 8px; left: 8px; width: 24px; height: 24px;
    background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;
    display: grid; place-items: center; color: transparent; z-index: 10; transition: all 0.2s;
  }
  .check-overlay:hover { background: rgba(0,0,0,0.8); border-color: white; }
  .card.selected .check-overlay { background: var(--primary); border-color: var(--primary); color: white; }
  
  /* --- LIGHTBOX STYLES --- */
  .lightbox {
    position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.95); backdrop-filter: blur(5px);
    display: none; flex-direction: column;
    opacity: 0; transition: opacity 0.2s;
  }
  .lightbox.active { display: flex; opacity: 1; }
  
  .lb-header {
    padding: 16px 24px; display: flex; justify-content: space-between; align-items: center;
    background: rgba(24,24,27,0.8); border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }
  .lb-title { font-weight: 600; font-size: 16px; }
  .lb-meta { color: var(--text-dim); font-size: 13px; margin-left: 12px; }
  
  .lb-content {
    flex: 1; display: flex; align-items: center; justify-content: center;
    position: relative; padding: 40px; cursor: pointer; /* Indicates click to close */
  }
  .lb-content img {
    max-width: 100%; max-height: 100%; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    cursor: default; /* Don't close if clicking image */
  }
  
  .lb-footer {
    padding: 16px; display: flex; justify-content: center; gap: 12px;
    background: rgba(24,24,27,0.8);
  }
  .lb-close-btn { 
    position: absolute; top: 20px; right: 20px; background: transparent; border: none; 
    color: white; font-size: 24px; cursor: pointer; width: 40px; height: 40px; z-index: 10;
  }
  
</style>
</head>
<body>

<div class="app">
  <header>
    <div class="brand">Download Assets <span>Pro</span></div>
    <div class="controls">
      <input type="url" id="urlInput" placeholder="https://website.com" style="width: 240px;">
      <button class="btn primary" id="scrapeBtn">Web Scan</button>
      <span style="color:var(--border)">|</span>
      <button class="btn" onclick="document.getElementById('pdfInput').click()">Upload PDF</button>
      <input type="file" id="pdfInput" accept=".pdf" class="file-input">
      <span style="flex:1"></span>
      <button class="btn success" id="downloadBtn" disabled>Download ZIP (<span id="selCount">0</span>)</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="tabs" id="filterTabs">
      <div class="tab active" data-filter="all">All</div>
      <div class="tab" data-filter="image">Images</div>
      <div class="tab" data-filter="svg">SVGs</div>
      <div class="tab" data-filter="icon">Icons</div>
    </div>
    <div style="display:flex; gap:10px; align-items:center">
      <!-- Sort Dropdown -->
      <select id="sortOrder" title="Sort order">
        <option value="default">Sort: Default</option>
        <option value="size">Sort: Largest Size</option>
        <option value="ext">Sort: File Type</option>
      </select>
      
      <div style="width: 1px; height: 20px; background: var(--border);"></div>

      <label style="font-size:13px; cursor:pointer;"><input type="checkbox" id="toggleSelectAll"> Select All</label>
      <input type="text" id="searchFilter" placeholder="Filter name..." style="width:150px; padding:4px 8px;">
    </div>
  </div>

  <div id="statusBar" class="status-bar">Processing...</div>

  <div class="viewport">
    <div class="grid" id="grid">
      <div class="empty-state">
        <h3>Ready to Extract</h3>
        <p>Paste a URL above or upload a PDF to extract images, icons, and SVGs.</p>
      </div>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox">
  <button class="lb-close-btn" id="lbClose">×</button>
  <div class="lb-header">
    <div>
      <span class="lb-title" id="lbTitle">Filename.png</span>
      <span class="lb-meta" id="lbMeta">--</span>
    </div>
    <div style="display:flex; gap:8px">
        <a class="btn" id="lbOpenNew" target="_blank">Open Original</a>
        <a class="btn primary" id="lbDownload" download>Download File</a>
    </div>
  </div>
  <div class="lb-content" id="lbContent">
    <!-- Image injected here -->
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script type="module">
import * as pdfjsLib from "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.mjs";
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.6.82/build/pdf.worker.mjs";

/* --- STATE MANAGEMENT --- */
const state = {
  assets: [],
  filter: 'all',
  sort: 'default',
  search: '',
  loading: false,
  selection: new Set()
};

/* --- DOM ELEMENTS --- */
const el = (id) => document.getElementById(id);
const grid = el('grid');
const urlInput = el('urlInput');
const statusBar = el('statusBar');
const downloadBtn = el('downloadBtn');
const selCount = el('selCount');
const sortSelect = el('sortOrder');

// Lightbox Els
const lightbox = el('lightbox');
const lbTitle = el('lbTitle');
const lbMeta = el('lbMeta');
const lbContent = el('lbContent');
const lbOpenNew = el('lbOpenNew');
const lbDownload = el('lbDownload');

/* --- UTILS --- */
const proxyUrl = (u, download=false) => {
  if (u.startsWith('data:') || u.startsWith('blob:')) return u;
  return `/api/proxy?url=${encodeURIComponent(u)}${download ? '&download=1' : ''}`;
};

const getFilename = (url, index) => {
  try {
    if (url.startsWith('data:')) return `asset_${index}`;
    const name = new URL(url).pathname.split('/').pop();
    return name.length > 3 ? name : `asset_${index}`;
  } catch { return `asset_${index}`; }
};

/* --- CORE LOGIC --- */
function updateUI() {
  // 1. Filter
  let filtered = state.assets.filter(a => {
    if (state.filter !== 'all' && a.type !== state.filter) return false;
    if (state.search && !a.url.toLowerCase().includes(state.search.toLowerCase())) return false;
    return true;
  });

  // 2. Sort
  if (state.sort === 'size') {
    filtered.sort((a, b) => {
      // If we don't have dimensions yet, treat as 0
      const sizeA = (a.w || 0) * (a.h || 0);
      const sizeB = (b.w || 0) * (b.h || 0);
      return sizeB - sizeA; // Descending
    });
  } else if (state.sort === 'ext') {
    filtered.sort((a, b) => a.ext.localeCompare(b.ext));
  }

  // 3. Render
  if (filtered.length === 0 && !state.loading) {
    grid.innerHTML = `<div class="empty-state">No assets found matching filters.</div>`;
  } else {
    grid.innerHTML = filtered.map(asset => {
      const isSelected = state.selection.has(asset.id);
      const src = proxyUrl(asset.url);
      
      // Note: onload event added to update dimensions dynamically
      return `
        <div class="card ${isSelected ? 'selected' : ''}" id="card_${asset.id}">
          <div class="check-overlay" onclick="event.stopPropagation(); toggleSelect('${asset.id}')">${isSelected ? '✓' : ''}</div>
          <div class="preview" onclick="openLightbox('${asset.id}')">
            <img src="${src}" loading="lazy" 
              onload="window.onAssetLoad('${asset.id}', this)"
              onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23555%22><path d=%22M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z%22/></svg>'">
            <div class="ext-badge">${asset.ext}</div>
            <div class="dim-badge" id="dims_${asset.id}">${asset.w ? asset.w + '×' + asset.h : ''}</div>
          </div>
          <div class="meta">
            <div class="filename" title="${asset.name}">${asset.name}</div>
            <div class="source">${asset.source}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  selCount.textContent = state.selection.size;
  downloadBtn.disabled = state.selection.size === 0 || state.loading;
}

/* --- DYNAMIC SIZE DETECTION --- */
window.onAssetLoad = (id, imgEl) => {
  const asset = state.assets.find(a => a.id === id);
  if (asset && !asset.w) {
    asset.w = imgEl.naturalWidth;
    asset.h = imgEl.naturalHeight;
    
    // Update label without re-rendering entire grid (performance)
    const badge = document.getElementById(`dims_${id}`);
    if (badge) badge.textContent = `${asset.w}×${asset.h}`;
    
    // If sorting by size is active, we might need to re-sort. 
    // To avoid jumping, we only re-sort if user toggles, 
    // OR we could debounce a re-render. For now, we just update data.
  }
};

window.toggleSelect = (id) => {
  if (state.selection.has(id)) state.selection.delete(id);
  else state.selection.add(id);
  // Just toggle class for performance, full render on filter change
  const card = document.getElementById(`card_${id}`);
  if(card) {
    if(state.selection.has(id)) card.classList.add('selected');
    else card.classList.remove('selected');
    card.querySelector('.check-overlay').textContent = state.selection.has(id) ? '✓' : '';
  }
  selCount.textContent = state.selection.size;
  downloadBtn.disabled = state.selection.size === 0;
};

/* --- LIGHTBOX --- */
window.openLightbox = (id) => {
  const asset = state.assets.find(a => a.id === id);
  if (!asset) return;

  lbTitle.textContent = asset.name;
  lbMeta.textContent = `${asset.ext.toUpperCase()} • ${asset.w ? asset.w+'x'+asset.h : ''}`;
  lbContent.innerHTML = `<img src="${proxyUrl(asset.url)}" onclick="event.stopPropagation()">`;

  lbOpenNew.href = asset.url; 
  
  if (asset.url.startsWith('blob:') || asset.url.startsWith('data:')) {
    lbDownload.href = asset.url;
    lbDownload.download = asset.name;
  } else {
    lbDownload.href = proxyUrl(asset.url, true);
    lbDownload.removeAttribute('download'); 
  }

  lightbox.classList.add('active');
};

window.closeLightbox = () => {
  lightbox.classList.remove('active');
  lbContent.innerHTML = '';
};

// Lightbox Events
el('lbClose').addEventListener('click', window.closeLightbox);

// Close when clicking the background (lightbox) or the container (lbContent)
// But STOP if clicking the image (handled by stopPropagation on img tag above)
lightbox.addEventListener('click', (e) => {
  if (e.target === lightbox || e.target === lbContent) {
    window.closeLightbox();
  }
});
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && lightbox.classList.contains('active')) window.closeLightbox();
});


/* --- WEB SCRAPER --- */
el('scrapeBtn').addEventListener('click', async () => {
  const url = urlInput.value;
  if (!url) return alert('Enter a URL');
  
  setLoading(true, 'Scanning URL...');
  state.assets = []; state.selection.clear();
  
  try {
    const res = await fetch('/api/discover', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ url, limit: 200 })
    });
    if (!res.ok) throw new Error('Scan failed');
    const data = await res.json();
    
    state.assets = data.assets.map((a, i) => ({
      id: `web_${i}`,
      url: a.url,
      name: getFilename(a.url, i),
      type: a.type === 'svg' ? 'svg' : 'image',
      ext: a.ext,
      source: a.source,
      w: null, h: null // Will be filled by onAssetLoad
    }));

    state.assets.forEach(a => state.selection.add(a.id));
    
  } catch (e) {
    alert(e.message);
  } finally {
    setLoading(false);
    updateUI();
  }
});

/* --- PDF EXTRACTOR --- */
el('pdfInput').addEventListener('change', async (e) => {
  if (!e.target.files.length) return;
  setLoading(true, 'Parsing PDF...');
  state.assets = []; state.selection.clear();
  
  try {
    const file = e.target.files[0];
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buffer}).promise;
    
    for (let p = 1; p <= pdf.numPages; p++) {
      setLoading(true, `Rendering PDF Page ${p}/${pdf.numPages}...`);
      const page = await pdf.getPage(p);
      const viewport = page.getViewport({scale: 2});
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      
      await page.render({canvasContext: ctx, viewport}).promise;
      
      const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.85));
      const url = URL.createObjectURL(blob);
      
      const id = `pdf_p_${p}`;
      state.assets.push({
        id, url, name: `${file.name}_page_${p}.jpg`,
        type: 'image', ext: 'jpg', source: 'pdf-page',
        w: canvas.width, h: canvas.height
      });
      state.selection.add(id);
    }
  } catch (e) {
    console.error(e);
    alert('PDF Parse Error');
  } finally {
    setLoading(false);
    updateUI();
  }
});

/* --- ZIP DOWNLOADER --- */
downloadBtn.addEventListener('click', async () => {
  const zip = new JSZip();
  const targets = state.assets.filter(a => state.selection.has(a.id));
  
  setLoading(true, `Zipping ${targets.length} files...`);
  let processed = 0;
  
  await Promise.all(targets.map(async (asset) => {
    try {
      let data;
      if (asset.url.startsWith('blob:') || asset.url.startsWith('data:')) {
        data = await (await fetch(asset.url)).blob();
      } else {
        const res = await fetch(proxyUrl(asset.url));
        if (!res.ok) throw new Error('Fetch fail');
        data = await res.blob();
      }
      
      let fileName = asset.name;
      if (zip.file(fileName)) fileName = `${Date.now()}_${fileName}`;
      zip.file(fileName, data);
    } catch (e) {
      console.warn('Failed to download', asset.url);
    } finally {
      processed++;
      statusBar.textContent = `Downloading... ${processed}/${targets.length}`;
    }
  }));
  
  const content = await zip.generateAsync({type:"blob"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(content);
  a.download = "assets.zip";
  a.click();
  setLoading(false);
});

/* --- UI HELPERS --- */
function setLoading(bool, txt) {
  state.loading = bool;
  statusBar.style.display = bool ? 'flex' : 'none';
  statusBar.textContent = txt || 'Processing...';
  el('scrapeBtn').disabled = bool;
}

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    state.filter = t.dataset.filter;
    updateUI();
  });
});

el('searchFilter').addEventListener('input', (e) => {
  state.search = e.target.value;
  updateUI();
});

el('toggleSelectAll').addEventListener('change', (e) => {
  if (e.target.checked) state.assets.forEach(a => state.selection.add(a.id));
  else state.selection.clear();
  updateUI();
});

sortSelect.addEventListener('change', (e) => {
  state.sort = e.target.value;
  updateUI();
});

</script>
</body>
</html>