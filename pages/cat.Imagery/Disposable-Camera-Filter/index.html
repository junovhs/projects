<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Disposable Night — v5 (Mobile-friendly exports)</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <strong>Disposable Night</strong>
      <span>flash • bloom • grain</span>
    </div>
    <div class="actions">
      <label class="file">
        <input id="file" type="file" accept="image/*,video/*" />
        <button id="open">Open</button>
      </label>
      <button id="play" disabled>Play</button>
      <button id="original">Original</button>
      <button id="reset">Reset</button>

      <!-- NEW: view mode toggles -->
      <button id="view-fit" class="toggle on">Fit</button>
      <button id="view-1x" class="toggle">1:1</button>

      <button id="save-png">Save PNG</button>
      <button id="export-pngs">Export PNGs (.tar)</button>
      <button id="export-mp4">Export MP4</button>
    </div>
  </header>
  <main id="app">
    <aside class="panel">
      <section>
        <h3>Exposure & Flash</h3>
        <div class="row"><label>Exposure (EV)</label><input type="range" id="ev" min="-1" max="0.5" step="0.01" value="-0.40"><span class="val" data-for="ev">-0.40</span></div>
        <div class="row"><label>Flash Strength</label><input type="range" id="flashStrength" min="0" max="2.0" step="0.01" value="1.50"><span class="val" data-for="flashStrength">1.50</span></div>
        <div class="row"><label>Flash Falloff</label><input type="range" id="flashFalloff" min="0.5" max="10" step="0.01" value="4.50"><span class="val" data-for="flashFalloff">4.50</span></div>
        <div class="row">
          <label>Flash Position</label>
          <div class="pad" id="flashPad"><div class="dot" id="flashDot"></div></div>
        </div>
      </section>

      <section>
        <h3>Tone</h3>
        <div class="row"><label>S-curve</label><input type="range" id="scurve" min="0" max="1" step="0.01" value="0.60"><span class="val" data-for="scurve">0.60</span></div>
        <div class="row"><label>Black Crush</label><input type="range" id="blacks" min="0" max="0.15" step="0.001" value="0.06"><span class="val" data-for="blacks">0.06</span></div>
        <div class="row"><label>Lifted Blacks</label><input type="range" id="blackLift" min="0" max="0.15" step="0.001" value="0.00"><span class="val" data-for="blackLift">0.00</span></div>
        <div class="row"><label>Highlight Knee</label><input type="range" id="knee" min="0" max="0.25" step="0.001" value="0.12"><span class="val" data-for="knee">0.12</span></div>
      </section>

      <section>
        <h3>Split & Casts</h3>
        <div class="row"><label>Shadow Cool</label><input type="range" id="shadowCool" min="0" max="1" step="0.01" value="0.35"><span class="val" data-for="shadowCool">0.35</span></div>
        <div class="row"><label>Highlight Warm</label><input type="range" id="highlightWarm" min="0" max="1" step="0.01" value="0.35"><span class="val" data-for="highlightWarm">0.35</span></div>
        <div class="row"><label>Green Shadows</label><input type="range" id="greenShadows" min="0" max="1" step="0.01" value="0.35"><span class="val" data-for="greenShadows">0.35</span></div>
        <div class="row"><label>Magenta Mids</label><input type="range" id="magentaMids" min="0" max="1" step="0.01" value="0.30"><span class="val" data-for="magentaMids">0.30</span></div>
      </section>

      <section>
        <h3>Bloom, Vignette, Optics</h3>
        <div class="row"><label>Bloom Threshold</label><input type="range" id="bloomThreshold" min="0.2" max="1" step="0.001" value="0.529"><span class="val" data-for="bloomThreshold">0.529</span></div>
        <div class="row"><label>Bloom Radius</label><input type="range" id="bloomRadius" min="1" max="60" step="0.1" value="48.9"><span class="val" data-for="bloomRadius">48.90</span></div>
        <div class="row"><label>Bloom Intensity</label><input type="range" id="bloomIntensity" min="0" max="3" step="0.01" value="1.69"><span class="val" data-for="bloomIntensity">1.69</span></div>
        <div class="row"><label>Bloom Warmth</label><input type="range" id="bloomWarm" min="0" max="1" step="0.01" value="0.18"><span class="val" data-for="bloomWarm">0.18</span></div>
        <div class="row"><label>Halation</label><input type="range" id="halation" min="0" max="2" step="0.01" value="1.22"><span class="val" data-for="halation">1.22</span></div>
        <div class="row"><label>Vignette</label><input type="range" id="vignette" min="0" max="0.5" step="0.001" value="0.18"><span class="val" data-for="vignette">0.18</span></div>
        <div class="row"><label>Vignette Power</label><input type="range" id="vignettePower" min="1" max="5" step="0.01" value="2.5"><span class="val" data-for="vignettePower">2.50</span></div>
        <div class="row"><label>Chromatic Aberration</label><input type="range" id="ca" min="0" max="2" step="0.01" value="1.0"><span class="val" data-for="ca">1.00</span></div>
        <div class="row"><label>Clarity</label><input type="range" id="clarity" min="0" max="0.3" step="0.01" value="0.00"><span class="val" data-for="clarity">0.00</span></div>
      </section>

      <section>
        <h3>Motion</h3>
        <div class="row"><label>Shutter</label><input type="range" id="shutterUI" min="0" max="1" step="0.001" value="0.3"><span class="val" id="shutterLabel">1/60</span></div>
        <div class="row"><label>Shake</label><input type="range" id="shake" min="0" max="1" step="0.01" value="0.3"><span class="val" data-for="shake">0.30</span></div>
        <div class="row"><label>Trail Angle (°)</label><input type="range" id="motionAngle" min="0" max="180" step="1" value="0"><span class="val" data-for="motionAngle">0</span></div>
      </section>

      <!-- NEW: Handheld Camera section -->
      <section>
        <h3>Handheld Camera</h3>
        <div class="row"><label>Intensity</label><input type="range" id="shakeHandheld" min="0" max="1" step="0.01" value="0.3"><span class="val" data-for="shakeHandheld">0.30</span></div>
        <div class="row"><label>Frequency (Hz)</label><input type="range" id="shakeFreq" min="0.1" max="5" step="0.1" value="2"><span class="val" data-for="shakeFreq">2.0</span></div>
        <div class="row"><label>X Amp (px)</label><input type="range" id="shakeAmpX" min="0" max="50" step="1" value="8"><span class="val" data-for="shakeAmpX">8</span></div>
        <div class="row"><label>Y Amp (px)</label><input type="range" id="shakeAmpY" min="0" max="50" step="1" value="6"><span class="val" data-for="shakeAmpY">6</span></div>
        <div class="row"><label>Rotation (°)</label><input type="range" id="shakeRot" min="0" max="2" step="0.1" value="0.4"><span class="val" data-for="shakeRot">0.4</span></div>
      </section>

      <section>
        <h3>Film Grain</h3>
        <div class="row"><label>ASA</label><input type="range" id="grainASA" min="50" max="3200" step="50" value="800"><span class="val" data-for="grainASA">800</span></div>
        <div class="row"><label>Develop</label><input type="range" id="grainDevelop" min="-2" max="2" step="0.1" value="0"><span class="val" data-for="grainDevelop">0.0</span></div>
        <div class="row"><label>Stock Type</label><input type="range" id="grainStock" min="0" max="1" step="0.01" value="0.6"><span class="val" data-for="grainStock">0.60</span></div>
        <div class="row"><label>Color Grain</label><input type="range" id="grainChroma" min="0" max="1" step="0.01" value="0.6"><span class="val" data-for="grainChroma">0.60</span></div>
        <div class="row"><label>Print Size</label><input type="range" id="grainMagnify" min="0.5" max="3" step="0.01" value="1.0"><span class="val" data-for="grainMagnify">1.00</span></div>
      </section>
    </aside>

    <section class="stage">
      <div id="viewport">
        <canvas id="gl"></canvas>
      </div>
      <div class="hint">Tip: click the image to place the flash.</div>
      <div id="overlay" class="overlay hidden"><div id="overlayText">Exporting… 0%</div></div>
      <div id="toast" class="toast hidden"></div>
    </section>
  </main>

  <video id="vid" playsinline muted style="display:none"></video>

  <!-- Load ffmpeg.wasm UMD first -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.6/dist/umd/ffmpeg.min.js"></script>

  <!-- Then your app -->
  <script type="module" src="app.js"></script>
</body>
</html>