<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ULTIMATE CROP TOOL</title>

  <!-- React 18 UMD (optional, UI is vanilla now) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, system-ui, sans-serif;
      background: #0a0a0a;
      color: #fff;
      overflow: hidden;
    }

    .app-container { height: 100%; display: flex; flex-direction: column; }
    .header { text-align: center; padding: 12px 20px; background: #151515; border-bottom: 1px solid #2a2a2a; }
    .title {
      font-size: 20px; font-weight: 800; letter-spacing: -0.3px;
      background: linear-gradient(135deg, #ffffff, #00ff88);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }

    .main-content { flex: 1; display: flex; gap: 20px; padding: 40px 20px 20px; overflow: hidden; }
    .left-panel { flex: 1; min-width: 0; display: flex; align-items: center; justify-content: center; }
    .right-panel { width: 370px; display: flex; flex-direction: column; gap: 16px; height: 100%; }

    .drop-zone {
      position: relative;
      width: min(100%, 50vw); height: 220px;
      border: 2px dashed #3a3a3a; border-radius: 12px;
      background: rgba(0, 255, 136, 0.06);
      display: flex; align-items: center; justify-content: center; flex-direction: column;
      cursor: pointer; transition: all .18s ease; padding: 16px; text-align: center; outline: none;
    }
    .drop-zone:hover, .drop-zone.drag-over { border-color: #00ff88; background: rgba(0,255,136,.1); }
    .drop-icon { width: 40px; height: 40px; margin-bottom: 8px; fill: #00ff88; opacity: .85; }
    .drop-text { font-size: 14px; font-weight: 700; }
    .drop-subtext { font-size: 11px; color: #8a8a8a; max-width: 420px; }
    .drop-zone:focus-visible { box-shadow: 0 0 0 3px rgba(0,255,136,.25); }

    .preview-container {
      width: min(100%, 50vw); height: 100%; max-height: 520px;
      position: relative; border-radius: 12px; overflow: hidden;
    }
    .crop-area {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      border: 2px dashed #00ff88; border-radius: 8px; overflow: hidden;
    }
    .crop-area img {
      position: absolute; left: 50%; top: 50%;
      transform-origin: center center;
      user-select: none; -webkit-user-drag: none; pointer-events: none;
    }
    .guides { position: absolute; inset: 0; pointer-events: none; display: none; }
    .guides.on { display: block; }
    .guide-line { position: absolute; background: rgba(255,255,255,.25); }
    .guide-line.v { width: 1px; top: 0; bottom: 0; }
    .guide-line.h { height: 1px; left: 0; right: 0; }

    .controls {
      flex: 1; display: flex; flex-direction: column; gap: 22px; overflow: auto;
      background: linear-gradient(145deg, rgba(26, 26, 26, 0.9), rgba(17, 17, 17, 0.9));
      border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 18px;
      backdrop-filter: blur(18px);
    }
    .control-section { display: flex; flex-direction: column; gap: 14px; }
    .section-header { display: flex; align-items: center; gap: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,.08); }
    .section-title { font-size: 13px; font-weight: 800; }
    .control-label { font-size: 11px; font-weight: 700; color: #00ff88; letter-spacing: .4px; text-transform: uppercase; }
    .control-group { display: flex; flex-direction: column; gap: 8px; }

    .dimension-inputs { display: flex; align-items: center; gap: 10px; }
    .input-wrapper { position: relative; flex: 1; display: flex; align-items: center; }
    .dimension-input {
      width: 100%; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.18);
      border-radius: 8px; padding: 12px 44px 12px 14px; color: #fff; font-size: 13px; font-weight: 600; transition: all .18s;
    }
    .dimension-input:focus { outline: none; border-color: #00ff88; background: rgba(0,255,136,.06); }
    .input-label { position: absolute; right: 32px; top: 50%; transform: translateY(-50%); font-size: 10px; color: #7a7a7a; font-weight: 700; }
    .dimension-separator { color: #777; font-weight: 800; font-size: 16px; }

    .ratio-grid, .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .ratio-btn, .size-btn, .pill-btn {
      padding: 8px 6px; background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.08);
      border-radius: 6px; color: #cfcfcf; font-size: 10px; font-weight: 800; cursor: pointer; transition: all .15s;
      text-align: center;
    }
    .ratio-btn:hover, .size-btn:hover, .pill-btn:hover { background: rgba(0,255,136,.12); border-color: rgba(0,255,136,.35); color: #00ff88; }
    .ratio-btn.active, .size-btn.active { background: linear-gradient(135deg, #00ff88, #00cc70); border-color: #00ff88; color: #000; }
    .size-btn.star::before { content: "â˜… "; color: #00ff88; }

    .slider-container { display: flex; align-items: center; gap: 10px; }
    input[type="range"] {
      -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px;
      background: linear-gradient(90deg, rgba(0,255,136,.45), rgba(0,255,136,.15)); outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 16px; height: 16px; border-radius: 50%; background: #00ff88; cursor: pointer; border: 2px solid #0a0a0a;
    }
    input[type="range"]::-moz-range-thumb {
      width: 16px; height: 16px; border-radius: 50%; background: #00ff88; cursor: pointer; border: 2px solid #0a0a0a;
    }
    .value-display { background: #1b1b1b; padding: 4px 8px; border-radius: 4px; border: 1px solid #333; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 10px; color: #00ff88; min-width: 54px; text-align: center; }
    .value-display.zoom-red { color: #ff5252; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .select { background: rgba(0,0,0,.45); color: #fff; border: 1px solid rgba(255,255,255,.18); border-radius: 8px; padding: 8px 10px; font-weight: 600; font-size: 12px; }

    .status-box {
      background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.08); border-radius: 10px;
      padding: 10px; font-size: 11px; line-height: 1.35;
    }
    .status-line { display: flex; justify-content: space-between; gap: 8px; }
    .status-key { color: #9a9a9a; font-weight: 700; letter-spacing: .3px; }
    .status-val.warn { color: #ff5252; font-weight: 800; }

    .filename-input-wrapper { position: relative; display: flex; align-items: center; }
    .filename-input {
      flex: 1; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.18);
      border-radius: 8px; padding: 12px 48px 12px 14px; color: #fff; font-size: 13px; transition: all .18s;
    }
    .filename-input:focus { outline: none; border-color: #00ff88; background: rgba(0,255,136,.06); }
    .filename-extension { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 12px; color: #777; font-weight: 800; }

    .export-section { background: linear-gradient(145deg, rgba(0,255,136,.1), rgba(0,200,112,.05)); border: 1px solid rgba(0,255,136,.2); border-radius: 16px; padding: 18px; backdrop-filter: blur(18px); }
    .export-actions { display: flex; flex-direction: column; gap: 8px; }
    .export-btn { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 14px 18px; border: none; border-radius: 12px; font-size: 13px; font-weight: 900; cursor: pointer; transition: transform .15s, box-shadow .15s; }
    .export-btn.primary { background: linear-gradient(135deg, #00ff88, #00cc70); color: #000; }
    .export-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,255,136,.25); }

    button:focus-visible, input:focus-visible, select:focus-visible { outline: 2px solid rgba(0,255,136,.55); outline-offset: 2px; border-radius: 8px; }
    .lock-btn {
      position: absolute; right: 4px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: none; border-radius: 4px;
      background: transparent; color: #00ff88; font-size: 12px; cursor: pointer; transition: all .15s; display: flex; align-items: center; justify-content: center;
    }
    .lock-btn:hover { background: rgba(0,255,136,.1); }
    .lock-btn.inactive { color: #555; opacity: 0.6; }
    .lock-btn.active { color: #00ff88; background: rgba(0,255,136,.15); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script>
  (function () {
    /* ------------------------------- State -------------------------------- */
    let imgEl = null;
    let natural = { w: 0, h: 0 };
    let coverScale = 1;
    let userScale = 1;
    let offset = { x: 0, y: 0 };
    let aspectRatio = 1;              // W/H
    let exportW = 1000, exportH = 1000;
    let tW = 0, tH = 0;               // preview crop box CSS px
    let previewScale = 1;             // scales the crop box itself (for Pixel View)
    let pixelView = false;            // 1:1 toggle
    let isDragging = false; let lastPt = { x: 0, y: 0 };
    let lockedDimension = 'width';    // anchor when Aspect Lock is ON
    let aspectLocked = true;          // true = ratio locked (dimension-first off)
    let roundingPolicy = 'even';      // 'none' | 'even' | 'm4'

    const MAX_ZOOM_MULTIPLIER = 8;
    const RATIO_MIN = 0.333, RATIO_MAX = 3;
    const RATIO_EPS = 0.005;

    /* ------------------------------ Elements ------------------------------ */
    const root = document.getElementById('root');
    root.innerHTML = `
      <div class="app-container">
        <input type="file" accept="image/*" style="display: none" id="fileInput">
        <div class="header"><h1 class="title">ULTIMATE CROP TOOL</h1></div>
        <div class="main-content">
          <div class="left-panel">
            <div class="drop-zone" id="dropZone">
              <svg class="drop-icon" viewBox="0 0 24 24"><path d="M19.35 10.04C18.67 6.59 15.64 4 12 4C9.11 4 6.6 5.64 5.35 8.04C2.34 8.36 0 10.91 0 14C0 17.31 2.69 20 6 20H19C21.76 20 24 17.76 24 15C24 12.36 21.95 10.22 19.35 10.04ZM14 13V17H10V13H7L12 8L17 13H14Z"/></svg>
              <div class="drop-text">Drop images here or click</div>
              <div class="drop-subtext">Drag from downloads or your file explorer</div>
            </div>
            <div class="preview-container" id="previewContainer" style="display:none">
              <div class="crop-area" id="cropArea">
                <img id="previewImg" alt="Preview">
                <div class="guides" id="guides">
                  <div class="guide-line v" style="left: 33.333%"></div>
                  <div class="guide-line v" style="left: 66.666%"></div>
                  <div class="guide-line h" style="top: 33.333%"></div>
                  <div class="guide-line h" style="top: 66.666%"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="right-panel" id="rightPanel" style="display:none">
            <div class="controls">
              <div class="control-section">
                <div class="section-header"><div class="section-title">Dimensions</div></div>

                <div class="control-group">
                  <div class="control-label">Export Size</div>
                  <div class="dimension-inputs">
                    <div class="input-wrapper">
                      <input type="number" class="dimension-input" id="widthInput" value="968">
                      <span class="input-label">W</span>
                      <button class="lock-btn" id="widthLock">ðŸ”’</button>
                    </div>
                    <div class="dimension-separator">Ã—</div>
                    <div class="input-wrapper">
                      <input type="number" class="dimension-input" id="heightInput" value="600">
                      <span class="input-label">H</span>
                      <button class="lock-btn" id="heightLock">ðŸ”’</button>
                    </div>
                  </div>
                  <div class="row">
                    <button class="pill-btn" id="aspectLockBtn">Aspect Lock: On</button>
                  </div>
                  <div class="row"><span class="control-label" style="margin-right:6px">Size Presets</span></div>
                  <div class="size-grid" id="sizeGrid"></div>
                  <div class="row">
                    <label class="control-label">Rounding</label>
                    <select id="roundingSelect" class="select">
                      <option value="none">None</option>
                      <option value="even" selected>Even</option>
                      <option value="m4">Multiple of 4</option>
                    </select>
                  </div>
                </div>

                <div class="control-group">
                  <div class="control-label">Aspect Ratio</div>
                  <div class="slider-container">
                    <input type="range" id="aspectSlider" min="0.333" max="3" step="0.001" value="1.613">
                    <div class="value-display" id="aspectValue">1.61:1</div>
                  </div>
                  <div class="ratio-grid" id="ratioGrid"></div>
                  <div class="help-text">When Aspect Lock is off, ratio presets are disabled so width/height are fully manual.</div>
                </div>
              </div>

              <div class="control-section">
                <div class="section-header"><div class="section-title">View</div></div>
                <div class="control-group">
                  <div class="control-label">Zoom Level</div>
                  <div class="slider-container">
                    <input type="range" id="zoomSlider" min="0.1" max="2" step="0.01" value="1">
                    <div class="value-display" id="zoomValue">1.00Ã—</div>
                  </div>
                  <div class="row">
                    <button class="pill-btn" id="fitCoverBtn">Fit: Cover</button>
                    <button class="pill-btn" id="pixelViewBtn">Pixel View: Off</button>
                    <button class="pill-btn" id="guidesToggle">Guides: Off</button>
                  </div>
                  <div class="help-text">Pixel View shrinks the crop box so 1 image px = 1 screen px (when space allows).</div>
                </div>
              </div>

              <div class="control-section">
                <div class="section-header"><div class="section-title">Info</div></div>
                <div class="status-box" id="statusBox"></div>
              </div>

              <div class="control-section">
                <div class="section-header"><div class="section-title">Output</div></div>
                <div class="control-group">
                  <div class="control-label">Filename</div>
                  <div class="filename-input-wrapper">
                    <input type="text" class="filename-input" id="filenameInput" placeholder="Enter filename...">
                    <div class="filename-extension">.jpg</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="export-section">
              <div class="export-actions">
                <button class="export-btn primary" id="downloadBtn"><span>â¬‡</span><span>Download Image</span></button>
              </div>
              <div class="help-text">Press Enter to export. Hotkeys: 1â€“9 = ratio presets, âŒƒ1 = first size preset.</div>
            </div>
          </div>
        </div>
      </div>
    `;

    /* --------------------------- Grab elements --------------------------- */
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('previewContainer');
    const cropArea = document.getElementById('cropArea');
    const guides = document.getElementById('guides');
    const previewImg = document.getElementById('previewImg');
    const rightPanel = document.getElementById('rightPanel');

    const widthInput = document.getElementById('widthInput');
    const heightInput = document.getElementById('heightInput');
    const widthLock = document.getElementById('widthLock');
    const heightLock = document.getElementById('heightLock');
    const aspectLockBtn = document.getElementById('aspectLockBtn');

    const ratioGrid = document.getElementById('ratioGrid');
    const sizeGrid  = document.getElementById('sizeGrid');
    const aspectSlider = document.getElementById('aspectSlider');
    const aspectValue  = document.getElementById('aspectValue');

    const zoomSlider = document.getElementById('zoomSlider');
    const zoomValue  = document.getElementById('zoomValue');
    const fitCoverBtn = document.getElementById('fitCoverBtn');
    const pixelViewBtn = document.getElementById('pixelViewBtn');
    const guidesToggle = document.getElementById('guidesToggle');

    const roundingSelect = document.getElementById('roundingSelect');
    const filenameInput = document.getElementById('filenameInput');
    const downloadBtn = document.getElementById('downloadBtn');

    const statusBox = document.getElementById('statusBox');

    /* ----------------------------- Presets ------------------------------ */
    const ratioPresets = [
      { label: "1:3", value: 1/3 }, { label: "1:2", value: 1/2 },
      { label: "9:16", value: 9/16 }, { label: "10:16", value: 10/16 },
      { label: "2:3", value: 2/3 }, { label: "3:4", value: 3/4 },
      { label: "4:5", value: 4/5 }, { label: "1:1", value: 1 },
      { label: "5:4", value: 5/4 }, { label: "4:3", value: 4/3 },
      { label: "3:2", value: 3/2 }, { label: "16:10", value: 16/10 },
      { label: "16:9", value: 16/9 }, { label: "968:600", value: 968/600 },
      { label: "2:1", value: 2 }, { label: "3:1", value: 3 }
    ];
    const sizePresets = [
      { label: "968Ã—600", w: 968, h: 600, star: true },
      { label: "1200Ã—628", w: 1200, h: 628, star: false },
      { label: "1080Ã—1080", w: 1080, h: 1080, star: false },
      { label: "1920Ã—1080", w: 1920, h: 1080, star: false }
    ];

    /* ------------------------------ Helpers ----------------------------- */
    const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
    const even  = (n) => (n % 2 ? n + 1 : n);
    const m4    = (n) => { const r = n % 4; return r ? n + (4 - r) : n; };

    function roundDim(n) {
      if (roundingPolicy === 'even') return even(Math.max(1, Math.round(n)));
      if (roundingPolicy === 'm4')   return m4(Math.max(1, Math.round(n)));
      return Math.max(1, Math.round(n));
    }

    function persist() {
      try {
        localStorage.setItem('UCT_SETTINGS_V2', JSON.stringify({
          exportW, exportH, aspectRatio, lockedDimension, roundingPolicy,
          zoom: userScale, guidesOn: guides.classList.contains('on'),
          aspectLocked, pixelView
        }));
      } catch(e) {}
    }

    function restore() {
      try {
        const raw = localStorage.getItem('UCT_SETTINGS_V2');
        if (!raw) return;
        const s = JSON.parse(raw);
        if (typeof s.exportW === 'number') exportW = s.exportW;
        if (typeof s.exportH === 'number') exportH = s.exportH;
        if (typeof s.aspectRatio === 'number') aspectRatio = clamp(s.aspectRatio, RATIO_MIN, RATIO_MAX);
        if (s.lockedDimension === 'width' || s.lockedDimension === 'height') lockedDimension = s.lockedDimension;
        if (s.roundingPolicy) roundingPolicy = s.roundingPolicy;
        if (typeof s.zoom === 'number') userScale = s.zoom;
        if (s.guidesOn) guides.classList.add('on');
        if (typeof s.aspectLocked === 'boolean') aspectLocked = s.aspectLocked;
        if (typeof s.pixelView === 'boolean') pixelView = s.pixelView;
      } catch(e) {}
    }

    function enforceDimensions() {
      if (!aspectLocked) return; // in free mode, do not force the other dimension
      if (aspectRatio <= 0 || !isFinite(aspectRatio)) aspectRatio = 1;
      if (lockedDimension === 'width') {
        exportH = roundDim(Math.round(exportW / aspectRatio));
      } else {
        exportW = roundDim(Math.round(exportH * aspectRatio));
      }
    }

    function computeCoverScale() {
      if (!natural.w || !natural.h || !tW || !tH) return 1;
      const s = Math.max(tW / natural.w, tH / natural.h);
      coverScale = s;
      return s;
    }

    function ensureUserScaleAtLeastCover() {
      if (!natural.w || !natural.h) return;
      if (userScale < coverScale) userScale = coverScale;
    }

    function constrainOffsets() {
      if (!natural.w || !natural.h || !tW || !tH) return;
      const s = Math.max(userScale, coverScale);
      const W = natural.w * s, H = natural.h * s;
      const minX = (tW - W) / 2, maxX = (W - tW) / 2;
      const minY = (tH - H) / 2, maxY = (H - tH) / 2;
      offset.x = clamp(offset.x, minX, maxX);
      offset.y = clamp(offset.y, minY, maxY);
    }

    function applyTransform() {
      const s = Math.max(userScale, coverScale);
      previewImg.style.transform = `translate(-50%, -50%) translate(${offset.x}px, ${offset.y}px) scale(${s})`;
    }

    function updateAspectUI() {
      aspectLockBtn.textContent = `Aspect Lock: ${aspectLocked ? 'On' : 'Off'}`;
      aspectSlider.disabled = !aspectLocked;
      ratioGrid.querySelectorAll('button').forEach(b => b.disabled = !aspectLocked);
    }

    function updateAspectDisplay() {
      const r = aspectRatio;
      aspectValue.textContent = r >= 1 ? `${r.toFixed(2)}:1` : `1:${(1/r).toFixed(2)}`;
      const buttons = ratioGrid.querySelectorAll('button');
      let closest = -1, best = Infinity;
      ratioPresets.forEach((p, i) => {
        const d = Math.abs(p.value - r);
        if (d < best) { best = d; closest = i; }
      });
      buttons.forEach((btn, i) => {
        const d = Math.abs(ratioPresets[i].value - r);
        const on = (i === closest && best <= RATIO_EPS);
        btn.className = on ? 'ratio-btn active' : 'ratio-btn';
        btn.disabled = !aspectLocked;
      });
    }

    function updateZoomDisplay() {
      if (!natural.w || !natural.h || !tW || !tH) return;
      const dpr = window.devicePixelRatio || 1;
      const screenZoom = userScale / dpr;
      const exportScaleX = userScale * (exportW / tW);
      const exportScaleY = userScale * (exportH / tH);
      const exportScale  = Math.max(exportScaleX, exportScaleY);
      zoomValue.className = 'value-display' + (exportScale > 1.001 ? ' zoom-red' : '');
      zoomValue.textContent = `${screenZoom.toFixed(2)}Ã— (export ${exportScale.toFixed(2)}Ã—)`;
    }

    function updateStatus() {
      const mp = (w,h) => (w*h/1e6).toFixed(2)+'MP';
      const dpr = window.devicePixelRatio || 1;
      const screenZoom = (userScale / dpr) || 0;

      const exportScaleX = userScale * (exportW / (tW||1));
      const exportScaleY = userScale * (exportH / (tH||1));
      const exportScale  = Math.max(exportScaleX, exportScaleY);

      const warn = exportScale > 1.001 || (natural.w && (exportW > natural.w*2 || exportH > natural.h*2));
      statusBox.innerHTML = `
        <div class="status-line"><span class="status-key">Source</span><span class="status-val">${natural.w||0}Ã—${natural.h||0} (${mp(natural.w||0,natural.h||0)})</span></div>
        <div class="status-line"><span class="status-key">Export</span><span class="status-val">${exportW}Ã—${exportH} (${(exportW/exportH).toFixed(2)}:1, ${mp(exportW,exportH)})</span></div>
        <div class="status-line"><span class="status-key">On-screen</span><span class="status-val">${(screenZoom*100).toFixed(0)}%</span></div>
        <div class="status-line"><span class="status-key">Export scale</span><span class="status-val ${warn?'warn':''}">${exportScale.toFixed(2)}Ã—${warn?' â€” upscaling':''}</span></div>
      `;
    }

    function updateLayout() {
      const container = previewContainer;
      if (!container) return;

      const cw = container.clientWidth;
      const ch = container.clientHeight;
      const maxH = 520;

      // Base crop size from container & aspect
      const baseH = Math.min(ch, maxH);
      const baseW = baseH * aspectRatio;
      let tw0, th0;
      if (baseW <= cw) { tw0 = Math.round(baseW); th0 = Math.round(baseH); }
      else { tw0 = Math.round(cw); th0 = Math.round(cw / aspectRatio); }

      // Pixel View shrinks crop box so coverScale â‰¤ 1 at userScale=1 (when space allows)
      if (pixelView && natural.w && natural.h) {
        previewScale = Math.min(natural.w / tw0, natural.h / th0, 1);
      } else {
        previewScale = 1;
      }

      tW = Math.max(1, Math.round(tw0 * previewScale));
      tH = Math.max(1, Math.round(th0 * previewScale));

      cropArea.style.width = `${tW}px`;
      cropArea.style.height = `${tH}px`;

      computeCoverScale();

      if (pixelView) {
        userScale = 1; // 1 image px per CSS px
        zoomSlider.min = 1;
        zoomSlider.max = Math.max(4, 1 * MAX_ZOOM_MULTIPLIER);
      } else {
        ensureUserScaleAtLeastCover();
        zoomSlider.min = coverScale;
        zoomSlider.max = coverScale * MAX_ZOOM_MULTIPLIER;
      }
      userScale = clamp(userScale, parseFloat(zoomSlider.min), parseFloat(zoomSlider.max));
      zoomSlider.value = userScale;

      constrainOffsets();
      applyTransform();
      updateZoomDisplay();
      updateStatus();
      persist();
    }

    function syncUIFromState() {
      widthInput.value = exportW;
      heightInput.value = exportH;
      roundingSelect.value = roundingPolicy;
      aspectSlider.min = String(RATIO_MIN);
      aspectSlider.max = String(RATIO_MAX);
      aspectSlider.value = aspectRatio;
      updateAspectUI();
      updateAspectDisplay();
      updateZoomDisplay();
      updateStatus();
    }

    function setAspect(nextRatio) {
      if (!aspectLocked) return; // ratio UI disabled in free mode
      aspectRatio = clamp(parseFloat(nextRatio) || aspectRatio, RATIO_MIN, RATIO_MAX);
      enforceDimensions();
      syncUIFromState();
      updateLayout();
    }

    function setWidthFromUI(val) {
      if (val === '' || val === null) return;
      exportW = Math.max(1, parseInt(val, 10) || 1);
      if (aspectLocked) lockedDimension = 'width';
      if (aspectLocked) enforceDimensions();
      else aspectRatio = clamp(exportW / Math.max(1, exportH), RATIO_MIN, RATIO_MAX);
      syncUIFromState(); updateLayout();
    }
    function setHeightFromUI(val) {
      if (val === '' || val === null) return;
      exportH = Math.max(1, parseInt(val, 10) || 1);
      if (aspectLocked) lockedDimension = 'height';
      if (aspectLocked) enforceDimensions();
      else aspectRatio = clamp(Math.max(1, exportW) / exportH, RATIO_MIN, RATIO_MAX);
      syncUIFromState(); updateLayout();
    }

    /* --------------------------- Build buttons --------------------------- */
    ratioPresets.forEach((r) => {
      const btn = document.createElement('button');
      btn.className = 'ratio-btn';
      btn.textContent = r.label;
      btn.onclick = () => setAspect(r.value);
      ratioGrid.appendChild(btn);
    });

    function rebuildSizeGrid() {
      sizeGrid.innerHTML = '';
      sizePresets.forEach((p) => {
        const btn = document.createElement('button');
        btn.className = 'size-btn' + (p.star ? ' star' : '');
        btn.textContent = p.label;
        btn.onclick = () => {
          exportW = p.w; exportH = p.h;
          aspectRatio = clamp(p.w / p.h, RATIO_MIN, RATIO_MAX);
          syncUIFromState(); updateLayout();
        };
        if (exportW === p.w && exportH === p.h) btn.classList.add('active');
        sizeGrid.appendChild(btn);
      });
    }
    rebuildSizeGrid();

    /* --------------------------- File handling --------------------------- */
    dropZone.onclick = () => fileInput.click();
    fileInput.onchange = (e) => {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) loadFile(file);
    };
    dropZone.ondragover = (e) => e.preventDefault();
    dropZone.ondrop = (e) => {
      e.preventDefault();
      const files = e.dataTransfer.files;
      if (files[0] && files[0].type.startsWith('image/')) loadFile(files[0]);
    };

    function loadFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          imgEl = img;
          natural = { w: img.naturalWidth, h: img.naturalHeight };

          if (!localStorage.getItem('UCT_SETTINGS_V2')) {
            aspectRatio = clamp(natural.w / natural.h, RATIO_MIN, RATIO_MAX);
            exportW = natural.w; exportH = natural.h; lockedDimension = 'width';
          }

          previewImg.src = img.src;
          previewImg.style.width = `${natural.w}px`;
          previewImg.style.height = `${natural.h}px`;

          dropZone.style.display = 'none';
          previewContainer.style.display = 'block';
          rightPanel.style.display = 'flex';

          offset = { x: 0, y: 0 };
          updateLayout();
          userScale = pixelView ? 1 : coverScale;
          zoomSlider.value = userScale;
          updateLayout();
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    /* ------------------------------ Events ------------------------------- */
    widthInput.addEventListener('input',  (e) => setWidthFromUI(e.target.value));
    widthInput.addEventListener('change', (e) => setWidthFromUI(e.target.value));
    heightInput.addEventListener('input',  (e) => setHeightFromUI(e.target.value));
    heightInput.addEventListener('change', (e) => setHeightFromUI(e.target.value));

    widthLock.onclick  = () => { lockedDimension = 'width';  updateAspectUI(); persist(); };
    heightLock.onclick = () => { lockedDimension = 'height'; updateAspectUI(); persist(); };

    aspectLockBtn.onclick = () => {
      aspectLocked = !aspectLocked;
      if (aspectLocked) { enforceDimensions(); } // reapply current ratio
      updateAspectUI(); syncUIFromState(); updateLayout();
    };

    roundingSelect.addEventListener('change', (e) => {
      roundingPolicy = e.target.value;
      enforceDimensions(); syncUIFromState(); updateLayout();
    });

    aspectSlider.addEventListener('input', (e) => setAspect(parseFloat(e.target.value)));

    zoomSlider.addEventListener('input', (e) => {
      userScale = parseFloat(e.target.value);
      updateZoomDisplay(); updateLayout();
    });

    fitCoverBtn.onclick = () => { pixelView = false; updateLayout(); pixelViewBtn.textContent = 'Pixel View: Off'; };
    pixelViewBtn.onclick = () => { pixelView = !pixelView; pixelViewBtn.textContent = `Pixel View: ${pixelView?'On':'Off'}`; updateLayout(); };

    guidesToggle.onclick = () => {
      guides.classList.toggle('on');
      guidesToggle.textContent = guides.classList.contains('on') ? 'Guides: On' : 'Guides: Off';
      persist();
    };

    cropArea.onmousedown = (e) => { isDragging = true; lastPt = { x: e.clientX, y: e.clientY }; };
    document.onmousemove = (e) => {
      if (!isDragging) return;
      const dx = e.clientX - lastPt.x, dy = e.clientY - lastPt.y;
      lastPt = { x: e.clientX, y: e.clientY };
      offset.x += dx; offset.y += dy;
      constrainOffsets(); applyTransform();
    };
    document.onmouseup = () => { isDragging = false; };

    cropArea.onwheel = (e) => {
      e.preventDefault();
      const delta = e.deltaY < 0 ? 0.05 : -0.05;
      userScale = clamp(userScale + delta, pixelView ? 1 : coverScale, parseFloat(zoomSlider.max));
      zoomSlider.value = userScale;
      updateZoomDisplay(); updateLayout();
    };

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && rightPanel.style.display === 'flex') downloadBtn.click();
      if (!e.ctrlKey && e.key >= '1' && e.key <= '9' && aspectLocked) {
        const idx = parseInt(e.key, 10) - 1;
        if (ratioPresets[idx]) setAspect(ratioPresets[idx].value);
      }
      if (e.ctrlKey && e.key === '1') { const p = sizePresets[0]; exportW = p.w; exportH = p.h; aspectRatio = clamp(p.w/p.h, RATIO_MIN, RATIO_MAX); syncUIFromState(); updateLayout(); }
      const step = e.shiftKey ? 10 : 1;
      if (['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)) {
        if (e.key === 'ArrowLeft') offset.x -= step;
        if (e.key === 'ArrowRight') offset.x += step;
        if (e.key === 'ArrowUp') offset.y -= step;
        if (e.key === 'ArrowDown') offset.y += step;
        constrainOffsets(); applyTransform();
      }
    });

    let resizeRAF = 0;
    window.addEventListener('resize', () => {
      cancelAnimationFrame(resizeRAF);
      resizeRAF = requestAnimationFrame(updateLayout);
    });

    downloadBtn.onclick = () => {
      if (!imgEl) return;
      const canvas = document.createElement('canvas');
      canvas.width = exportW; canvas.height = exportH;
      const ctx = canvas.getContext('2d');

      ctx.save();
      ctx.translate(exportW/2, exportH/2);
      const rx = exportW / tW;
      const ry = exportH / tH;
      ctx.translate(offset.x * rx, offset.y * ry);
      const s = Math.max(userScale, coverScale);
      ctx.scale(s * rx, s * ry);
      ctx.drawImage(imgEl, -natural.w/2, -natural.h/2);
      ctx.restore();

      const name = (filenameInput.value || 'cropped_image').trim();
      const a = document.createElement('a');
      a.download = `${name}_${Math.floor(1000 + Math.random()*9000)}.jpg`;
      a.href = canvas.toDataURL('image/jpeg', 0.92);
      a.click();
    };

    /* ---------------------------- Boot sequence -------------------------- */
    // Restore settings then init UI (even before image load)
    try { restore(); } catch(e) {}
    // Build ratio & size grids are already built
    // Reflect restored toggles
    pixelViewBtn.textContent = `Pixel View: ${pixelView?'On':'Off'}`;
    guidesToggle.textContent = guides.classList.contains('on') ? 'Guides: On' : 'Guides: Off';
    syncUIFromState();

  })();
  </script>
</body>
</html>
