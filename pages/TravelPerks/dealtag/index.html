<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Supplier Promo Tagger (Strict Mode)</title>
<style>
  :root { --bg:#1a1a1a; --panel:#242424; --ink:#fff; --muted:#b7b7b7; --accent:#FFD700; --ok:#39d353; --warn:#ffa657; --bad:#ff6b6b; --rowpad:8px; }
  * { box-sizing:border-box; }
  html, body { height:100%; }
  /* lock the page; the app itself handles scrolling */
  body { margin:0; overflow:hidden; font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, system-ui, sans-serif; background:var(--bg); color:var(--ink); }
  header { padding:12px 16px; border-bottom:1px solid #303030; display:flex; align-items:center; gap:12px; flex-wrap:wrap; }
  header h1 { font-size:18px; margin:0; letter-spacing:.2px; }
  header .muted { color:var(--muted); font-size:12px; }
  main { height:calc(100vh - 54px); padding:12px; }

  /* fixed two-column view that fills the viewport */
  .grid {
    height:100%;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:12px;
  }
  .panel { background:var(--panel); border:1px solid #2f2f2f; border-radius:10px; display:flex; flex-direction:column; min-width:0; min-height:0; }
  .panel h2 { margin:0; padding:8px 10px; border-bottom:1px solid #2f2f2f; font-size:12px; color:#e6e6e6; display:flex; align-items:center; justify-content:space-between; gap:8px; }
  .pill { font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid #3a3a3a; background:#202020; color:#dcdcdc; }
  .ok { border-color:#295c39; color:#b7ffd1; }
  .warn { border-color:#5a3d1a; color:#ffd9a6; }
  .bad { border-color:#5a1a1a; color:#ffbcbc; }

  .controls { padding:8px 10px; border-top:1px solid #2f2f2f; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .btn { background:#333; border:1px solid #444; color:#f1f1f1; padding:6px 10px; font-size:12px; border-radius:6px; cursor:pointer; }
  .btn:hover { background:#3a3a3a; }
  .hint { color:var(--muted); font-size:11px; }
  .toggle { display:flex; align-items:center; gap:6px; font-size:12px; }
  .toggle input { accent-color:var(--accent); }

  /* unified scroll area: both panes scroll; we sync positions */
  .scrollpane {
    flex:1;
    min-height:0;
    overflow:auto;
    padding:8px 10px;
  }
  /* hide the left scrollbar so you see just one; still scrolls */
  .scrollpane.left { scrollbar-width:none; }
  .scrollpane.left::-webkit-scrollbar { display:none; }

  /* input on the left, keep textarea full-height but non-resizable */
  textarea#input {
    width:100%;
    height:100%;
    border:0;
    resize:none;
    background:#1b1b1b;
    color:#f0f0f0;
    padding:10px;
    line-height:1.45;
    font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    outline:none;
  }

  /* output list (right) */
  .list { display:block; }
  .line {
    white-space:pre-wrap;
    font:12px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    padding: var(--rowpad) 0;
    border-bottom:1px dashed #2b2b2b;
    opacity:0;
    transform: translateY(6px);
    transition: opacity 160ms ease-out, transform 160ms ease-out;
    will-change: opacity, transform;
  }
  .line.show { opacity:1; transform: translateY(0); }
  .line:last-child { border-bottom:0; }

  /* small inline badge for tag */
  .tag { display:inline-block; min-width:20px; text-align:center; margin-right:8px; padding:1px 6px; border-radius:12px; border:1px solid #414141; color:#dcdcdc; background:#1f1f1f; }
  .tag.v { border-color:#295c39; color:#bfffd1; }
  .tag.d { border-color:#3c3c3c; color:#eaeaea; }
  .tag.ed { border-color:#5a3d1a; color:#ffd9a6; }
  .tag.X { border-color:#5a1a1a; color:#ffbcbc; }

  .status { padding:6px 10px; border-top:1px dashed #333; color:#9a9a9a; font-size:11px; }
</style>
</head>
<body>
<header>
  <h1>Supplier Promo Tagger (Strict Mode)</h1>
  <span class="muted">Fixed two-column view. Unknowns = “X”.</span>
</header>
<main>
  <div class="grid" id="grid">

    <!-- LEFT: INPUT (scrolls) -->
    <section class="panel">
      <h2>
        Input
        <span class="pill" id="inLines">0 lines</span>
      </h2>
      <div class="scrollpane left" id="leftPane">
        <textarea id="input" placeholder="Paste your full promo list here…"></textarea>
      </div>
      <div class="controls">
        <label class="toggle"><input type="checkbox" id="includeX" checked /> Include unknowns (X)</label>
        <button class="btn" id="run">Transform</button>
        <button class="btn" id="copy">Copy Output</button>
        <span id="note" class="hint"></span>
      </div>
      <div class="status">Page doesn’t move on paste; both columns scroll together.</div>
    </section>

    <!-- RIGHT: OUTPUT (scrolls, synced) -->
    <section class="panel">
      <h2>
        Output
        <span>
          <span class="pill ok" id="vendors">v:0</span>
          <span class="pill" id="deals">d:0</span>
          <span class="pill warn" id="excl">ed:0</span>
          <span class="pill bad" id="unknown">X:0</span>
        </span>
      </h2>
      <div class="scrollpane" id="rightPane">
        <div class="list" id="outputList" aria-live="polite"></div>
      </div>
      <div class="controls">
        <span class="hint">Staggered fade/slide renders (8ms per line) for a rolling effect.</span>
      </div>
    </section>

  </div>
</main>

<script>
/* =================== CONFIG =================== */
const STRICT_SUPPLIERS = true;
const FAMILY_ALIASES_ALLOWED = false;

const aliases = new Map(Object.entries({
  "msc":"msc cruises",
  "celebrity":"celebrity cruises",
  "holland":"holland america line",
  "holland america":"holland america line",
  "rcl":"royal caribbean",
  "ncl":"norwegian",
  "oceania":"oceania cruises",
  "paul gauguin":"paul gauguin cruises",
  "disney world":"disneyworld",
  "disneyland":"disneyland",
  "avalon":"avalon waterways",
  "crystal":"crystal cruises",
  "walt disney world":"disneyworld",
  "globus":"globus journeys",
  "riu":"riu hotels & resorts",
  "regent seven seas":"regent seven seas cruises",
  "amawaterways":"ama waterways"
}));
const familyAliases = new Map(Object.entries({}));

/* ============== SUPPLIER MASTER LIST (same as yours) ============== */
const suppliers = [
  {name: "Abercrombie & Kent", url: "abercrombie-kent", cats: ["tour"]},
  {name: "Adventures by Disney", url: "adventures-by-disney", cats: ["dis", "tour"]},
  {name: "African Travel", url: "african-travel", cats: ["tour"]},
  {name: "Ama Waterways", url: "ama", cats: ["riv"]},
  {name: "American Airline Vacations", url: "american-airline-vacations", cats: ["res"]},
  {name: "American Cruise Line", url: "american-cruise-line", cats: ["lux", "riv"]},
  {name: "Atlantis Paradise Island Bahamas", url: "atlantis", cats: ["res"]},
  {name: "Atlas Ocean Voyages", url: "atlas", cats: ["lux"]},
  {name: "Aulani, A Disney Resort & Spa", url: "disney-aulani", cats: ["dis", "res"]},
  {name: "Avalon Waterways", url: "avalon", cats: ["riv"]},
  {name: "Azamara", url: "azamara", cats: ["lux"]},
  {name: "Beaches", url: "beaches", cats: ["res"]},
  {name: "BlueSky Tours", url: "bluesky-tours", cats: ["tour"]},
  {name: "Breathless", url: "breathless", cats: ["res"]},
  {name: "Carnival", url: "carnival", cats: ["pop"]},
  {name: "Celebrity Cruises", url: "celebrity", cats: ["pop"]},
  {name: "CIE Tours", url: "cie", cats: ["tour"]},
  {name: "Club Med", url: "club-med", cats: ["res"]},
  {name: "Collette", url: "collette", cats: ["tour"]},
  {name: "Costa Cruises", url: "costa", cats: ["pop"]},
  {name: "CroisiEurope", url: "croisieurope", cats: ["riv"]},
  {name: "Crystal Cruises", url: "crystal", cats: ["lux"]},
  {name: "Cunard", url: "cunard", cats: ["lux"]},
  {name: "Delta Vacations", url: "delta-vacations", cats: ["res"]},
  {name: "Disney Cruise Line", url: "disney-cruise-line", cats: ["pop", "dis"]},
  {name: "Disneyland", url: "disneyland", cats: ["dis", "res"]},
  {name: "DisneyWorld", url: "disneyworld", cats: ["dis", "res"]},
  {name: "Dreams", url: "dreams", cats: ["res"]},
  {name: "El Dorado Spa Resorts & Hotels", url: "el-dorado", cats: ["res"]},
  {name: "Emerald Cruises", url: "emerald", cats: ["lux"]},
  {name: "Excellence Resorts", url: "excellence", cats: ["res"]},
  {name: "Explora Journeys", url: "explora", cats: ["lux"]},
  {name: "Four Seasons Yachts", url: "four-seasons-yachts", cats: ["lux"]},
  {name: "Funjet", url: "funjet", cats: ["res"]},
  {name: "G Adventures", url: "g-adventures", cats: ["tour"]},
  {name: "Globus Journeys", url: "globus", cats: ["tour"]},
  {name: "Great Safaris", url: "great-safaris", cats: ["tour"]},
  {name: "Hard Rock Hotels", url: "hardrock", cats: ["res"]},
  {name: "Holland America Line", url: "holland-america", cats: ["pop"]},
  {name: "HX Expeditions", url: "hurtigruten", cats: ["adv"]},
  {name: "Iberostar Hotels & Resorts", url: "iberostar", cats: ["res"]},
  {name: "Karisma Hotels & Resorts", url: "karisma", cats: ["res"]},
  {name: "Lindblad Expeditions & National Geographic", url: "lindblad-national-geographic", cats: ["adv"]},
  {name: "Meet & Greet Italy", url: "meet-and-greet-italy", cats: ["tour"]},
  {name: "Melia", url: "melia", cats: ["res"]},
  {name: "MSC Cruises", url: "msc", cats: ["pop"]},
  {name: "Norwegian", url: "norwegian", cats: ["pop"]},
  {name: "Oceania Cruises", url: "oceania", cats: ["lux"]},
  {name: "Outrigger Hotels & Resorts", url: "outrigger", cats: ["res"]},
  {name: "Palace Resorts", url: "palace-resorts", cats: ["res"]},
  {name: "Paul Gauguin Cruises", url: "paul-gauguin", cats: ["lux"]},
  {name: "Ponant", url: "ponant", cats: ["lux"]},
  {name: "Princess", url: "princess", cats: ["pop"]},
  {name: "Regent Seven Seas Cruises", url: "regent", cats: ["lux"]},
  {name: "Ritz-Carlton Yacht Collection", url: "ritz-carlton-yacht-collection", cats: ["lux"]},
  {name: "RIU Hotels & Resorts", url: "riu", cats: ["res"]},
  {name: "Riverside Cruises", url: "riverside", cats: ["riv"]},
  {name: "Riviera River Cruises", url: "riviera", cats: ["riv"]},
  {name: "Roadtrips", url: "roadtrips", cats: ["tour"]},
  {name: "Rocky Mountaineer", url: "rocky-mountaineer", cats: ["tour", "rail"]},
  {name: "Royal Caribbean", url: "royal-caribbean", cats: ["pop"]},
  {name: "Sandals", url: "sandals", cats: ["res"]},
  {name: "Scenic Eclipse Ocean Voyages", url: "scenic-eclipse", cats: ["lux", "adv"]},
  {name: "Scenic River", url: "scenic", cats: ["riv"]},
  {name: "Seabourn", url: "seabourn", cats: ["lux"]},
  {name: "Secrets", url: "secrets", cats: ["res"]},
  {name: "Silversea", url: "silversea", cats: ["lux"]},
  {name: "Southwest Vacations", url: "southwest-vacations", cats: ["res"]},
  {name: "Star Clippers", url: "star-clippers", cats: ["lux"]},
  {name: "Tauck Cruises", url: "tauck-cruises", cats: ["lux"]},
  {name: "Tauck Tours", url: "tauck-tours", cats: ["tour", "riv"]},
  {name: "Trafalgar", url: "trafalgar", cats: ["tour"]},
  {name: "UnCruise Adventures", url: "uncruise", cats: ["adv"]},
  {name: "United Vacations", url: "united-vacations", cats: ["res"]},
  {name: "Uniworld", url: "uniworld", cats: ["riv"]},
  {name: "Viking Ocean", url: "viking-ocean", cats: ["lux", "adv"]},
  {name: "Viking River", url: "viking-river", cats: ["riv"]},
  {name: "Villas of Distinction", url: "villas-of-distinction", cats: ["res"]},
  {name: "Virgin Voyages", url: "virgin", cats: ["pop"]},
  {name: "Windstar", url: "windstar", cats: ["lux"]},
  {name: "Zoëtry Wellness & Spa Resorts", url: "zoetry", cats: ["res"]}
].sort((a,b)=>a.name.localeCompare(b.name));

/* ============== HELPERS & MATCHING ============== */
const norm = s => s.toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'')
  .replace(/&/g,' and ').replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();

// Generic industry words that should NOT drive fuzzy matches
const STOP_TOKENS = new Set([
  "vacations","vacation",
  "tours","tour",
  "travel","travels",
  "holidays","holiday",
  "cruises","cruise",
  "resorts","resort",
  "hotels","hotel",
  "journeys","journey",
  "adventures","adventure"
]);

const tokens = s =>
  new Set(
    norm(s)
      .split(' ')
      .filter(w => w.length > 1 && !STOP_TOKENS.has(w))
  );

const supplierIndex = suppliers.map(s=>({ raw:s.name, n:norm(s.name), toks:tokens(s.name) }));
function jaccard(a,b){ let i=0; for(const x of a){ if(b.has(x)) i++; } return i/(a.size+b.size-i||1); }

function bestSupplierMatch(name){
  const raw = name.replace(/^•\s*/,''), n = norm(raw);
  if(!n) return {score:0,match:null,via:""};
  const a1 = aliases.get(n); let normalized = a1 ? norm(a1) : n;
  if(FAMILY_ALIASES_ALLOWED){ const a2 = familyAliases.get(n); if(a2) normalized = norm(a2); }
  const exact = supplierIndex.find(s=>s.n === normalized);
  if(exact) return {score:1,match:exact.raw,via: a1 ? "alias" : "exact"};
  const t = tokens(normalized); let best = {score:0,match:null,via:"jaccard"};
  for(const s of supplierIndex){
    const sc = jaccard(t, s.toks);
    if(sc>best.score) best={score:sc,match:s.raw,via:"jaccard"};
  }
  return best;
}

const SECTION_HEADING = /(offers?)\s*:?\s*$/i;
const DATE_RE = /(?:\b\d{1,2}\/\d{1,2}(?:\/\d{2,4})?\b|\b(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sept?|Oct|Nov|Dec)[a-z]*\b\s*\d{1,2},?\s*\d{2,4})/i;
const DEAL_MARKER = /(ends?\b|ongoing\b|end\s*date\b|valid\s*(?:through|until)\b|expires?\b)/i;
const DEAL_CUES = /\b(save|savings?|off|deposit|gratuities|obc|upgrade|kids\s+sail\s+free|reduced)\b/i;

function isExclusiveLine(t){ return /\bTLN\b/i.test(t) || /\bEXCLUSIVE\b/.test(t) || /^\s*(?:•\s*)?Exclusive\s*[:\-]/i.test(t); }
function looksLikeDeal(t){
  if(!t.trim()||SECTION_HEADING.test(t)) return false;
  if(isExclusiveLine(t)) return true;
  if(DEAL_MARKER.test(t)||DATE_RE.test(t)) return true;
  if(DEAL_CUES.test(t)&&/[%$]|\bup to\b|\d/.test(t)) return true;
  return false;
}

/* Canonical vendor label: TTC Tour Brands -> Trafalgar, everything else stays as-typed (minus bullet) */
function canonicalVendorLabel(line){
  let stripped = line.replace(/^•\s*/,'').trim();
  // TTC Tour Brands (any junk after it) should collapse to Trafalgar
  if (/^TTC\s+Tour\s+Brands\b/i.test(stripped)) {
    return "Trafalgar";
  }
  return stripped;
}

/* vendor detection: tolerant of :, (), commas, but still rejects promo headings */
function looksLikeVendorCandidate(t){
  if(!t.trim()||SECTION_HEADING.test(t)) return false;
  if(looksLikeDeal(t)) return false;

  // If it smells like a promo name, don't treat as vendor
  if(/\b(sale|offer|offers|promo|promotion|deal|special)\b/i.test(t)) return false;

  // Strip bullet and trivial trailing punctuation for detection
  let trimmed = t.replace(/^•\s*/,'').trim();
  trimmed = trimmed.replace(/[:*†\-\u2013\u2014]+$/,'').trim();
  if(!trimmed) return false;

  // Collapse parenthetical brand lists for the *check* only
  const detectText = trimmed.replace(/\([^)]*\)/g,'').trim() || trimmed;
  if(!detectText) return false;

  // If what's left looks like a sentence with obvious punctuation, bail
  if(/[.!?].+/.test(detectText)) return false;

  let words = detectText.split(/\s+/);
  if(words.length>10) return false;

  // Strip trailing commas/semicolons on each word for the "proper name" check
  words = words.map(w => w.replace(/[,:;]+$/,''));

  // Allow / and () so "Scenic/Emerald Cruises" still passes
  const properish = words.every(w=>/^[A-Za-z&.\-’'()/]+$/.test(w));
  return properish;
}

function isKnownSupplier(line){
  const label = canonicalVendorLabel(line);
  const {score,via}=bestSupplierMatch(label.trim());
  return STRICT_SUPPLIERS
    ? (via==="alias"||via==="exact"||(via==="jaccard"&&score>=0.3))
    : (score>=0.34||via==="alias");
}
function isContinuation(line){ return /^\s*(\(|–|-)/.test(line); }

/* ============== TRANSFORM ============== */
function transform(raw, {includeUnknowns=true} = {}){
  const lines=raw.replace(/\r\n/g,"\n").split("\n");
  const out=[]; let lastIndex=-1; let currentKnown=null; let lastWasDeal=false;
  let vendorCount=0,dealCount=0,exclCount=0,unknownCount=0;

  for(const orig of lines){
    const vis=orig.trim(); if(!vis) continue;

    if(SECTION_HEADING.test(vis)){ currentKnown=null; lastWasDeal=false; lastIndex=-1; continue; }

    // glue continuations to the previous emitted line (only if we actually emitted it)
    if(isContinuation(orig) && lastWasDeal && lastIndex>=0){
      out[lastIndex] = out[lastIndex] + " " + orig.trimStart();
      continue;
    }

    if(looksLikeDeal(orig)){
      const ex=isExclusiveLine(orig); let tag=ex?"ed":"d";
      if(currentKnown===false) tag="X"; else { if(ex)exclCount++; dealCount++; }
      const lineText = `${tag}\t${orig}`;
      if(tag!=="X" || includeUnknowns){
        out.push(lineText); lastWasDeal=true; lastIndex=out.length-1;
      } else {
        // we skipped emitting an unknown deal; treat as not gluable
        lastWasDeal=false; lastIndex=-1;
      }
      continue;
    }

    if(looksLikeVendorCandidate(orig)){
      if(isKnownSupplier(orig)){
        const label = canonicalVendorLabel(orig);
        vendorCount++; const lineText=`v\t${label}`;
        out.push(lineText); currentKnown=true; lastWasDeal=false; lastIndex=out.length-1;
      } else {
        unknownCount++; currentKnown=false; lastWasDeal=false;
        if(includeUnknowns){ out.push(`X\t${orig}`); lastIndex=out.length-1; } else { lastIndex=-1; }
      }
      continue;
    }
  }

  return {
    text: out.join("\n"),
    stats: { vendors:vendorCount, deals:dealCount, excl:exclCount, unknownSuppliers:unknownCount, lines:lines.length }
  };
}

/* =================== UI WIRING + SCROLL SYNC + ANIMATION =================== */
const $ = s => document.querySelector(s);
const input = $('#input');
const includeX = $('#includeX');
const leftPane = $('#leftPane');
const rightPane = $('#rightPane');
const outputList = $('#outputList');
const note = $('#note');
const inLines = $('#inLines'), vendors = $('#vendors'), deals = $('#deals'), excl = $('#excl'), unknown = $('#unknown');
const runBtn = $('#run'), copyBtn = $('#copy');

let lastOutputText = "";

/* scroll sync: keep panes moving together, show only the right scrollbar */
let syncing = false;
function sync(from, to){
  if(syncing) return;
  syncing = true;
  const maxFrom = Math.max(1, from.scrollHeight - from.clientHeight);
  const ratio = from.scrollTop / maxFrom;
  const maxTo = Math.max(1, to.scrollHeight - to.clientHeight);
  to.scrollTop = ratio * maxTo;
  syncing = false;
}
leftPane.addEventListener('scroll', ()=> sync(leftPane, rightPane));
rightPane.addEventListener('scroll', ()=> sync(rightPane, leftPane));

/* render with staggered animation (8ms per line) */
const STAGGER_MS = 8;
function renderAnimatedLines(container, lines){
  container.innerHTML = '';
  const frag = document.createDocumentFragment();
  for(let i=0;i<lines.length;i++){
    const raw = lines[i];
    const tag = raw.split('\t',1)[0];
    const text = raw.slice(tag.length+1);

    const div = document.createElement('div');
    div.className = 'line';
    div.style.transitionDelay = (i * STAGGER_MS) + 'ms';

    const badge = document.createElement('span');
    badge.className = 'tag ' + tag;
    badge.textContent = tag;

    const span = document.createElement('span');
    span.textContent = '\t' + text;

    div.appendChild(badge);
    div.appendChild(span);
    frag.appendChild(div);
  }
  container.appendChild(frag);
  requestAnimationFrame(() => {
    for(const el of container.children){ el.classList.add('show'); }
  });
}

function run(){
  const res = transform(input.value, { includeUnknowns: includeX.checked });
  lastOutputText = res.text;

  const lines = res.text ? res.text.split('\n') : [];
  renderAnimatedLines(outputList, lines);

  inLines.textContent = `${res.stats.lines} lines`;
  vendors.textContent = `v:${res.stats.vendors}`;
  deals.textContent = `d:${res.stats.deals}`;
  excl.textContent = `ed:${res.stats.excl}`;
  unknown.textContent = `X:${res.stats.unknownSuppliers}`;
  note.textContent = '';

  // keep viewport stable and panes synced
  sync(leftPane, rightPane);
}

runBtn.addEventListener('click', run);
includeX.addEventListener('change', run);
input.addEventListener('input', ()=>{
  inLines.textContent = `${input.value.split(/\n/).length} lines`;
  // Optional: auto-run on paste/type -> uncomment next line if you want live transform
  // run();
});
copyBtn.addEventListener('click', ()=>{
  navigator.clipboard.writeText(lastOutputText || '').then(()=>{
    note.textContent = 'Output copied.';
    setTimeout(()=> note.textContent = '', 1000);
  });
});

// focus input on load; keep placeholder vibe
setTimeout(()=> input.placeholder = "Paste your 'Contemporary Cruise Offers' blob here…", 250);
</script>
</body>
</html>
