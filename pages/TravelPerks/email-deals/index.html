<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weekly Hot Deals Selector</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f5f5f0;
      --surface: #ffffff;
      --text: #1a1a1a;
      --text-muted: #666666;
      --accent: #2563eb;
      --accent-light: #dbeafe;
      --success: #059669;
      --success-light: #d1fae5;
      --warning: #d97706;
      --warning-light: #fef3c7;
      --border: #e5e5e5;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 4px 12px rgba(0,0,0,0.04);
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 2rem;
      min-height: 100vh;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 2.5rem;
    }
    
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 0.25rem;
    }
    
    .subtitle {
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    
    .card {
      background: var(--surface);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }
    
    .card-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    
    .step-number {
      width: 28px;
      height: 28px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.85rem;
      flex-shrink: 0;
    }
    
    .card-title {
      font-size: 1.1rem;
      font-weight: 600;
    }
    
    .card-description {
      font-size: 0.85rem;
      color: var(--text-muted);
    }
    
    .form-group {
      margin-bottom: 1.25rem;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: var(--text);
    }
    
    .label-hint {
      font-weight: 400;
      color: var(--text-muted);
    }
    
    select {
      width: 100%;
      padding: 0.65rem 0.9rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font: inherit;
      font-size: 0.9rem;
      background: var(--surface);
      cursor: pointer;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-light);
    }
    
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .chip {
      padding: 0.4rem 0.85rem;
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.15s;
      background: var(--surface);
      user-select: none;
    }
    
    .chip:hover:not(.disabled) {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    
    .chip.active {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    
    .chip.locked {
      background: var(--success-light);
      border-color: var(--success);
      color: var(--success);
      cursor: default;
    }
    
    .chip.locked::before {
      content: "âœ“ ";
    }
    
    .chip.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .active-potm-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    
    .active-potm-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.75rem;
      background: var(--warning-light);
      border: 1px solid var(--warning);
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
      color: #92400e;
    }
    
    .active-potm-tag .remove {
      cursor: pointer;
      opacity: 0.7;
      font-size: 1rem;
      line-height: 1;
    }
    
    .active-potm-tag .remove:hover {
      opacity: 1;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.7rem 1.4rem;
      border: none;
      border-radius: 8px;
      font: inherit;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .btn-primary {
      background: var(--accent);
      color: white;
      width: 100%;
    }
    
    .btn-primary:hover {
      background: #1d4ed8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }
    
    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg);
    }
    
    .results-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      color: white;
    }
    
    .results-card .card-header {
      border-bottom-color: rgba(255,255,255,0.15);
    }
    
    .results-card .step-number {
      background: rgba(255,255,255,0.2);
    }
    
    .results-empty {
      text-align: center;
      padding: 2rem;
      color: rgba(255,255,255,0.6);
    }
    
    .results-list {
      list-style: none;
    }
    
    .results-list li {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .results-list li:last-child {
      border-bottom: none;
    }
    
    .result-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }
    
    .badge-potm {
      background: #fbbf24;
      color: #78350f;
    }
    
    .badge-spotlight {
      background: #a78bfa;
      color: #3b0764;
    }
    
    .badge-priority {
      background: rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.8);
    }
    
    .result-name {
      flex: 1;
      font-weight: 500;
    }
    
    .copy-section {
      margin-top: 1.25rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.15);
      display: flex;
      gap: 0.75rem;
    }
    
    .btn-copy {
      flex: 1;
      background: rgba(255,255,255,0.1);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .btn-copy:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .btn-copy.copied {
      background: var(--success);
      border-color: var(--success);
    }
    
    /* Deal Lister Section */
    .divider {
      height: 1px;
      background: var(--border);
      margin: 2.5rem 0;
    }
    
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .file-upload-area {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .file-upload-area:hover {
      border-color: var(--accent);
      background: var(--accent-light);
    }
    
    .file-upload-area.has-file {
      border-style: solid;
      border-color: var(--success);
      background: var(--success-light);
    }
    
    .upload-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .upload-text {
      font-size: 0.9rem;
      color: var(--text-muted);
    }
    
    .upload-text strong {
      color: var(--accent);
    }
    
    .file-name {
      font-weight: 500;
      color: var(--success);
    }
    
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .filter-bar .chip-container {
      flex: 1;
    }
    
    .deal-list {
      list-style: none;
      max-height: 60vh;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }
    
    .deal-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 0.5rem 1rem;
      align-items: start;
    }
    
    .deal-item:last-child {
      border-bottom: none;
    }
    
    .deal-star {
      color: var(--warning);
      font-size: 1.25rem;
    }
    
    .deal-supplier {
      font-weight: 600;
      color: var(--accent);
      grid-column: 2;
    }
    
    .deal-title-row {
      grid-column: 2;
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    
    .deal-title {
      font-weight: 500;
    }
    
    .deal-expiry {
      font-size: 0.8rem;
      color: var(--text-muted);
      background: var(--bg);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
    }
    
    .deal-description {
      grid-column: 2;
      font-size: 0.85rem;
      color: var(--text-muted);
      white-space: pre-wrap;
    }
    
    .deal-remove {
      grid-column: 3;
      grid-row: 1 / span 3;
      background: none;
      border: none;
      color: #dc2626;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.5rem;
      opacity: 0.6;
      transition: opacity 0.15s;
    }
    
    .deal-remove:hover {
      opacity: 1;
    }
    
    .placeholder {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }
    
    .inline-flex {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .help-text {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }

    .count-badge {
      background: var(--accent-light);
      color: var(--accent);
      padding: 0.1rem 0.5rem;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Weekly Hot Deals Selector</h1>
      <p class="subtitle">Select this month's partners and compute your weekly rotation</p>
    </header>

    <!-- Step 1: This Month's POTMs -->
    <div class="card">
      <div class="card-header">
        <span class="step-number">1</span>
        <div>
          <div class="card-title">This Month's Partners</div>
          <div class="card-description">Select POTMs and any active spotlights</div>
        </div>
      </div>
      
      <div class="form-group">
        <label>Popular POTM <span class="label-hint">(required)</span></label>
        <select id="popular-potm">
          <option value="">â€” Select Popular POTM â€”</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Luxury/River POTM <span class="label-hint">(optional)</span></label>
        <select id="luxury-potm">
          <option value="">â€” None this month â€”</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Active Spotlights <span class="label-hint">(click to add)</span></label>
        <select id="spotlight-select">
          <option value="">â€” Add a spotlight â€”</option>
        </select>
        <div id="active-spotlights" class="active-potm-list"></div>
      </div>
    </div>

    <!-- Step 2: This Week's Active Partners -->
    <div class="card">
      <div class="card-header">
        <span class="step-number">2</span>
        <div>
          <div class="card-title">Active This Week</div>
          <div class="card-description">Which POTMs/Spotlights are running this week? (Some run half-month only)</div>
        </div>
      </div>
      
      <div id="active-this-week-container">
        <p class="help-text">Select your POTMs above first</p>
      </div>
    </div>

    <!-- Step 3: Last Week's Below-the-Fold -->
    <div class="card">
      <div class="card-header">
        <span class="step-number">3</span>
        <div>
          <div class="card-title">Last Week's Below-the-Fold</div>
          <div class="card-description">Select up to 4 partners from last week (excluding POTMs)</div>
        </div>
      </div>
      
      <div id="lastweek-chips" class="chip-container">
        <!-- Populated by JS -->
      </div>
      <p class="help-text">Selected: <span id="lastweek-count">0</span>/4</p>
    </div>

    <!-- Compute Button -->
    <button id="compute-btn" class="btn btn-primary">
      Compute This Week's Hot Deals Lineup
    </button>

    <!-- Results -->
    <div class="card results-card" style="margin-top: 1.5rem;">
      <div class="card-header">
        <span class="step-number">âœ“</span>
        <div>
          <div class="card-title">This Week's Hot Deals Lineup</div>
          <div class="card-description" style="color: rgba(255,255,255,0.6);">Partners to feature in the deals section</div>
        </div>
      </div>
      
      <div id="results-container">
        <div class="results-empty">Complete steps above and click compute</div>
      </div>
      
      <div class="copy-section" id="copy-section" style="display: none;">
        <button class="btn btn-copy" id="copy-names-btn">Copy Partner Names</button>
      </div>
    </div>

    <!-- Deal Lister Section -->
    <div class="divider"></div>
    
    <h2 class="section-title">Deal Lister</h2>
    <p class="subtitle" style="margin-bottom: 1rem;">Upload your deals JSON to filter and copy deals for the selected partners</p>
    
    <div class="card">
      <label for="json-file" class="file-upload-area" id="upload-area">
        <div class="upload-icon">ðŸ“„</div>
        <div class="upload-text"><strong>Click to upload</strong> deals JSON file</div>
        <input type="file" id="json-file" accept=".json" class="sr-only">
      </label>
      
      <div id="deal-filters" style="display: none; margin-top: 1rem;">
        <div class="filter-bar">
          <label class="inline-flex">
            <input type="checkbox" id="filter-rotator"> 
            <span>Only show computed partners</span>
          </label>
          <label class="inline-flex">
            <input type="checkbox" id="filter-exclusive">
            <span>Only exclusives</span>
          </label>
        </div>
        
        <div class="form-group">
          <label>Filter by supplier:</label>
          <div id="supplier-chips" class="chip-container"></div>
        </div>
      </div>
    </div>
    
    <div id="deal-list-container" class="card" style="display: none; padding: 0;">
      <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
        <span><strong id="deal-count">0</strong> deals</span>
        <button class="btn btn-secondary" id="copy-deals-btn">Copy Selected Deals</button>
      </div>
      <ul class="deal-list" id="deal-list"></ul>
    </div>
  </div>

  <script>
(function() {
  // === DATA ===
  const ALL_PARTNERS = [
    // Cruise - Popular
    { name: 'Norwegian Cruise Line', short: 'Norwegian', category: 'popular' },
    { name: 'Royal Caribbean', short: 'Royal Caribbean', category: 'popular' },
    { name: 'Celebrity Cruises', short: 'Celebrity', category: 'popular' },
    { name: 'Disney Cruise Line', short: 'Disney Cruise Line', category: 'popular' },
    { name: 'Virgin Voyages', short: 'Virgin Voyages', category: 'popular' },
    { name: 'Holland America Line', short: 'Holland America', category: 'popular' },
    { name: 'Princess Cruises', short: 'Princess', category: 'popular' },
    { name: 'Carnival Cruise Line', short: 'Carnival', category: 'popular' },
    { name: 'MSC Cruises', short: 'MSC', category: 'popular' },
    // Cruise - Luxury/River
    { name: 'Viking Ocean Cruises', short: 'Viking Ocean', category: 'luxury' },
    { name: 'Viking River Cruises', short: 'Viking River', category: 'luxury' },
    { name: 'Seabourn', short: 'Seabourn', category: 'luxury' },
    { name: 'Regent Seven Seas Cruises', short: 'Regent', category: 'luxury' },
    { name: 'Oceania Cruises', short: 'Oceania', category: 'luxury' },
    { name: 'Silversea', short: 'Silversea', category: 'luxury' },
    { name: 'Explora Journeys', short: 'Explora', category: 'luxury' },
    { name: 'Azamara', short: 'Azamara', category: 'luxury' },
    { name: 'AmaWaterways', short: 'AmaWaterways', category: 'luxury' },
    { name: 'Avalon Waterways', short: 'Avalon', category: 'luxury' },
    { name: 'Uniworld Boutique River Cruises', short: 'Uniworld', category: 'luxury' },
    { name: 'Scenic River Cruises', short: 'Scenic River', category: 'luxury' },
    { name: 'Scenic Eclipse', short: 'Scenic Eclipse', category: 'luxury' },
    { name: 'Crystal Cruises', short: 'Crystal', category: 'luxury' },
    { name: 'Cunard', short: 'Cunard', category: 'luxury' },
    { name: 'Windstar Cruises', short: 'Windstar', category: 'luxury' },
    { name: 'Paul Gauguin Cruises', short: 'Paul Gauguin', category: 'luxury' },
    { name: 'Ponant', short: 'Ponant', category: 'luxury' },
    { name: 'Ritz-Carlton Yacht Collection', short: 'Ritz-Carlton Yacht', category: 'luxury' },
    { name: 'Four Seasons Yachts', short: 'Four Seasons Yachts', category: 'luxury' },
    // Expedition
    { name: 'Lindblad Expeditions', short: 'Lindblad', category: 'expedition' },
    { name: 'Hurtigruten', short: 'Hurtigruten', category: 'expedition' },
    { name: 'UnCruise Adventures', short: 'UnCruise', category: 'expedition' },
    { name: 'Atlas Ocean Voyages', short: 'Atlas', category: 'expedition' },
    // Tours
    { name: 'Globus Journeys', short: 'Globus', category: 'tour' },
    { name: 'Trafalgar', short: 'Trafalgar', category: 'tour' },
    { name: 'Collette', short: 'Collette', category: 'tour' },
    { name: 'CIE Tours', short: 'CIE Tours', category: 'tour' },
    { name: 'G Adventures', short: 'G Adventures', category: 'tour' },
    { name: 'Abercrombie & Kent', short: 'A&K', category: 'tour' },
    { name: 'Tauck Cruises', short: 'Tauck', category: 'tour' },
    { name: 'Rocky Mountaineer', short: 'Rocky Mountaineer', category: 'tour' },
    // Disney
    { name: 'DisneyWorld', short: 'DisneyWorld', category: 'disney' },
    { name: 'Disneyland', short: 'Disneyland', category: 'disney' },
    { name: 'Aulani', short: 'Aulani', category: 'disney' },
    { name: 'Adventures by Disney', short: 'Adventures by Disney', category: 'disney' },
    // Resorts
    { name: 'Sandals', short: 'Sandals', category: 'resort' },
    { name: 'Beaches Resorts', short: 'Beaches', category: 'resort' },
    { name: 'Club Med', short: 'Club Med', category: 'resort' },
    { name: 'Atlantis Paradise Island', short: 'Atlantis', category: 'resort' },
    { name: 'Hard Rock Hotels', short: 'Hard Rock', category: 'resort' },
    { name: 'Excellence Resorts', short: 'Excellence', category: 'resort' },
    { name: 'Secrets Resorts', short: 'Secrets', category: 'resort' },
    { name: 'Dreams Resorts', short: 'Dreams', category: 'resort' },
    { name: 'Breathless Resorts', short: 'Breathless', category: 'resort' },
    { name: 'Palace Resorts', short: 'Palace', category: 'resort' },
    { name: 'RIU Hotels & Resorts', short: 'RIU', category: 'resort' },
    { name: 'Iberostar Hotels & Resorts', short: 'Iberostar', category: 'resort' },
    // Vacations
    { name: 'Delta Vacations', short: 'Delta Vacations', category: 'vacation' },
    { name: 'American Airlines Vacations', short: 'AA Vacations', category: 'vacation' },
    { name: 'United Vacations', short: 'United Vacations', category: 'vacation' },
    { name: 'Southwest Vacations', short: 'Southwest Vacations', category: 'vacation' },
  ].sort((a, b) => a.short.localeCompare(b.short));

  // Priority tiers for filling slots
  const PRIORITY_TIERS = [
    ['Norwegian Cruise Line', 'Royal Caribbean'],
    ['Celebrity Cruises', 'Disney Cruise Line', 'Virgin Voyages', 'Holland America Line', 'Princess Cruises'],
    ['Carnival Cruise Line', 'MSC Cruises']
  ];

  // === STATE ===
  let state = {
    popularPotm: '',
    luxuryPotm: '',
    spotlights: [],
    activeThisWeek: [],
    lastWeekPartners: [],
    computedLineup: [],
    deals: [],
    filteredDeals: [],
    selectedDeals: [],
    supplierFilter: null,
    filterByRotator: false,
    filterExclusive: false
  };

  // === DOM REFS ===
  const $ = sel => document.querySelector(sel);
  const $$ = sel => [...document.querySelectorAll(sel)];

  const popularSelect = $('#popular-potm');
  const luxurySelect = $('#luxury-potm');
  const spotlightSelect = $('#spotlight-select');
  const activeSpotlightsDiv = $('#active-spotlights');
  const activeThisWeekDiv = $('#active-this-week-container');
  const lastWeekChipsDiv = $('#lastweek-chips');
  const lastWeekCountSpan = $('#lastweek-count');
  const computeBtn = $('#compute-btn');
  const resultsContainer = $('#results-container');
  const copySection = $('#copy-section');
  const copyNamesBtn = $('#copy-names-btn');
  const jsonFileInput = $('#json-file');
  const uploadArea = $('#upload-area');
  const dealFilters = $('#deal-filters');
  const dealListContainer = $('#deal-list-container');
  const dealList = $('#deal-list');
  const dealCountSpan = $('#deal-count');
  const filterRotatorCheck = $('#filter-rotator');
  const filterExclusiveCheck = $('#filter-exclusive');
  const supplierChipsDiv = $('#supplier-chips');
  const copyDealsBtn = $('#copy-deals-btn');

  // === HELPERS ===
  function escapeHtml(str) {
    return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function getPartnerByName(name) {
    return ALL_PARTNERS.find(p => p.name === name);
  }

  // === POPULATE SELECTS ===
  function populateSelects() {
    const popularOptions = ALL_PARTNERS.filter(p => ['popular'].includes(p.category));
    const luxuryOptions = ALL_PARTNERS.filter(p => ['luxury', 'expedition'].includes(p.category));
    const allOptions = ALL_PARTNERS;

    popularOptions.forEach(p => {
      popularSelect.appendChild(new Option(p.short, p.name));
    });
    
    luxuryOptions.forEach(p => {
      luxurySelect.appendChild(new Option(p.short, p.name));
    });
    
    allOptions.forEach(p => {
      spotlightSelect.appendChild(new Option(p.short, p.name));
    });
  }

  function populateLastWeekChips() {
    lastWeekChipsDiv.innerHTML = '';
    ALL_PARTNERS.forEach(p => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip';
      chip.textContent = p.short;
      chip.dataset.partner = p.name;
      chip.addEventListener('click', () => toggleLastWeek(p.name, chip));
      lastWeekChipsDiv.appendChild(chip);
    });
  }

  function toggleLastWeek(name, chip) {
    const idx = state.lastWeekPartners.indexOf(name);
    if (idx > -1) {
      state.lastWeekPartners.splice(idx, 1);
      chip.classList.remove('active');
    } else {
      if (state.lastWeekPartners.length >= 4) return;
      state.lastWeekPartners.push(name);
      chip.classList.add('active');
    }
    lastWeekCountSpan.textContent = state.lastWeekPartners.length;
    saveState();
  }

  // === ACTIVE THIS WEEK ===
  function updateActiveThisWeekUI() {
    const potms = [];
    if (state.popularPotm) potms.push({ name: state.popularPotm, type: 'Popular POTM' });
    if (state.luxuryPotm) potms.push({ name: state.luxuryPotm, type: 'Luxury/River POTM' });
    state.spotlights.forEach(s => potms.push({ name: s, type: 'Spotlight' }));

    if (potms.length === 0) {
      activeThisWeekDiv.innerHTML = '<p class="help-text">Select your POTMs above first</p>';
      return;
    }

    activeThisWeekDiv.innerHTML = '<div class="chip-container"></div><p class="help-text" style="margin-top: 0.5rem;">Click partners that are active THIS week</p>';
    const container = activeThisWeekDiv.querySelector('.chip-container');

    potms.forEach(({ name, type }) => {
      const partner = getPartnerByName(name);
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip' + (state.activeThisWeek.includes(name) ? ' active' : '');
      chip.textContent = partner ? partner.short : name;
      chip.title = type;
      chip.addEventListener('click', () => {
        const idx = state.activeThisWeek.indexOf(name);
        if (idx > -1) {
          state.activeThisWeek.splice(idx, 1);
          chip.classList.remove('active');
        } else {
          state.activeThisWeek.push(name);
          chip.classList.add('active');
        }
        saveState();
      });
      container.appendChild(chip);
    });
  }

  // === SPOTLIGHTS ===
  function renderSpotlights() {
    activeSpotlightsDiv.innerHTML = '';
    state.spotlights.forEach(name => {
      const partner = getPartnerByName(name);
      const tag = document.createElement('span');
      tag.className = 'active-potm-tag';
      tag.innerHTML = `${escapeHtml(partner ? partner.short : name)} <span class="remove" data-name="${escapeHtml(name)}">Ã—</span>`;
      tag.querySelector('.remove').addEventListener('click', () => {
        state.spotlights = state.spotlights.filter(s => s !== name);
        state.activeThisWeek = state.activeThisWeek.filter(s => s !== name);
        renderSpotlights();
        updateActiveThisWeekUI();
        saveState();
      });
      activeSpotlightsDiv.appendChild(tag);
    });
  }

  // === COMPUTE LINEUP ===
  function computeLineup() {
    const lineup = [];
    const exclude = new Set([...state.lastWeekPartners]);

    // 1. Add all active-this-week POTMs/Spotlights (they MUST be included)
    state.activeThisWeek.forEach(name => {
      if (!lineup.includes(name)) {
        lineup.push(name);
      }
    });

    // 2. Fill remaining slots from priority tiers
    const slotsRemaining = () => 4 - lineup.length;

    for (const tier of PRIORITY_TIERS) {
      if (slotsRemaining() <= 0) break;
      for (const name of tier) {
        if (slotsRemaining() <= 0) break;
        if (!lineup.includes(name) && !exclude.has(name)) {
          lineup.push(name);
        }
      }
    }

    // 3. If still not 4, pull from any partner
    if (slotsRemaining() > 0) {
      for (const p of ALL_PARTNERS) {
        if (slotsRemaining() <= 0) break;
        if (!lineup.includes(p.name) && !exclude.has(p.name)) {
          lineup.push(p.name);
        }
      }
    }

    state.computedLineup = lineup.slice(0, 4);
    renderResults();
    saveState();
  }

  function renderResults() {
    if (state.computedLineup.length === 0) {
      resultsContainer.innerHTML = '<div class="results-empty">Complete steps above and click compute</div>';
      copySection.style.display = 'none';
      return;
    }

    const activeSet = new Set(state.activeThisWeek);
    const spotlightSet = new Set(state.spotlights);

    let html = '<ul class="results-list">';
    state.computedLineup.forEach(name => {
      const partner = getPartnerByName(name);
      const displayName = partner ? partner.short : name;
      
      let badge = '';
      if (name === state.popularPotm) {
        badge = '<span class="result-badge badge-potm">Popular POTM</span>';
      } else if (name === state.luxuryPotm) {
        badge = '<span class="result-badge badge-potm">Luxury POTM</span>';
      } else if (spotlightSet.has(name)) {
        badge = '<span class="result-badge badge-spotlight">Spotlight</span>';
      } else {
        badge = '<span class="result-badge badge-priority">Priority Fill</span>';
      }

      html += `<li>${badge}<span class="result-name">${escapeHtml(displayName)}</span></li>`;
    });
    html += '</ul>';

    resultsContainer.innerHTML = html;
    copySection.style.display = 'flex';
    
    // Update deal filtering if deals loaded
    if (state.deals.length > 0) {
      filterAndRenderDeals();
    }
  }

  // === COPY FUNCTIONS ===
  async function copyToClipboard(text, btn) {
    try {
      await navigator.clipboard.writeText(text);
      const original = btn.textContent;
      btn.textContent = 'Copied!';
      btn.classList.add('copied');
      setTimeout(() => {
        btn.textContent = original;
        btn.classList.remove('copied');
      }, 1500);
    } catch (e) {
      console.error('Copy failed', e);
    }
  }

  // === DEAL LISTER ===
  const SUPPLIER_ALIASES = {
    "ama waterways": "AmaWaterways", "amawaterways": "AmaWaterways",
    "disney cruises": "Disney Cruise Line", "viking cruises": "Viking Ocean Cruises",
    "viking ocean & expedition": "Viking Ocean Cruises", "windstar": "Windstar Cruises",
    "norwegian cruise line": "Norwegian Cruise Line", "royal caribbean": "Royal Caribbean",
    "celebrity cruises": "Celebrity Cruises", "disney cruise line": "Disney Cruise Line",
    "virgin voyages": "Virgin Voyages", "holland america line": "Holland America Line",
    "princess": "Princess Cruises", "princess cruises": "Princess Cruises",
    "carnival": "Carnival Cruise Line", "carnival cruise line": "Carnival Cruise Line",
    "msc cruises": "MSC Cruises", "viking": "Viking Ocean Cruises",
    "viking ocean cruises": "Viking Ocean Cruises", "seabourn": "Seabourn",
    "regent seven seas cruises": "Regent Seven Seas Cruises", "oceania cruises": "Oceania Cruises",
    "silversea": "Silversea", "explora journeys": "Explora Journeys", "azamara": "Azamara",
    "avalon waterways": "Avalon Waterways", "uniworld": "Uniworld Boutique River Cruises",
    "uniworld boutique river cruises": "Uniworld Boutique River Cruises",
    "scenic river": "Scenic River Cruises", "scenic luxury cruises & tours": "Scenic River Cruises",
    "scenic river cruises": "Scenic River Cruises", "scenic eclipse": "Scenic Eclipse",
    "scenic eclipse ocean voyages": "Scenic Eclipse", "crystal cruises": "Crystal Cruises",
    "cunard": "Cunard", "windstar cruises": "Windstar Cruises",
    "paul gauguin cruises": "Paul Gauguin Cruises", "ponant": "Ponant",
    "ritz-carlton yacht collection": "Ritz-Carlton Yacht Collection",
    "four seasons yachts": "Four Seasons Yachts", "lindblad expeditions": "Lindblad Expeditions",
    "lindblad expeditions & national geographic": "Lindblad Expeditions",
    "hurtigruten": "Hurtigruten", "uncruise adventures": "UnCruise Adventures",
    "atlas ocean voyages": "Atlas Ocean Voyages", "globus journeys": "Globus Journeys",
    "globus": "Globus Journeys", "trafalgar": "Trafalgar", "collette": "Collette",
    "cie tours": "CIE Tours", "g adventures": "G Adventures",
    "abercrombie & kent": "Abercrombie & Kent", "tauck cruises": "Tauck Cruises",
    "rocky mountaineer": "Rocky Mountaineer", "disneyworld": "DisneyWorld",
    "walt disney world": "DisneyWorld", "disneyland": "Disneyland",
    "aulani a disney resort & spa": "Aulani", "aulani": "Aulani",
    "adventures by disney": "Adventures by Disney", "sandals": "Sandals",
    "beaches": "Beaches Resorts", "beaches resorts": "Beaches Resorts",
    "club med": "Club Med", "atlantis paradise island": "Atlantis Paradise Island",
    "atlantis paradise island bahamas": "Atlantis Paradise Island", "atlantis": "Atlantis Paradise Island",
    "hard rock hotels": "Hard Rock Hotels", "hard rock hotel & casino": "Hard Rock Hotels",
    "excellence resorts": "Excellence Resorts", "secrets": "Secrets Resorts",
    "secrets resorts": "Secrets Resorts", "dreams": "Dreams Resorts",
    "dreams resorts": "Dreams Resorts", "breathless": "Breathless Resorts",
    "breathless resorts": "Breathless Resorts", "palace resorts": "Palace Resorts",
    "riu hotels & resorts": "RIU Hotels & Resorts", "iberostar hotels & resorts": "Iberostar Hotels & Resorts",
    "iberostar beachfront resorts": "Iberostar Hotels & Resorts",
    "delta vacations": "Delta Vacations", "american airlines vacations": "American Airlines Vacations",
    "american airline vacations": "American Airlines Vacations",
    "united vacations": "United Vacations", "southwest vacations": "Southwest Vacations",
    "viking river cruises": "Viking River Cruises"
  };

  function normalizeSupplier(name) {
    const key = (name || '').toLowerCase().trim().replace(/[.,\/#!$%\^&*;:{}=\-_`~()']/g, '').replace(/\s+/g, ' ').trim();
    return SUPPLIER_ALIASES[key] || name;
  }

  function formatDate(dStr) {
    if (!dStr) return '';
    if (['call for details', 'contact us', 'ongoing'].includes(String(dStr).toLowerCase().trim())) return 'Ongoing';
    try {
      const d = new Date(dStr);
      if (isNaN(d.getTime())) return '';
      return `Ends ${d.getMonth() + 1}/${d.getDate()}`;
    } catch {
      return '';
    }
  }

  function parseDeals(arr) {
    if (!Array.isArray(arr)) return [];
    const out = [];
    for (const deal of arr) {
      try {
        if (!deal || typeof deal !== 'object') continue;
        const { status, shopOverline, title, shopListing, dealCategory, expiryDate } = deal;
        if (!shopOverline || !title || !shopListing || status !== 'live') continue;

        const displayName = normalizeSupplier(shopOverline);
        const isExclusive = Array.isArray(dealCategory) && dealCategory.includes(39542);
        const formattedExpiry = formatDate(expiryDate);
        let expiryDateObj = null;
        if (formattedExpiry && formattedExpiry !== 'Ongoing') {
          const tmp = new Date(expiryDate);
          if (!isNaN(tmp.getTime())) expiryDateObj = tmp;
        }

        out.push({
          displayName,
          title: String(title),
          description: String(shopListing),
          exclusive: isExclusive,
          formattedExpiry,
          expiryDateObj,
          id: crypto.randomUUID()
        });
      } catch (e) {
        console.error('Error parsing deal:', e);
      }
    }
    return out;
  }

  function filterAndRenderDeals() {
    let filtered = [...state.deals];

    if (state.filterByRotator && state.computedLineup.length > 0) {
      const set = new Set(state.computedLineup);
      filtered = filtered.filter(d => set.has(d.displayName));
    }

    if (state.supplierFilter) {
      filtered = filtered.filter(d => d.displayName === state.supplierFilter);
    }

    if (state.filterExclusive) {
      filtered = filtered.filter(d => d.exclusive);
    }

    // Sort by supplier, then exclusive, then expiry
    const fallback = new Date('2099-12-31');
    filtered.sort((a, b) => {
      const cmp = a.displayName.localeCompare(b.displayName);
      if (cmp !== 0) return cmp;
      if (a.exclusive !== b.exclusive) return b.exclusive - a.exclusive;
      return (a.expiryDateObj || fallback) - (b.expiryDateObj || fallback);
    });

    state.filteredDeals = filtered;
    state.selectedDeals = [...filtered];
    renderDealList();
  }

  function renderDealList() {
    dealCountSpan.textContent = state.selectedDeals.length;
    
    if (state.selectedDeals.length === 0) {
      dealList.innerHTML = '<li class="placeholder">No deals match your filters</li>';
      return;
    }

    dealList.innerHTML = state.selectedDeals.map(d => `
      <li class="deal-item" data-id="${d.id}">
        <span class="deal-star">${d.exclusive ? 'â˜…' : ''}</span>
        <span class="deal-supplier">${escapeHtml(d.displayName)}</span>
        <button class="deal-remove" title="Remove">&times;</button>
        <div class="deal-title-row">
          <span class="deal-title">${escapeHtml(d.title)}</span>
          ${d.formattedExpiry ? `<span class="deal-expiry">${escapeHtml(d.formattedExpiry)}</span>` : ''}
        </div>
        <div class="deal-description">${escapeHtml(d.description)}</div>
      </li>
    `).join('');

    dealList.querySelectorAll('.deal-remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = e.target.closest('.deal-item').dataset.id;
        state.selectedDeals = state.selectedDeals.filter(d => d.id !== id);
        renderDealList();
      });
    });
  }

  function renderSupplierChips() {
    const suppliers = [...new Set(state.deals.map(d => d.displayName))].sort();
    supplierChipsDiv.innerHTML = '';
    
    const allChip = document.createElement('button');
    allChip.type = 'button';
    allChip.className = 'chip' + (!state.supplierFilter ? ' active' : '');
    allChip.textContent = 'All';
    allChip.addEventListener('click', () => {
      state.supplierFilter = null;
      filterAndRenderDeals();
      renderSupplierChips();
    });
    supplierChipsDiv.appendChild(allChip);

    suppliers.forEach(name => {
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'chip' + (state.supplierFilter === name ? ' active' : '');
      chip.textContent = name;
      chip.addEventListener('click', () => {
        state.supplierFilter = name;
        filterAndRenderDeals();
        renderSupplierChips();
      });
      supplierChipsDiv.appendChild(chip);
    });
  }

  function formatDealsForCopy(deals) {
    const bySupplier = {};
    deals.forEach(d => {
      if (!bySupplier[d.displayName]) bySupplier[d.displayName] = [];
      bySupplier[d.displayName].push(d);
    });

    const sortedSuppliers = Object.keys(bySupplier).sort();
    const fallback = new Date('2099-12-31');

    return sortedSuppliers.map(name => {
      const supplierDeals = bySupplier[name];
      supplierDeals.sort((a, b) => {
        if (a.exclusive !== b.exclusive) return b.exclusive - a.exclusive;
        return (a.expiryDateObj || fallback) - (b.expiryDateObj || fallback);
      });

      const dealLines = supplierDeals.map(d => {
        const prefix = d.exclusive && !d.title.toLowerCase().startsWith('exclusive:') ? 'EXCLUSIVE: ' : '';
        return `${prefix}${d.title}${d.formattedExpiry ? ` â€“ ${d.formattedExpiry}` : ''}`;
      }).join('\n');

      return `${name}\n${dealLines}`;
    }).join('\n\n');
  }

  // === PERSISTENCE ===
  function saveState() {
    try {
      localStorage.setItem('hotdeals_state', JSON.stringify({
        popularPotm: state.popularPotm,
        luxuryPotm: state.luxuryPotm,
        spotlights: state.spotlights,
        activeThisWeek: state.activeThisWeek,
        lastWeekPartners: state.lastWeekPartners,
        computedLineup: state.computedLineup
      }));
    } catch (e) {
      console.error('Save failed', e);
    }
  }

  function loadState() {
    try {
      const saved = localStorage.getItem('hotdeals_state');
      if (!saved) return;
      const data = JSON.parse(saved);
      
      if (data.popularPotm) {
        state.popularPotm = data.popularPotm;
        popularSelect.value = data.popularPotm;
      }
      if (data.luxuryPotm) {
        state.luxuryPotm = data.luxuryPotm;
        luxurySelect.value = data.luxuryPotm;
      }
      if (Array.isArray(data.spotlights)) {
        state.spotlights = data.spotlights;
        renderSpotlights();
      }
      if (Array.isArray(data.activeThisWeek)) {
        state.activeThisWeek = data.activeThisWeek;
      }
      if (Array.isArray(data.lastWeekPartners)) {
        state.lastWeekPartners = data.lastWeekPartners;
        lastWeekCountSpan.textContent = state.lastWeekPartners.length;
        $$('#lastweek-chips .chip').forEach(chip => {
          if (state.lastWeekPartners.includes(chip.dataset.partner)) {
            chip.classList.add('active');
          }
        });
      }
      if (Array.isArray(data.computedLineup)) {
        state.computedLineup = data.computedLineup;
        renderResults();
      }
      
      updateActiveThisWeekUI();
    } catch (e) {
      console.error('Load failed', e);
    }
  }

  // === EVENT HANDLERS ===
  function init() {
    populateSelects();
    populateLastWeekChips();

    popularSelect.addEventListener('change', () => {
      state.popularPotm = popularSelect.value;
      // Auto-add to active this week if not already
      if (state.popularPotm && !state.activeThisWeek.includes(state.popularPotm)) {
        state.activeThisWeek.push(state.popularPotm);
      }
      updateActiveThisWeekUI();
      saveState();
    });

    luxurySelect.addEventListener('change', () => {
      state.luxuryPotm = luxurySelect.value;
      if (state.luxuryPotm && !state.activeThisWeek.includes(state.luxuryPotm)) {
        state.activeThisWeek.push(state.luxuryPotm);
      }
      updateActiveThisWeekUI();
      saveState();
    });

    spotlightSelect.addEventListener('change', () => {
      const val = spotlightSelect.value;
      if (val && !state.spotlights.includes(val)) {
        state.spotlights.push(val);
        state.activeThisWeek.push(val);
        renderSpotlights();
        updateActiveThisWeekUI();
        saveState();
      }
      spotlightSelect.value = '';
    });

    computeBtn.addEventListener('click', () => {
      if (state.activeThisWeek.length === 0) {
        alert('Please select at least one POTM or Spotlight as active this week');
        return;
      }
      computeLineup();
    });

    copyNamesBtn.addEventListener('click', () => {
      const names = state.computedLineup.join('\n');
      copyToClipboard(names, copyNamesBtn);
    });

    jsonFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      uploadArea.querySelector('.upload-text').innerHTML = `<span class="file-name">${escapeHtml(file.name)}</span>`;
      uploadArea.classList.add('has-file');

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const data = JSON.parse(evt.target.result);
          state.deals = parseDeals(data);
          state.filteredDeals = [...state.deals];
          state.selectedDeals = [...state.deals];
          
          dealFilters.style.display = 'block';
          dealListContainer.style.display = 'block';
          
          renderSupplierChips();
          filterAndRenderDeals();
        } catch (err) {
          alert('Invalid JSON file');
          console.error(err);
        }
      };
      reader.readAsText(file);
    });

    filterRotatorCheck.addEventListener('change', () => {
      state.filterByRotator = filterRotatorCheck.checked;
      filterAndRenderDeals();
    });

    filterExclusiveCheck.addEventListener('change', () => {
      state.filterExclusive = filterExclusiveCheck.checked;
      filterAndRenderDeals();
    });

    copyDealsBtn.addEventListener('click', () => {
      if (state.selectedDeals.length === 0) return;
      copyToClipboard(formatDealsForCopy(state.selectedDeals), copyDealsBtn);
    });

    loadState();
  }

  document.addEventListener('DOMContentLoaded', init);
})();
  </script>
</body>
</html>